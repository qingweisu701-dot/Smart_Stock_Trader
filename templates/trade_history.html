{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å†å²å›æµ‹è®°å½• | æ™ºèƒ½è‚¡ç¥¨ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <style>
        /* å…¨å±€é‡ç½® */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background-color: #f0f2f5; }

        /* å¸ƒå±€æ ·å¼ */
        .el-aside { background-color: #001529; color: white; height: 100vh; transition: width 0.3s; }
        .logo-area { height: 60px; line-height: 60px; text-align: center; font-size: 20px; font-weight: bold; background: #002140; color: white; overflow: hidden;}
        .el-header { background-color: #fff; box-shadow: 0 1px 4px rgba(0,21,41,.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }

        /* å†…å®¹åŒº */
        .main-card { margin-bottom: 20px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="app">
        <el-container>
            <el-aside width="220px">
                <div class="logo-area">ğŸ¤– æ™ºèƒ½å†³ç­–ç³»ç»Ÿ</div>
                <el-menu
                    active-text-color="#409EFF"
                    background-color="#001529"
                    text-color="#fff"
                    default-active="2-2">

                    <el-menu-item index="1" @click="goUrl('/api/chart/')">
                        <i class="el-icon-s-home"></i>
                        <span>ç³»ç»Ÿé¦–é¡µ</span>
                    </el-menu-item>

                    <el-sub-menu index="2">
                        <template #title>
                            <span>æ¨¡å¼åŒ¹é…åˆ†æ</span>
                        </template>
                        <el-menu-item index="2-1" @click="goUrl('/api/chart/')">ç‰¹å®šèµ°åŠ¿ç­›é€‰</el-menu-item>
                        <el-menu-item index="2-2">å†å²å›æµ‹è®°å½•</el-menu-item>
                    </el-sub-menu>

                    <el-menu-item index="3" @click="goUrl('/api/prediction/')">
                        <span>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ</span>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header>
                    <div class="breadcrumb">
                        <el-breadcrumb separator="/">
                            <el-breadcrumb-item>é¦–é¡µ</el-breadcrumb-item>
                            <el-breadcrumb-item>æ¨¡å¼åŒ¹é…åˆ†æ</el-breadcrumb-item>
                            <el-breadcrumb-item>å†å²å›æµ‹è®°å½•</el-breadcrumb-item>
                        </el-breadcrumb>
                    </div>
                    <div class="user-info">
                        <el-avatar size="small" style="background-color: #409EFF">User</el-avatar>
                    </div>
                </el-header>

                <el-main>
                    <el-card class="main-card" shadow="hover">
                        <div slot="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <span style="font-weight: bold; font-size: 16px;">ğŸ“œ æ¨¡æ‹Ÿäº¤æ˜“æµæ°´</span>
                            <el-button type="primary" icon="Refresh" circle @click="loadData" plain></el-button>
                        </div>

                        <el-table :data="tableData" stripe style="width: 100%" v-loading="loading" border>
                            <el-table-column prop="time" label="æ“ä½œæ—¶é—´" width="180"></el-table-column>

                            <el-table-column prop="code" label="è‚¡ç¥¨ä»£ç " width="120">
                                <template #default="scope">
                                    <el-tag effect="dark">[[ scope.row.code ]]</el-tag>
                                </template>
                            </el-table-column>

                            <el-table-column prop="type" label="äº¤æ˜“æ–¹å‘" width="100">
                                <template #default="scope">
                                    <el-tag :type="scope.row.type === 'BUY' ? 'danger' : 'success'" effect="dark">
                                        [[ scope.row.type === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º' ]]
                                    </el-tag>
                                </template>
                            </el-table-column>

                            <el-table-column prop="price" label="æˆäº¤å‡ä»·">
                                <template #default="scope">
                                    <span style="font-weight: bold;">Â¥ [[ scope.row.price ]]</span>
                                </template>
                            </el-table-column>

                            <el-table-column prop="volume" label="æˆäº¤é‡" width="120">
                                <template #default="scope">[[ scope.row.volume ]] æ‰‹</template>
                            </el-table-column>

                            <el-table-column prop="strategy" label="è§¦å‘ç­–ç•¥/ä¿¡å·" min-width="150">
                                <template #default="scope">
                                    <el-tag effect="plain" type="info">[[ scope.row.strategy ]]</el-tag>
                                </template>
                            </el-table-column>

                            <el-table-column label="çŠ¶æ€">
                                <template #default="scope">
                                    <el-tag type="success" size="small">æˆäº¤</el-tag>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </el-main>
            </el-container>
        </el-container>
    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            // é¿å… Django æ¨¡æ¿å†²çª
            delimiters: ['[[', ']]'],
            setup() {
                const tableData = ref([]);
                const loading = ref(false);

                // åŠ è½½æ•°æ®
                const loadData = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get('/api/history/data/');
                        if (res.data.code === 200) {
                            tableData.value = res.data.data;
                            ElementPlus.ElMessage.success('è®°å½•å·²åˆ·æ–°');
                        } else {
                            ElementPlus.ElMessage.error(res.data.msg);
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('æ— æ³•è¿æ¥æœåŠ¡å™¨');
                    } finally {
                        loading.value = false;
                    }
                };

                // é¡µé¢è·³è½¬å‡½æ•°
                const goUrl = (url) => {
                    window.location.href = url;
                };

                onMounted(() => {
                    loadData();
                });

                return { tableData, loading, loadData, goUrl };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.mount('#app');
    </script>
</body>
</html>