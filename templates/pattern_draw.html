{% extends 'base.html' %}
{% block title %}è¶‹åŠ¿æ‰‹ç»˜å®éªŒå®¤{% endblock %}
{% block content %}
<el-row :gutter="20" style="height: calc(100vh - 120px);">
    <el-col :span="16" style="height:100%">
        <el-card style="height:100%; display:flex; flex-direction:column">
            <template #header>
                <div style="display:flex; justify-content:space-between">
                    <span>ğŸ–Œï¸ å®è§‚è¶‹åŠ¿æ‰‹ç»˜</span>
                    <div>
                        <el-button type="danger" icon="Delete" plain @click="clearDraw">æ¸…ç©º</el-button>
                        <el-button type="primary" icon="Check" @click="prepareSave">ä¿å­˜å½¢æ€</el-button>
                    </div>
                </div>
            </template>
            <div style="flex:1; border:1px dashed #ccc; cursor:crosshair" id="draw-canvas"></div>
            <div style="text-align:center; color:#999; margin-top:10px">ğŸ’¡ æŒ‰ä½å·¦é”®ç»˜åˆ¶ï¼Œæ¾å¼€æš‚å­˜ï¼Œå¯å¤šç¬”ç»˜åˆ¶</div>
        </el-card>
    </el-col>

    <el-col :span="8" style="height:100%">
        <el-card header="ğŸ“š å½¢æ€åº“" style="height:100%; overflow-y:auto">
            <div v-for="p in presets" class="p-item" @click="loadP(p)">
                <el-tag size="small" :type="p.type==='BUY'?'danger':'success'">[[p.type]]</el-tag> <b>[[p.name]]</b>
            </div>
            <div style="border-top:1px solid #eee; margin:10px 0"></div>
            <div v-for="p in users" class="p-item" @click="loadP(p)">
                <el-tag size="small" type="info">è‡ª</el-tag> [[p.name]]
            </div>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="æ™ºèƒ½ä¿å­˜" width="30%">
    <div v-if="aiTrend" :class="aiTrend==='BUY'?'ai-box-buy':'ai-box-sell'">AIè¯†åˆ«ï¼š[[aiTrend]]</div>
    <el-form style="margin-top:15px">
        <el-form-item label="åç§°"><el-input v-model="saveDialog.name"/></el-form-item>
        <el-form-item label="ç±»å‹">
            <el-radio-group v-model="saveDialog.desc">
                <el-radio label="BUY">ä¹°å…¥</el-radio><el-radio label="SELL">å–å‡º</el-radio>
            </el-radio-group>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="doSave">ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>.p-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer } .p-item:hover{background:#f5f7fa} .ai-box-buy{color:green;background:#eaffea;padding:10px} .ai-box-sell{color:red;background:#ffeaea;padding:10px}</style>
<script>
function pageSetup() {
    const presets = ref([]); const users = ref([]);
    const saveDialog = ref({visible:false, name:'', desc:'BUY'});
    const aiTrend = ref('');
    let drawChart=null, drawPoints=[], isDrawing=false;

    const init = () => {
        drawChart = echarts.init(document.getElementById('draw-canvas'));
        drawChart.getZr().on('mousedown', ()=>{isDrawing=true});
        drawChart.getZr().on('mousemove', e=>{
            if(!isDrawing) return;
            const pt = drawChart.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]);
            if(pt) { drawPoints.push(pt[1]); render(); }
        });
        drawChart.getZr().on('mouseup', ()=>{isDrawing=false});
        render();
        loadList();
    };
    const render = () => {
        drawChart.setOption({
            grid:{top:10,bottom:10}, xAxis:{show:false, data:drawPoints.map((_,i)=>i)}, yAxis:{min:0,max:100,show:false},
            series:[{type:'line', data:drawPoints, smooth:0.3, showSymbol:false, lineStyle:{width:3, color:'#409EFF'}}]
        });
    };
    const loadList = async () => {
        const res = await axios.get('/api/pattern/list/');
        presets.value = res.data.data.presets;
        users.value = res.data.data.users.filter(u => !u.data[0].open); // è¿‡æ»¤æ‰Kçº¿æ•°æ®
    };
    const loadP = (p) => {
        if(typeof p.data[0] === 'object') return ElementPlus.ElMessage.warning('è¿™æ˜¯Kçº¿æ•°æ®ï¼Œè¯·å»Kçº¿ç²¾è°ƒé¡µé¢');
        drawPoints = p.data; render();
    };
    const clearDraw = () => { drawPoints=[]; render(); };
    const prepareSave = async () => {
        if(drawPoints.length<5) return ElementPlus.ElMessage.warning('å¤ªçŸ­äº†');
        const res = await axios.post('/api/pattern/analyze/', {type:'DRAW', data:drawPoints});
        aiTrend.value = res.data.data.trend;
        saveDialog.value.desc = aiTrend.value==='SELL'?'SELL':'BUY';
        saveDialog.value.visible = true;
    };
    const doSave = async () => {
        await axios.post('/api/pattern/save/', {name:saveDialog.value.name, desc:saveDialog.value.desc, type:'DRAW', data:drawPoints});
        saveDialog.value.visible = false; loadList();
    };
    onMounted(()=>setTimeout(init, 200));
    return { presets, users, saveDialog, aiTrend, clearDraw, loadP, prepareSave, doSave };
}
</script>
{% endblock %}