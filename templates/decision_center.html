{% extends 'base.html' %}
{% block title %}ÈáèÂåñÂÜ≥Á≠ñ‰∏≠ÂøÉ{% endblock %}

{% block content %}
<el-container style="height:85vh; padding:20px; background:#f0f2f5; display:flex; flex-direction:column">
    <el-card shadow="never" style="margin-bottom:20px">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <span style="font-size:18px; font-weight:bold; margin-right:10px">üß† Êô∫ËÉΩÂÜ≥Á≠ñ‰∏≠ÂøÉ (AI Decision)</span>
                <el-tag type="success">ÂÆûÊó∂ÁõëÊéß‰∏≠</el-tag>
            </div>
            <div style="display:flex; gap:10px">
                <el-button type="primary" @click="loadOpportunities" :loading="loading" icon="Refresh">Âà∑Êñ∞Êú∫‰ºöÊ±†</el-button>
                <el-button type="info" plain @click="goHistory" icon="List">Êü•Áúã‰∫§ÊòìÊµÅÊ∞¥</el-button>
            </div>
        </div>
    </el-card>

    <el-card shadow="never" style="flex:1; overflow-y:auto">
        <template #header>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span>üî• Êú∫‰ºöÊ±† (Smart Pool)</span>
                <div style="display:flex; align-items:center; gap:10px">
                    <span style="font-size:12px">ÊúÄ‰ΩéÁΩÆ‰ø°Â∫¶:</span>
                    <el-input v-model="filters.minScore" type="number" :min="0" placeholder="60" size="small"
                        style="width:100px" oninput="value=value.replace(/[^\d]/g,'')">
                        <template #suffix>%</template>
                    </el-input>
                    <el-select v-model="filters.patternId" placeholder="Á≠õÈÄâÂΩ¢ÊÄÅ" size="small" clearable
                        style="width:140px">
                        <el-option-group label="Á≥ªÁªüÈ¢ÑËÆæ">
                            <el-option v-for="p in presets.sys" :key="p.id" :label="p.name"
                                :value="'PRESET:'+p.id"></el-option>
                        </el-option-group>
                        <el-option-group label="Ëá™ÂÆö‰πâ">
                            <el-option v-for="p in presets.user" :key="p.id" :label="p.name"
                                :value="'USER:'+p.id"></el-option>
                        </el-option-group>
                    </el-select>
                </div>
            </div>
        </template>

        <el-table :data="opportunities" stripe border style="width: 100%" @row-click="showDetail">
            <el-table-column prop="code" label="Ê†áÁöÑ‰ª£Á†Å" width="120" sortable>
                <template #default="scope">
                    <b style="color:#409EFF; cursor:pointer">[[ scope.row.code ]]</b>
                </template>
            </el-table-column>

            <el-table-column prop="name" label="ÂêçÁß∞" width="120"></el-table-column>

            <el-table-column label="Áé∞‰ª∑" width="120">
                <template #default="scope">
                    <span style="font-weight:bold">[[ scope.row.price ]]</span>
                </template>
            </el-table-column>

            <el-table-column label="Ëß¶Âèë‰ø°Âè∑" width="150">
                <template #default="scope">
                    <el-tag effect="light" :type="scope.row.match_type==='BUY'?'danger':'success'"
                        style="font-weight:bold">
                        [[ scope.row.reason || (scope.row.match_type==='BUY'?'ÁªºÂêàÊú∫‰ºö':'È£éÈô©È¢ÑË≠¶') ]]
                    </el-tag>
                </template>
            </el-table-column>

            <el-table-column label="AI Âª∫ËÆÆ" width="200">
                <template #default="scope">
                    <div style="font-size:12px">
                        <span style="color:#F56C6C">Âª∫ËÆÆ‰π∞ÂÖ•: [[ scope.row.buy_point ]]</span><br>
                        <span style="color:#67C23A">Âª∫ËÆÆÂçñÂá∫: [[ scope.row.sell_point ]]</span>
                    </div>
                </template>
            </el-table-column>

            <el-table-column label="ÊåÅ‰ªìÂë®Êúü" width="120" prop="holding_period"></el-table-column>

            <el-table-column label="ÁΩÆ‰ø°Â∫¶" width="150">
                <template #default="scope">
                    <el-progress :percentage="scope.row.confidence"
                        :color="scope.row.confidence>80?'#F56C6C':'#E6A23C'"></el-progress>
                </template>
            </el-table-column>

            <el-table-column label="ÂÜ≥Á≠ñÊìç‰Ωú" width="200" fixed="right">
                <template #default="scope">
                    <el-button-group>
                        <el-button size="small" type="primary" @click.stop="showDetail(scope.row)">Ë∂ãÂäøÂõæ</el-button>
                        <el-button size="small" type="danger" @click.stop="openTrade(scope.row, 'BUY')">‰π∞ÂÖ•</el-button>
                        <el-button size="small" type="success" @click.stop="openTrade(scope.row, 'SELL')">ÂçñÂá∫</el-button>
                    </el-button-group>
                </template>
            </el-table-column>
        </el-table>
    </el-card>
</el-container>

<el-dialog v-model="detailVisible" width="85%" title="Ê∑±Â∫¶Ëµ∞ÂäøÂàÜÊûê" @opened="renderChart">
    <div style="text-align:right; margin-bottom:5px">
        <el-radio-group v-model="currIndicator" size="small" @change="renderChart">
            <el-radio-button label="MACD">MACD</el-radio-button>
            <el-radio-button label="KDJ">KDJ</el-radio-button>
            <el-radio-button label="RSI">RSI</el-radio-button>
        </el-radio-group>
    </div>
    <div id="decision-kline" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" :title="(trade.type === 'BUY' ? 'üî¥ ‰π∞ÂÖ•ÂßîÊâò' : 'üü¢ ÂçñÂá∫ÂßîÊâò') + ' - ' + trade.name"
    width="40%">
    <el-tabs v-model="trade.tab" type="card">
        <!-- 1. Âü∫Á°ÄÊù°‰ª∂ -->
        <el-tab-pane label="Âü∫Á°Ä‰∫§Êòì" name="basic">
            <el-form label-position="top">
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="‰ª∑Ê†ºÁ±ªÂûã">
                            <el-select v-model="trade.priceType" style="width:100%" @change="onPriceTypeChange">
                                <el-option label="Èôê‰ª∑ÂßîÊâò" value="LIMIT"></el-option>
                                <el-option label="Âçñ‰∏Ä‰ª∑Âø´ÈÄüÊàê‰∫§" value="ASK1"></el-option>
                                <el-option label="ÊúÄÊñ∞‰ª∑" value="LATEST"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="ÂßîÊâò‰ª∑Ê†º">
                            <el-input v-model="trade.price" type="number"
                                :disabled="trade.priceType!=='LIMIT'"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-form-item label="Êó∂Èó¥/‰ª∑Ê†ºËß¶Âèë (ÈÄâÂ°´)">
                    <el-select v-model="trade.triggerValue" placeholder="Á´ãÂç≥Êàê‰∫§ (ÈªòËÆ§)" style="width:100%" clearable>
                        <el-option label="Á´ãÂç≥Êàê‰∫§ (Â∏Ç‰ª∑)" value="IMMEDIATE"></el-option>
                        <el-option label="‰ª∑Ê†º >= ÊåáÊ†á‰ª∑" value="GE_PRICE"></el-option>
                        <el-option label="‰ª∑Ê†º <= ÊåáÊ†á‰ª∑" value="LE_PRICE"></el-option>
                        <el-option label="MA5 ÈáëÂèâ MA20" value="CROSS_UP_MA"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
        </el-tab-pane>

        <!-- 2. ÁΩëÊ†º‰∫§Êòì -->
        <el-tab-pane label="ÁΩëÊ†ºÁ≠ñÁï•" name="grid">
            <el-alert title="Âú®ÈúáËç°Âå∫Èó¥ÂÜÖËá™Âä®È´òÊäõ‰ΩéÂê∏" type="success" :closable="false" style="margin-bottom:10px"></el-alert>
            <el-form label-width="100px">
                <el-form-item label="ÁΩëÊ†º‰∏≠Êû¢‰ª∑"><el-input v-model="trade.gridBase" type="number"
                        placeholder="‰æãÂ¶Ç 10.00"></el-input></el-form-item>
                <el-row :gutter="10">
                    <el-col :span="12"><el-form-item label="‰∏äÊ∂®ÂçñÂá∫%"><el-input v-model="trade.gridUp" type="number"
                                placeholder="3.0"></el-input></el-form-item></el-col>
                    <el-col :span="12"><el-form-item label="‰∏ãË∑å‰π∞ÂÖ•%"><el-input v-model="trade.gridDown" type="number"
                                placeholder="3.0"></el-input></el-form-item></el-col>
                </el-row>
                <el-form-item label="ÂçïÁΩëÊ†ºÊï∞Èáè"><el-input v-model="trade.gridVol" type="number"
                        step="100"></el-input></el-form-item>
            </el-form>
        </el-tab-pane>

        <!-- 3. È´òÁ∫ßÈ£éÊéß -->
        <el-tab-pane label="È´òÁ∫ßÈ£éÊéß" name="risk">
            <el-form label-position="top">
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="Ê≠¢ÁõàÊù°‰ª∂">
                            <el-select v-model="trade.profitType" style="width:100%">
                                <el-option label="‰∏çËÆæÁΩÆ" value="NONE"></el-option>
                                <el-option label="Âõ∫ÂÆö‰ª∑Ê†ºÊ≠¢Áõà" value="FIXED"></el-option>
                                <el-option label="ÂõûÊí§Ê≠¢Áõà (Trailing)" value="TRAILING"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="Ê≠¢ÁõàÈòàÂÄº">
                            <el-input v-model="trade.profitVal" placeholder="‰æãÂ¶Ç: 22.5 Êàñ 5%"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="Ê≠¢ÊçüÊù°‰ª∂">
                            <el-select v-model="trade.lossType" style="width:100%">
                                <el-option label="‰∏çËÆæÁΩÆ" value="NONE"></el-option>
                                <el-option label="Âõ∫ÂÆö‰ª∑Ê†ºÊ≠¢Êçü" value="FIXED"></el-option>
                                <el-option label="ÁôæÂàÜÊØîÊ≠¢Êçü" value="PERCENT"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="Ê≠¢ÊçüÈòàÂÄº">
                            <el-input v-model="trade.lossVal" placeholder="‰æãÂ¶Ç: 18.0 Êàñ -5%"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>
            </el-form>
        </el-tab-pane>
    </el-tabs>

    <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px">
        <el-row :gutter="20">
            <el-col :span="14">
                <div style="font-size:12px;color:#666;margin-bottom:5px">ÂßîÊâòÊï∞Èáè (ËÇ°):</div>
                <el-input v-model="trade.volume" type="number" step="100">
                    <template #append>ËÇ°</template>
                </el-input>
                <div style="margin-top:5px">
                    <el-button size="small" @click="trade.volume=1000">10Êâã</el-button>
                    <el-button size="small" @click="trade.volume=trade.maxVol/2">1/2‰ªì</el-button>
                    <el-button size="small" @click="trade.volume=trade.maxVol">ÂÖ®‰ªì</el-button>
                </div>
            </el-col>
            <el-col :span="10" style="text-align:right; display:flex; flex-direction:column; justify-content:flex-end">
                <div style="font-size:16px; font-weight:bold; color:#F56C6C">¬• [[ (trade.price *
                    trade.volume).toFixed(2) ]]</div>
                <div style="font-size:12px; color:#999">È¢Ñ‰º∞ÈáëÈ¢ù</div>
            </el-col>
        </el-row>
    </div>

    <template #footer>
        <el-button @click="trade.visible=false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="submitTrade">Êèê‰∫§ÂßîÊâò</el-button>
    </template>
</el-dialog>
{% endblock %}

{% block scripts %}
<script>
    function pageSetup() {
        const { ref, onMounted } = Vue;
        const loading = ref(false);
        const opportunities = ref([]);

        // ÂõæË°®Áõ∏ÂÖ≥
        const detailVisible = ref(false);
        const currCode = ref('');
        const currIndicator = ref('MACD');
        let chart = null;

        // ‰∫§ÊòìÁõ∏ÂÖ≥


        // 1. Âä†ËΩΩÊú∫‰ºöÊ±† (Â§çÁî® Analysis Êé•Âè£Ëé∑ÂèñÈ´òË¥®ÈáèÂΩ¢ÊÄÅ)
        const filters = ref({ minScore: 70, patternId: '' });
        const presets = ref({ sys: [], user: [] });

        // ÂàùÂßãÂåñÔºöÂä†ËΩΩÂΩ¢ÊÄÅÂàóË°®
        const init = async () => {
            try {
                const res = await axios.get('/api/pattern/list/');
                presets.value.sys = res.data.data.presets;
                presets.value.user = res.data.data.users;
            } catch (e) { }
        };

        const loadOpportunities = async () => {
            loading.value = true;
            try {
                let pData = null;
                let pName = '';
                // üî• ‰øÆÂ§çÔºöÊ†πÊçÆÈÄâÊã©ÁöÑ patternId Êü•ÊâæÂØπÂ∫îÁöÑÂΩ¢ÊÄÅÊï∞ÊçÆ
                if (filters.value.patternId) {
                    const [type, id] = filters.value.patternId.split(':');
                    const list = type === 'PRESET' ? presets.value.sys : presets.value.user;
                    const found = list.find(x => x.id == id); // Ê≥®ÊÑèÁ±ªÂûãÂèØËÉΩ‰∏ç‰∏ÄËá¥ÔºåÁî®==
                    if (found) {
                        pData = found.data;
                        pName = found.name;
                    }
                }

                const res = await axios.post('/api/analysis/run/', {
                    pattern_data: pData,
                    pattern_name: pName,
                    filters: filters.value
                });
                if (res.data.code === 200) {
                    opportunities.value = res.data.data;
                    // ElementPlus.ElMessage.success(`Âà∑Êñ∞ÊàêÂäüÔºåÂèëÁé∞ ${res.data.data.length} ‰∏™Êú∫‰ºö`);
                    if (opportunities.value.length === 0) ElementPlus.ElMessage.warning('ÊöÇÊó†Á¨¶ÂêàÊù°‰ª∂ÁöÑÊú∫‰ºöÔºåËØ∑Ë∞ÉÊï¥ÈòàÂÄº');
                }
            } catch (e) { ElementPlus.ElMessage.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•'); }
            finally { loading.value = false; }
        };

        // 2. ÊòæÁ§∫ÂõæË°® (‰∏âÁ™óËÅîÂä®)
        const showDetail = (row) => {
            currCode.value = row.code;
            detailVisible.value = true;
        };

        const renderChart = async () => {
            if (chart) chart.dispose();
            const res = await axios.get(`/api/stock/detail/?code=${currCode.value}`);
            if (res.data.code !== 200) return ElementPlus.ElMessage.error('ÊöÇÊó†Êï∞ÊçÆ');

            const d = res.data.data;
            const ind = d.indicators;
            chart = echarts.init(document.getElementById('decision-kline'));

            let indSeries = [];
            if (currIndicator.value === 'MACD') {
                indSeries = [{ name: 'MACD', type: 'bar', xAxisIndex: 2, yAxisIndex: 2, data: ind.MACD, itemStyle: { color: p => p.value > 0 ? '#ef232a' : '#14b143' } }, { name: 'DIF', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DIF, symbol: 'none' }, { name: 'DEA', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DEA, symbol: 'none' }];
            } else if (currIndicator.value === 'KDJ') {
                indSeries = [{ name: 'K', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.K, symbol: 'none' }, { name: 'D', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.D, symbol: 'none' }, { name: 'J', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.J, symbol: 'none' }];
            } else {
                indSeries = [{ name: 'RSI', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.RSI, symbol: 'none' }];
            }

            chart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                legend: { top: 0, data: ['KÁ∫ø', 'MA5', 'MA20', 'Êàê‰∫§Èáè', currIndicator.value] },
                grid: [{ left: '5%', right: '5%', height: '45%' }, { left: '5%', right: '5%', top: '58%', height: '15%' }, { left: '5%', right: '5%', top: '78%', height: '15%' }],
                xAxis: [{ type: 'category', data: d.dates, scale: true, boundaryGap: false, axisLine: { onZero: false } }, { type: 'category', gridIndex: 1, data: d.dates, show: false }, { type: 'category', gridIndex: 2, data: d.dates, show: false }],
                yAxis: [{ scale: true, splitArea: { show: true } }, { gridIndex: 1, splitNumber: 2, axisLabel: { show: false } }, { gridIndex: 2, splitNumber: 2, axisLabel: { show: false } }],
                dataZoom: [{ type: 'inside', xAxisIndex: [0, 1, 2], start: 60, end: 100 }, { type: 'slider', xAxisIndex: [0, 1, 2], bottom: 0 }],
                series: [
                    { name: 'KÁ∫ø', type: 'candlestick', data: d.values.map(v => [v[0], v[1], v[2], v[3]]), itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' } },
                    { name: 'MA5', type: 'line', data: ind.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'MA20', type: 'line', data: ind.MA20, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'Êàê‰∫§Èáè', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: d.values.map(v => v[4]), itemStyle: { color: p => d.values[p.dataIndex][1] > d.values[p.dataIndex][0] ? '#ef232a' : '#14b143' } },
                    ...indSeries
                ]
            });
        };

        // ‰∫§ÊòìÁõ∏ÂÖ≥
        const trade = ref({
            visible: false, type: 'BUY', code: '', name: '', price: 0, volume: 100,
            triggerValue: 'IMMEDIATE', tab: 'basic', priceType: 'LIMIT', maxVol: 5000, // Simulated Max
            gridBase: '', gridUp: 3.0, gridDown: 3.0, gridVol: 100,
            profitType: 'NONE', profitVal: '', lossType: 'NONE', lossVal: ''
        });

        const onPriceTypeChange = () => {
            // Ê®°ÊãüËé∑ÂèñÊúÄÊñ∞‰ª∑
            if (trade.value.priceType === 'LATEST') trade.value.price = 20.50; // Mock
            else if (trade.value.priceType === 'ASK1') trade.value.price = 20.55;
        };

        const openTrade = (row, type) => {
            trade.value.visible = true;
            trade.value.type = type;
            trade.value.code = row.code;
            trade.value.name = row.name;
            trade.value.price = row.price;
            trade.value.volume = 100;
            trade.value.triggerValue = 'IMMEDIATE';
            trade.value.tab = 'basic'; // Reset to basic tab
            trade.value.gridBase = row.price;
        };

        // 4. Êèê‰∫§‰∫§Êòì
        const submitTrade = async () => {
            try {
                await axios.post('/api/trade/order/', trade.value);
                ElementPlus.ElMessage.success('ÂßîÊâòÂ∑≤Êèê‰∫§ÔºåËØ∑Âú®‰∫§ÊòìÊµÅÊ∞¥‰∏≠Êü•Áúã');
                trade.value.visible = false;
            } catch (e) {
                ElementPlus.ElMessage.error('‰∫§ÊòìÂ§±Ë¥•');
            }
        };

        const goHistory = () => window.location.href = '/api/trade/history/';

        onMounted(() => {
            init();
            loadOpportunities();
        });

        return { loading, opportunities, detailVisible, currCode, currIndicator, trade, loadOpportunities, showDetail, renderChart, openTrade, submitTrade, goHistory, filters, presets, onPriceTypeChange };
    }
</script>
{% endblock %}