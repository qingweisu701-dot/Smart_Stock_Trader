{% extends 'base.html' %}
{% block title %}é‡åŒ–å†³ç­–ä¸­å¿ƒ{% endblock %}

{% block content %}
<el-container style="height:85vh; padding:20px; background:#f0f2f5; display:flex; flex-direction:column">
    <el-card shadow="never" style="margin-bottom:20px">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <span style="font-size:18px; font-weight:bold; margin-right:10px">ğŸ§  æ™ºèƒ½å†³ç­–ä¸­å¿ƒ (AI Decision)</span>
                <el-tag type="success">å®æ—¶ç›‘æ§ä¸­</el-tag>
            </div>
            <div style="display:flex; gap:10px">
                <el-button type="primary" @click="loadOpportunities" :loading="loading" icon="Refresh">åˆ·æ–°æœºä¼šæ± </el-button>
                <el-button type="info" plain @click="goHistory" icon="List">æŸ¥çœ‹äº¤æ˜“æµæ°´</el-button>
            </div>
        </div>
    </el-card>

    <el-card shadow="never" style="flex:1; overflow-y:auto">
        <template #header>
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span>ğŸ”¥ æœºä¼šæ±  (Smart Pool)</span>
                <div style="display:flex; align-items:center; gap:10px">
                    <span style="font-size:12px">æœ€ä½ç½®ä¿¡åº¦:</span>
                    <el-input-number v-model="filters.minScore" :min="0" :max="100" size="small"
                        style="width:100px"></el-input-number>
                    <el-select v-model="filters.patternId" placeholder="ç­›é€‰å½¢æ€" size="small" clearable
                        style="width:140px">
                        <el-option-group label="ç³»ç»Ÿé¢„è®¾">
                            <el-option v-for="p in presets.sys" :key="p.id" :label="p.name"
                                :value="'PRESET:'+p.id"></el-option>
                        </el-option-group>
                        <el-option-group label="è‡ªå®šä¹‰">
                            <el-option v-for="p in presets.user" :key="p.id" :label="p.name"
                                :value="'USER:'+p.id"></el-option>
                        </el-option-group>
                    </el-select>
                </div>
            </div>
        </template>

        <el-table :data="opportunities" stripe border style="width: 100%" @row-click="showDetail">
            <el-table-column prop="code" label="æ ‡çš„ä»£ç " width="120" sortable>
                <template #default="scope">
                    <b style="color:#409EFF; cursor:pointer">[[ scope.row.code ]]</b>
                </template>
            </el-table-column>

            <el-table-column prop="name" label="åç§°" width="120"></el-table-column>

            <el-table-column label="ç°ä»·" width="120">
                <template #default="scope">
                    <span style="font-weight:bold">[[ scope.row.price ]]</span>
                </template>
            </el-table-column>

            <el-table-column label="è§¦å‘ä¿¡å·" width="150">
                <template #default="scope">
                    <el-tag effect="dark" :type="scope.row.match_type==='BUY'?'danger':'success'">
                        [[ scope.row.match_type==='BUY'?'æœºä¼š':'é£é™©' ]]
                    </el-tag>
                </template>
            </el-table-column>

            <el-table-column label="AI å»ºè®®" width="200">
                <template #default="scope">
                    <div style="font-size:12px">
                        <span style="color:#F56C6C">å»ºè®®ä¹°å…¥: [[ scope.row.buy_point ]]</span><br>
                        <span style="color:#67C23A">å»ºè®®å–å‡º: [[ scope.row.sell_point ]]</span>
                    </div>
                </template>
            </el-table-column>

            <el-table-column label="æŒä»“å‘¨æœŸ" width="120" prop="holding_period"></el-table-column>

            <el-table-column label="ç½®ä¿¡åº¦" width="150">
                <template #default="scope">
                    <el-progress :percentage="scope.row.confidence"
                        :color="scope.row.confidence>80?'#F56C6C':'#E6A23C'"></el-progress>
                </template>
            </el-table-column>

            <el-table-column label="å†³ç­–æ“ä½œ" width="200" fixed="right">
                <template #default="scope">
                    <el-button-group>
                        <el-button size="small" type="primary" @click.stop="showDetail(scope.row)">è¶‹åŠ¿å›¾</el-button>
                        <el-button size="small" type="danger" @click.stop="openTrade(scope.row, 'BUY')">ä¹°å…¥</el-button>
                        <el-button size="small" type="success" @click.stop="openTrade(scope.row, 'SELL')">å–å‡º</el-button>
                    </el-button-group>
                </template>
            </el-table-column>
        </el-table>
    </el-card>
</el-container>

<el-dialog v-model="detailVisible" width="85%" title="æ·±åº¦èµ°åŠ¿åˆ†æ" @opened="renderChart">
    <div style="text-align:right; margin-bottom:5px">
        <el-radio-group v-model="currIndicator" size="small" @change="renderChart">
            <el-radio-button label="MACD">MACD</el-radio-button>
            <el-radio-button label="KDJ">KDJ</el-radio-button>
            <el-radio-button label="RSI">RSI</el-radio-button>
        </el-radio-group>
    </div>
    <div id="decision-kline" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" :title="trade.type === 'BUY' ? 'ğŸ”´ ä¹°å…¥å§”æ‰˜' : 'ğŸŸ¢ å–å‡ºå§”æ‰˜'" width="30%">
    <el-form label-position="top">
        <el-alert title="äº¤æ˜“å°†ç›´æ¥è®°å½•åˆ°äº¤æ˜“æµæ°´ä¸­" type="info" :closable="false" style="margin-bottom:15px"></el-alert>

        <el-form-item label="æ ‡çš„">
            <el-tag size="large">[[ trade.name ]] ([[ trade.code ]])</el-tag>
        </el-form-item>

        <el-row :gutter="20">
            <el-col :span="12">
                <el-form-item label="å§”æ‰˜ä»·æ ¼">
                    <el-input v-model="trade.price" type="number"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="å§”æ‰˜æ•°é‡">
                    <el-input v-model="trade.volume" type="number" step="100"></el-input>
                </el-form-item>
            </el-col>
        </el-row>

        <el-form-item label="è§¦å‘æ¡ä»¶ (é€‰å¡«)">
            <el-input v-model="trade.triggerValue" placeholder="ä¾‹å¦‚ï¼šä»·æ ¼ >= 20.5"></el-input>
        </el-form-item>
    </el-form>

    <template #footer>
        <el-button @click="trade.visible=false">å–æ¶ˆ</el-button>
        <el-button :type="trade.type === 'BUY' ? 'danger' : 'success'" @click="submitTrade">ç¡®è®¤ä¸‹å•</el-button>
    </template>
</el-dialog>
{% endblock %}

{% block scripts %}
<script>
    function pageSetup() {
        const { ref, onMounted } = Vue;
        const loading = ref(false);
        const opportunities = ref([]);

        // å›¾è¡¨ç›¸å…³
        const detailVisible = ref(false);
        const currCode = ref('');
        const currIndicator = ref('MACD');
        let chart = null;

        // äº¤æ˜“ç›¸å…³
        const trade = ref({ visible: false, type: 'BUY', code: '', name: '', price: 0, volume: 100, triggerValue: '' });

        // 1. åŠ è½½æœºä¼šæ±  (å¤ç”¨ Analysis æ¥å£è·å–é«˜è´¨é‡å½¢æ€)
        const filters = ref({ minScore: 70, patternId: '' });
        const presets = ref({ sys: [], user: [] });

        // åˆå§‹åŒ–ï¼šåŠ è½½å½¢æ€åˆ—è¡¨
        const init = async () => {
            try {
                const res = await axios.get('/api/pattern/list/');
                presets.value.sys = res.data.data.presets;
                presets.value.user = res.data.data.users;
            } catch (e) { }
        };

        const loadOpportunities = async () => {
            loading.value = true;
            try {
                let pData = null;
                // ğŸ”¥ ä¿®å¤ï¼šæ ¹æ®é€‰æ‹©çš„ patternId æŸ¥æ‰¾å¯¹åº”çš„å½¢æ€æ•°æ®
                if (filters.value.patternId) {
                    const [type, id] = filters.value.patternId.split(':');
                    const list = type === 'PRESET' ? presets.value.sys : presets.value.user;
                    const found = list.find(x => x.id == id); // æ³¨æ„ç±»å‹å¯èƒ½ä¸ä¸€è‡´ï¼Œç”¨==
                    if (found) pData = found.data;
                }

                const res = await axios.post('/api/analysis/run/', {
                    pattern_data: pData,
                    filters: filters.value
                });
                if (res.data.code === 200) {
                    opportunities.value = res.data.data;
                    // ElementPlus.ElMessage.success(`åˆ·æ–°æˆåŠŸï¼Œå‘ç° ${res.data.data.length} ä¸ªæœºä¼š`);
                    if (opportunities.value.length === 0) ElementPlus.ElMessage.warning('æš‚æ— ç¬¦åˆæ¡ä»¶çš„æœºä¼šï¼Œè¯·è°ƒæ•´é˜ˆå€¼');
                }
            } catch (e) { ElementPlus.ElMessage.error('è·å–æ•°æ®å¤±è´¥'); }
            finally { loading.value = false; }
        };

        // 2. æ˜¾ç¤ºå›¾è¡¨ (ä¸‰çª—è”åŠ¨)
        const showDetail = (row) => {
            currCode.value = row.code;
            detailVisible.value = true;
        };

        const renderChart = async () => {
            if (chart) chart.dispose();
            const res = await axios.get(`/api/stock/detail/?code=${currCode.value}`);
            if (res.data.code !== 200) return ElementPlus.ElMessage.error('æš‚æ— æ•°æ®');

            const d = res.data.data;
            const ind = d.indicators;
            chart = echarts.init(document.getElementById('decision-kline'));

            let indSeries = [];
            if (currIndicator.value === 'MACD') {
                indSeries = [{ name: 'MACD', type: 'bar', xAxisIndex: 2, yAxisIndex: 2, data: ind.MACD, itemStyle: { color: p => p.value > 0 ? '#ef232a' : '#14b143' } }, { name: 'DIF', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DIF, symbol: 'none' }, { name: 'DEA', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DEA, symbol: 'none' }];
            } else if (currIndicator.value === 'KDJ') {
                indSeries = [{ name: 'K', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.K, symbol: 'none' }, { name: 'D', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.D, symbol: 'none' }, { name: 'J', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.J, symbol: 'none' }];
            } else {
                indSeries = [{ name: 'RSI', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.RSI, symbol: 'none' }];
            }

            chart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                legend: { top: 0, data: ['Kçº¿', 'MA5', 'MA20', 'æˆäº¤é‡', currIndicator.value] },
                grid: [{ left: '5%', right: '5%', height: '45%' }, { left: '5%', right: '5%', top: '58%', height: '15%' }, { left: '5%', right: '5%', top: '78%', height: '15%' }],
                xAxis: [{ type: 'category', data: d.dates, scale: true, boundaryGap: false, axisLine: { onZero: false } }, { type: 'category', gridIndex: 1, data: d.dates, show: false }, { type: 'category', gridIndex: 2, data: d.dates, show: false }],
                yAxis: [{ scale: true, splitArea: { show: true } }, { gridIndex: 1, splitNumber: 2, axisLabel: { show: false } }, { gridIndex: 2, splitNumber: 2, axisLabel: { show: false } }],
                dataZoom: [{ type: 'inside', xAxisIndex: [0, 1, 2], start: 60, end: 100 }, { type: 'slider', xAxisIndex: [0, 1, 2], bottom: 0 }],
                series: [
                    { name: 'Kçº¿', type: 'candlestick', data: d.values.map(v => [v[0], v[1], v[2], v[3]]), itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' } },
                    { name: 'MA5', type: 'line', data: ind.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'MA20', type: 'line', data: ind.MA20, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: d.values.map(v => v[4]), itemStyle: { color: p => d.values[p.dataIndex][1] > d.values[p.dataIndex][0] ? '#ef232a' : '#14b143' } },
                    ...indSeries
                ]
            });
        };

        // 3. æ‰“å¼€äº¤æ˜“å¼¹çª—
        const openTrade = (row, type) => {
            trade.value.visible = true;
            trade.value.type = type;
            trade.value.code = row.code;
            trade.value.name = row.name;
            trade.value.price = row.price;
            trade.value.volume = 100;
            trade.value.triggerValue = '';
        };

        // 4. æäº¤äº¤æ˜“
        const submitTrade = async () => {
            try {
                await axios.post('/api/trade/order/', trade.value);
                ElementPlus.ElMessage.success('å§”æ‰˜å·²æäº¤ï¼Œè¯·åœ¨äº¤æ˜“æµæ°´ä¸­æŸ¥çœ‹');
                trade.value.visible = false;
            } catch (e) {
                ElementPlus.ElMessage.error('äº¤æ˜“å¤±è´¥');
            }
        };

        const goHistory = () => window.location.href = '/api/trade/history/';

        onMounted(() => {
            init();
            loadOpportunities();
        });

        return { loading, opportunities, detailVisible, currCode, currIndicator, trade, loadOpportunities, showDetail, renderChart, openTrade, submitTrade, goHistory, filters, presets };
    }
</script>
{% endblock %}