{% extends 'base.html' %}
{% block title %}å¸‚åœºå…¨æ™¯é©¾é©¶èˆ±{% endblock %}

{% block content %}
<el-row :gutter="15">
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card">
            <div class="label">ğŸ“ˆ [[ currentSnapshot.name ]]</div>
            <div class="value" :class="currentSnapshot.is_up ? 'red' : 'green'">
                [[ currentSnapshot.price ]]
                <small>[[ currentSnapshot.change ]]</small>
            </div>
            <div class="sub">æˆäº¤é¢: [[ currentSnapshot.volume ]]</div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card">
            <div class="label">ğŸ”¥ å¸‚åœºæƒ…ç»ª</div>
            <div class="value">[[market.up_count]] å®¶ä¸Šæ¶¨</div>
            <el-progress :percentage="60" color="#F56C6C" :show-text="false"></el-progress>
            <div class="sub">[[market.down_count]] å®¶ä¸‹è·Œ | çƒ­é—¨: [[market.hot_sector]]</div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card">
            <div class="label">ğŸ’° èµ„é‡‘æµå‘</div>
            <div class="value red">+32.5äº¿ <small>åŒ—å‘</small></div>
            <div class="sub">ä¸»åŠ›å‡€æµ: -15.2äº¿</div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card action" @click="go('/api/pattern/lab/')">
            <div class="label" style="color:#409EFF">ğŸ¨ ç­–ç•¥å®éªŒå®¤</div>
            <div class="value" style="font-size:18px">ç»˜åˆ¶æ–°ç­–ç•¥ ></div>
            <div class="sub">è‡ªå®šä¹‰å½¢æ€ / Kçº¿ç»„åˆ</div>
        </el-card>
    </el-col>
</el-row>

<el-row :gutter="20" style="margin-top:20px">
    <el-col :span="18">
        <el-card>
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span>ğŸ“Š æ ¸å¿ƒæŒ‡æ•°è¶‹åŠ¿ (ä¸‰çª—è”åŠ¨)</span>
                    <el-select v-model="indexType" placeholder="é€‰æ‹©æŒ‡æ•°" size="small" style="width:150px" @change="loadData">
                        <el-option label="ä¸Šè¯æŒ‡æ•°" value="000001.SH"></el-option>
                        <el-option label="æ·±è¯æˆæŒ‡" value="399001.SZ"></el-option>
                        <el-option label="åˆ›ä¸šæ¿æŒ‡" value="399006.SZ"></el-option>
                        <el-option label="æ²ªæ·±300" value="000300.SH"></el-option>
                        <el-option label="ç§‘åˆ›50" value="000688.SH"></el-option>
                    </el-select>
                </div>
            </template>
            <div id="main-chart" style="height:500px"></div>
        </el-card>
    </el-col>

    <el-col :span="6">
        <el-card header="ğŸš€ å®æ—¶ä¿¡å·é¢„è­¦" style="height:540px; overflow-y:auto">
            <div v-for="item in signals" :key="item.code" class="signal-item" @click="showSignalDetail(item)">
                <div class="s-head"><span>[[item.name]]</span> <el-tag size="small" type="danger">[[item.pattern]]</el-tag></div>
                <div class="s-info">[[item.code]] <span class="red">[[item.change]]%</span></div>
            </div>
            <div style="margin-top:20px; text-align:center">
                <el-button type="primary" plain style="width:100%" @click="go('/api/analysis/scan/')">è¿›å…¥å…¨å¸‚åœºæ‰«æ</el-button>
            </div>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="detailVisible" width="85%" title="ä¸ªè‚¡æ·±åº¦åˆ†æ" @opened="renderDetailChart">
    <div style="display:flex; gap:20px">
        <div style="flex:3">
            <div id="detail-kline" style="height:450px"></div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; gap:15px">
            <div class="info-box">
                <h4>ğŸ“Š åŸºæœ¬é¢æ¦‚å†µ</h4>
                <p>è¡Œä¸šï¼š<b>[[stockInfo.basic?.industry]]</b></p>
                <p>æ€»å¸‚å€¼ï¼š[[stockInfo.basic?.total_mv]]</p>
                <p>å¸‚ç›ˆç‡(PE)ï¼š[[stockInfo.basic?.pe]]</p>
                <p>å¸‚å‡€ç‡(PB)ï¼š[[stockInfo.basic?.pb]]</p>
            </div>
            <div class="info-box">
                <h4>ğŸ’¸ èµ„é‡‘æµå‘</h4>
                <p>åŒ—å‘èµ„é‡‘ï¼š<span class="red">[[stockInfo.funds?.north_in]]äº¿</span></p>
                <p>ä¸»åŠ›å‡€æµï¼š<span class="green">[[stockInfo.funds?.main_in]]äº¿</span></p>
                <p>èèµ„ä½™é¢ï¼š[[stockInfo.funds?.rzrq]]</p>
            </div>
            <el-button type="danger" size="large" @click="go('/api/decision/center/')">åŠ å…¥è§‚å¯Ÿä»“</el-button>
        </div>
    </div>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .metric-card { height:120px; display:flex; flex-direction:column; justify-content:center }
    .label { font-size:12px; color:#909399; margin-bottom:5px }
    .value { font-size:20px; font-weight:bold; margin-bottom:5px }
    .sub { font-size:12px; color:#C0C4CC }
    .red{color:#F56C6C} .green{color:#67C23A}
    .action:hover { border-color:#409EFF; cursor:pointer }
    .signal-item { padding:12px; border-bottom:1px solid #eee; cursor:pointer; transition:0.2s } .signal-item:hover{background:#f5f7fa}
    .s-head { display:flex; justify-content:space-between; font-weight:bold }
    .info-box { background:#f9f9f9; padding:15px; border-radius:4px; border:1px solid #eee; }
    .info-box h4 { margin:0 0 10px 0; color:#303133; }
    .info-box p { margin:5px 0; font-size:13px; color:#606266; display:flex; justify-content:space-between; }
</style>
<script>
function pageSetup() {
    const { ref, onMounted } = Vue;
    const market = ref({});
    const currentSnapshot = ref({});
    const signals = ref([]);
    const indexType = ref('000001.SH');

    const detailVisible = ref(false);
    const currSignal = ref({});
    const stockInfo = ref({});
    let chart1=null, chart2=null;

    const init = () => { loadData(); };

    const loadData = async () => {
        const res = await axios.get(`/api/dashboard/data/?type=${indexType.value}`);
        market.value = res.data.data.market;
        currentSnapshot.value = res.data.data.snapshot;
        signals.value = res.data.data.signals;
        renderMainChart(res.data.data.index_data);
    };

    // ä¸»å›¾ï¼šä¸‰çª—è”åŠ¨ (Kçº¿ + MACD + KDJ)
    const renderMainChart = (data) => {
        if(chart1) chart1.dispose();
        chart1 = echarts.init(document.getElementById('main-chart'));

        // data: [date, open, close, low, high, vol, macd, dif, dea, k, d, j, rsi]
        const dates = data.map(i=>i[0]);
        const kdata = data.map(i=>[i[1],i[2],i[3],i[4]]); // OHLC
        const macd = data.map(i=>i[6]);
        const dif = data.map(i=>i[7]);
        const dea = data.map(i=>i[8]);
        const k = data.map(i=>i[9]);
        const d = data.map(i=>i[10]);
        const j = data.map(i=>i[11]);

        chart1.setOption({
            tooltip: { trigger:'axis', axisPointer:{type:'cross'} },
            legend: { data:['Kçº¿','MA5','MACD','DIF','DEA','K','D','J'], top:0 },
            grid: [
                {left:'5%', right:'5%', height:'50%'}, // ä¸»å›¾
                {left:'5%', right:'5%', top:'62%', height:'15%'}, // MACD
                {left:'5%', right:'5%', top:'80%', height:'15%'}  // KDJ
            ],
            xAxis: [
                { type:'category', data:dates, scale:true, boundaryGap:false, axisLine:{onZero:false}, splitLine:{show:false}, splitNumber:20, min:'dataMin', max:'dataMax' },
                { type:'category', gridIndex:1, data:dates, show:false },
                { type:'category', gridIndex:2, data:dates, show:false }
            ],
            yAxis: [
                { scale:true, splitArea:{show:true} },
                { gridIndex:1, splitNumber:3, axisLabel:{show:false} },
                { gridIndex:2, splitNumber:3, axisLabel:{show:false} }
            ],
            dataZoom: [{type:'inside', xAxisIndex:[0,1,2], start:60, end:100}, {type:'slider', xAxisIndex:[0,1,2], bottom:0}],
            series: [
                {name:'Kçº¿', type:'candlestick', data:kdata, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}},
                {name:'MACD', type:'bar', xAxisIndex:1, yAxisIndex:1, data:macd, itemStyle:{color: (params)=>params.value>0?'#ef232a':'#14b143'}},
                {name:'DIF', type:'line', xAxisIndex:1, yAxisIndex:1, data:dif, symbol:'none'},
                {name:'DEA', type:'line', xAxisIndex:1, yAxisIndex:1, data:dea, symbol:'none'},
                {name:'K', type:'line', xAxisIndex:2, yAxisIndex:2, data:k, symbol:'none', lineStyle:{width:1}},
                {name:'D', type:'line', xAxisIndex:2, yAxisIndex:2, data:d, symbol:'none', lineStyle:{width:1}},
                {name:'J', type:'line', xAxisIndex:2, yAxisIndex:2, data:j, symbol:'none', lineStyle:{width:1}}
            ]
        });
    };

    const showSignalDetail = (item) => {
        currSignal.value = item;
        detailVisible.value = true;
    };

    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currSignal.value.code}`);
        const d = res.data.data;
        stockInfo.value = { basic: d.basic, funds: d.funds };

        if(chart2) chart2.dispose();
        chart2 = echarts.init(document.getElementById('detail-kline'));

        chart2.setOption({
            tooltip: { trigger:'axis', axisPointer:{type:'cross'} },
            legend: { data:['Kçº¿','MA5','MA20'] },
            grid: { left:'5%', right:'5%', bottom:'15%' },
            xAxis: { data: d.dates },
            yAxis: { scale:true },
            dataZoom: [{type:'inside'}, {type:'slider', bottom:0}],
            series: [
                {name:'Kçº¿', type:'candlestick', data:d.values, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}},
                {name:'MA5', type:'line', data:d.indicators.MA5, smooth:true, lineStyle:{opacity:0.5}},
                {name:'MA20', type:'line', data:d.indicators.MA20, smooth:true, lineStyle:{opacity:0.5}}
            ]
        });
    };

    onMounted(init);
    return { market, currentSnapshot, signals, indexType, loadData, detailVisible, currSignal, showSignalDetail, renderDetailChart, stockInfo };
}
</script>
{% endblock %}