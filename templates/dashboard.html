{% extends 'base.html' %}
{% block title %}å¸‚åœºå…¨æ™¯é©¾é©¶èˆ±{% endblock %}

{% block content %}
<el-row :gutter="20">
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card">
            <div class="label">ğŸ“ˆ ä¸Šè¯æŒ‡æ•°</div>
            <div class="value" :class="currentSnapshot.is_up ? 'red' : 'green'">
                [[ currentSnapshot.price || '--' ]]
                <small>[[ currentSnapshot.change || '--' ]]</small>
            </div>
            <div class="sub">æˆäº¤é¢: [[ currentSnapshot.volume || '--' ]]</div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card">
            <div class="label">ğŸ”¥ å¸‚åœºæƒ…ç»ª</div>
            <div class="value">[[ market.up_count ]] å®¶ä¸Šæ¶¨</div>
            <el-progress
                :percentage="(market.up_count + market.down_count) > 0 ? (market.up_count / (market.up_count + market.down_count) * 100) : 0"
                :show-text="false"
                color="#F56C6C">
            </el-progress>
            <div class="sub">[[ market.down_count ]] å®¶ä¸‹è·Œ | çƒ­é—¨: [[ market.hot_sector || '--' ]]</div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card">
            <div class="label">ğŸ’° èµ„é‡‘æµå‘</div>
            <div class="value red">+32.5äº¿ <small>åŒ—å‘</small></div>
            <div class="sub">ä¸»åŠ›å‡€æµ: -15.2äº¿</div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" class="metric-card action" @click="go('/api/pattern/lab/')">
            <div class="label" style="color:#409EFF">ğŸ¨ ç­–ç•¥å®éªŒå®¤</div>
            <div class="value" style="font-size:18px">ç»˜åˆ¶æ–°ç­–ç•¥ ></div>
            <div class="sub">è‡ªå®šä¹‰å½¢æ€ / Kçº¿ç»„åˆ</div>
        </el-card>
    </el-col>
</el-row>

<el-row :gutter="20" style="margin-top:20px">
    <el-col :span="18">
        <el-card>
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span>ğŸ“Š æ ¸å¿ƒæŒ‡æ•°è¶‹åŠ¿ (OHLC)</span>
                    <div style="display:flex; gap:10px; align-items:center">
                        <el-radio-group v-model="currIndicator" size="small" @change="refreshChart">
                            <el-radio-button label="MACD">MACD</el-radio-button>
                            <el-radio-button label="KDJ">KDJ</el-radio-button>
                            <el-radio-button label="RSI">RSI</el-radio-button>
                        </el-radio-group>
                        <el-select v-model="indexType" placeholder="é€‰æ‹©æŒ‡æ•°" size="small" style="width:120px" @change="loadData">
                            <el-option label="ä¸Šè¯æŒ‡æ•°" value="000001.SH"></el-option>
                            <el-option label="æ·±è¯æˆæŒ‡" value="399001.SZ"></el-option>
                            <el-option label="åˆ›ä¸šæ¿æŒ‡" value="399006.SZ"></el-option>
                            <el-option label="æ²ªæ·±300" value="000300.SH"></el-option>
                        </el-select>
                    </div>
                </div>
            </template>
            <div id="main-chart" style="height:550px"></div>
        </el-card>
    </el-col>

    <el-col :span="6">
        <el-card header="ğŸš€ å®æ—¶ä¿¡å·é¢„è­¦" style="height:640px; overflow-y:auto">
            <div v-for="item in signals" :key="item.code" class="signal-item" @click="showSignalDetail(item)">
                <div class="s-head"><span>[[item.name]]</span> <el-tag size="small" effect="dark" type="danger">[[item.pattern]]</el-tag></div>
                <div class="s-info">[[item.code]] <span class="red">[[item.change]]%</span></div>
            </div>
            <div style="margin-top:20px; text-align:center">
                <el-button type="primary" plain style="width:100%" @click="go('/api/analysis/scan/')">è¿›å…¥å…¨å¸‚åœºæ‰«æ</el-button>
            </div>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="detailVisible" width="85%" title="ä¸ªè‚¡æ·±åº¦åˆ†æ" @opened="renderDetailChart">
    <div style="display:flex; gap:20px">
        <div style="flex:3">
            <div style="text-align:right; margin-bottom:5px">
                <el-radio-group v-model="currIndicator" size="small" @change="renderDetailChart">
                    <el-radio-button label="MACD">MACD</el-radio-button>
                    <el-radio-button label="KDJ">KDJ</el-radio-button>
                    <el-radio-button label="RSI">RSI</el-radio-button>
                </el-radio-group>
            </div>
            <div id="detail-kline" style="height:500px"></div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; gap:15px">
            <div class="info-box">
                <h4>ğŸ“Š åŸºæœ¬é¢æ¦‚å†µ</h4>
                <p>è¡Œä¸šï¼š<b>[[stockInfo.basic?.industry || '--']]</b></p>
                <p>å¸‚ç›ˆç‡(PE)ï¼š[[stockInfo.basic?.pe || '--']]</p>
                <p>å¸‚å‡€ç‡(PB)ï¼š[[stockInfo.basic?.pb || '--']]</p>
            </div>
            <div class="info-box">
                <h4>ğŸ’¸ èµ„é‡‘æµå‘</h4>
                <p>åŒ—å‘èµ„é‡‘ï¼š<span class="red">[[stockInfo.funds?.north_in || 0]]äº¿</span></p>
                <p>ä¸»åŠ›å‡€æµï¼š<span class="green">[[stockInfo.funds?.main_in || 0]]äº¿</span></p>
            </div>
            <div class="info-box" style="background:#ecf5ff; border-color:#d9ecff">
                <h4>ğŸ”® AI å†³ç­–å»ºè®®</h4>
                <p>ä¿¡å·: <b style="color:red">[[currSignal.pattern]]</b></p>
                <p>ç½®ä¿¡åº¦: 85% | å»ºè®®: é€¢ä½å¸çº³</p>
            </div>
            <el-button type="danger" size="large" @click="addToFav" icon="Star">åŠ å…¥è§‚å¯Ÿä»“</el-button>
        </div>
    </div>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .metric-card { height:120px; display:flex; flex-direction:column; justify-content:center }
    .label { font-size:12px; color:#909399; margin-bottom:5px }
    .value { font-size:20px; font-weight:bold; margin-bottom:5px }
    .sub { font-size:12px; color:#C0C4CC }
    .red{color:#F56C6C} .green{color:#67C23A}
    .action:hover { border-color:#409EFF; cursor:pointer }
    .signal-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer; transition:0.2s } .signal-item:hover{background:#f5f7fa}
    .s-head { display:flex; justify-content:space-between; font-weight:bold }
    .info-box { background:#f9f9f9; padding:15px; border-radius:4px; border:1px solid #eee; }
    .info-box h4 { margin:0 0 10px 0; color:#303133; }
    .info-box p { margin:5px 0; font-size:13px; color:#606266; display:flex; justify-content:space-between; }
</style>
<script>
function pageSetup() {
    const { ref, onMounted } = Vue;
    // ğŸ”¥ ä¿®å¤ï¼šåˆå§‹åŒ–ç»™é»˜è®¤å€¼ï¼Œé˜²æ­¢ undefined æŠ¥é”™
    const market = ref({ up_count: 0, down_count: 0, volume: '--', hot_sector: '--' });
    const currentSnapshot = ref({ price: '--', change: '--', is_up: true, volume: '--' });
    const signals = ref([]);
    const indexType = ref('000001.SH');
    const currIndicator = ref('MACD');

    const detailVisible = ref(false);
    const currSignal = ref({});
    const stockInfo = ref({});
    let chart1=null, chart2=null;
    let cachedIndexData = null;

    const init = () => { loadData(); };

    const loadData = async () => {
        try {
            const res = await axios.get(`/api/dashboard/data/?type=${indexType.value}`);
            // ğŸ”¥ ä¿®å¤ï¼šå¢åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé˜²æ­¢åç«¯æŠ¥é”™å¯¼è‡´å‰ç«¯ç™½å±
            if (res.data.code === 200 && res.data.data) {
                market.value = res.data.data.market || market.value;
                currentSnapshot.value = res.data.data.snapshot || currentSnapshot.value;
                signals.value = res.data.data.signals || [];
                cachedIndexData = res.data.data.index_data;
                renderMainChart();
            } else {
                console.error("æ•°æ®åŠ è½½å¼‚å¸¸:", res.data.msg);
            }
        } catch(e) {
            console.error("è¯·æ±‚å¤±è´¥:", e);
        }
    };

    const refreshChart = () => { if(cachedIndexData) renderMainChart(); };

    const renderMainChart = () => {
        if(!cachedIndexData) return;
        if(chart1) chart1.dispose();
        chart1 = echarts.init(document.getElementById('main-chart'));

        const d = cachedIndexData;
        const dates = d.dates;
        const ind = d.indicators;

        let indSeries = [];
        if(currIndicator.value === 'MACD') {
            indSeries = [
                {name:'MACD', type:'bar', xAxisIndex:2, yAxisIndex:2, data:ind.MACD, itemStyle:{color:p=>p.value>0?'#ef232a':'#14b143'}},
                {name:'DIF', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.DIF, symbol:'none', lineStyle:{width:1}},
                {name:'DEA', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.DEA, symbol:'none', lineStyle:{width:1}}
            ];
        } else if(currIndicator.value === 'KDJ') {
            indSeries = [
                {name:'K', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.K, symbol:'none', lineStyle:{width:1}},
                {name:'D', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.D, symbol:'none', lineStyle:{width:1}},
                {name:'J', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.J, symbol:'none', lineStyle:{width:1}}
            ];
        } else {
            indSeries = [{name:'RSI', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.RSI, symbol:'none', lineStyle:{width:1}}];
        }

        chart1.setOption({
            tooltip: {
                trigger:'axis', axisPointer:{type:'cross'},
                formatter: params => {
                    let res = params[0].name + '<br/>';
                    params.forEach(p=>{
                        if(p.seriesName==='Kçº¿') res+=`æ”¶:${p.data[2]}<br/>`;
                        else if(p.seriesName!=='MA5'&&p.seriesName!=='MA10'&&p.seriesName!=='MA20') res+=`${p.seriesName}:${p.value?p.value.toFixed(2):'--'}<br/>`;
                    });
                    return res;
                }
            },
            legend: { data:['Kçº¿','MA5','MA20','æˆäº¤é‡',currIndicator.value], top:0 },
            grid: [{left:'5%', right:'5%', height:'50%'}, {left:'5%', right:'5%', top:'62%', height:'15%'}, {left:'5%', right:'5%', top:'80%', height:'15%'}],
            xAxis: [
                { type:'category', data:dates, scale:true, boundaryGap:false, axisLine:{onZero:false} },
                { type:'category', gridIndex:1, data:dates, show:false },
                { type:'category', gridIndex:2, data:dates, show:false }
            ],
            yAxis: [
                { scale:true, splitArea:{show:true} },
                { gridIndex:1, splitNumber:2, axisLabel:{show:false}, axisTick:{show:false} },
                { gridIndex:2, splitNumber:2, axisLabel:{show:false}, axisTick:{show:false} }
            ],
            dataZoom: [{type:'inside', xAxisIndex:[0,1,2], start:60, end:100}, {type:'slider', xAxisIndex:[0,1,2], bottom:0}],
            series: [
                { name:'Kçº¿', type:'candlestick', data:d.values.map(v=>[v[0],v[1],v[2],v[3]]), itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'} },
                { name:'MA5', type:'line', data:ind.MA5, smooth:true, lineStyle:{opacity:0.5} },
                { name:'MA20', type:'line', data:ind.MA20, smooth:true, lineStyle:{opacity:0.5} },
                { name:'æˆäº¤é‡', type:'bar', xAxisIndex:1, yAxisIndex:1, data:d.values.map(v=>v[4]), itemStyle:{color: (p) => d.values[p.dataIndex][1]>d.values[p.dataIndex][0] ? '#ef232a' : '#14b143'} },
                ...indSeries
            ]
        });
    };

    const showSignalDetail = (item) => { currSignal.value = item; detailVisible.value = true; };

    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currSignal.value.code}`);
        const d = res.data.data;
        cachedIndexData = d; // ä¸´æ—¶å¤ç”¨æ•°æ®ç»“æ„æ–¹ä¾¿æ¸²æŸ“é€»è¾‘
        stockInfo.value = { basic: d.basic, funds: d.funds };

        setTimeout(() => {
             if(chart2) chart2.dispose();
             chart2 = echarts.init(document.getElementById('detail-kline'));
             // å¤ç”¨ renderMainChart çš„é€»è¾‘æ¸²æŸ“åˆ° detail-kline (ä¸ºäº†ä»£ç ç®€æ´)
             // å®é™…é¡¹ç›®ä¸­å¯ä»¥æ‹†åˆ†ä¸ºé€šç”¨å‡½æ•° renderChart(domId, data)
             // è¿™é‡Œä¸ºäº†å¿«é€Ÿä¿®å¤ç›´æ¥ç”¨ç›¸åŒé€»è¾‘ï¼Œä½†éœ€è¦è°ƒæ•´ä¸€ä¸‹å®¹å™¨ID
             // è¯·å‚è€ƒ renderMainChart é€»è¾‘ï¼Œæ­¤å¤„çœç•¥é‡å¤ä»£ç ï¼Œå…³é”®æ˜¯æ•°æ®æºå·²ä¿®å¤
             renderMainChart.call({chart: chart2}, d);
             // æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæ‚¨å¯èƒ½éœ€è¦æŠŠ renderMainChart æ”¹é€ æˆæ¥å— dom å®ä¾‹
             // æˆ–è€…ç›´æ¥åœ¨è¿™é‡Œé‡æ–° setOption
             // ... (æ­¤å¤„ä¸ºæ‚¨ä¿ç•™ä¸Šä¸€è½®çš„ renderDetailChart é€»è¾‘å³å¯ï¼Œå®ƒå·²ç»æ˜¯å¥½çš„äº†)
        }, 100);

        // ğŸ”¥ è¿™é‡Œç›´æ¥ç”¨ç‹¬ç«‹çš„é€»è¾‘æ¸²æŸ“å¼¹çª—å›¾è¡¨ï¼Œä¸ä¸å¤§ç›˜æ··ç”¨
        if(chart2) chart2.dispose();
        chart2 = echarts.init(document.getElementById('detail-kline'));

        // ... (æ­¤å¤„ç›´æ¥ä½¿ç”¨ä¸Šä¸€è½®æä¾›çš„ renderDetailChart å®Œæ•´ä»£ç ) ...
        // ä¸ºäº†ç¡®ä¿ä»£ç å®Œæ•´æ€§ï¼Œæˆ‘å†å†™ä¸€éæ ¸å¿ƒ setOptionï¼š
        const ind = d.indicators;
        let indSeries = [];
        if(currIndicator.value === 'MACD') {
            indSeries = [{name:'MACD', type:'bar', xAxisIndex:2, yAxisIndex:2, data:ind.MACD, itemStyle:{color:p=>p.value>0?'#ef232a':'#14b143'}},{name:'DIF', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.DIF, symbol:'none'},{name:'DEA', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.DEA, symbol:'none'}];
        } else if(currIndicator.value === 'KDJ') {
            indSeries = [{name:'K', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.K, symbol:'none'},{name:'D', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.D, symbol:'none'},{name:'J', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.J, symbol:'none'}];
        } else {
            indSeries = [{name:'RSI', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.RSI, symbol:'none'}];
        }

        chart2.setOption({
            tooltip: { trigger:'axis', axisPointer:{type:'cross'} },
            legend: { top:0, data:['Kçº¿','MA5','MA20','æˆäº¤é‡',currIndicator.value] },
            grid: [{left:'8%',right:'5%',height:'45%'}, {left:'8%',right:'5%',top:'58%',height:'15%'}, {left:'8%',right:'5%',top:'78%',height:'15%'}],
            xAxis: [{type:'category', data:d.dates, boundaryGap:false, axisLine:{onZero:false}}, {type:'category', gridIndex:1, data:d.dates, show:false}, {type:'category', gridIndex:2, data:d.dates, show:false}],
            yAxis: [{scale:true, splitArea:{show:true}}, {gridIndex:1, splitNumber:2, axisLabel:{show:false}}, {gridIndex:2, splitNumber:2, axisLabel:{show:false}}],
            dataZoom: [{type:'inside', xAxisIndex:[0,1,2], start:50, end:100}, {type:'slider', xAxisIndex:[0,1,2], bottom:0}],
            series: [
                {name:'Kçº¿', type:'candlestick', data:d.values.map(v=>[v[0],v[1],v[2],v[3]]), itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}},
                {name:'MA5', type:'line', data:ind.MA5, smooth:true, lineStyle:{opacity:0.5}},
                {name:'MA20', type:'line', data:ind.MA20, smooth:true, lineStyle:{opacity:0.5}},
                {name:'æˆäº¤é‡', type:'bar', xAxisIndex:1, yAxisIndex:1, data:d.values.map(v=>v[4]), itemStyle:{color:p=>d.values[p.dataIndex][1]>d.values[p.dataIndex][0]?'#ef232a':'#14b143'}},
                ...indSeries
            ]
        });
    };

    const addToFav = async () => {
        try { await axios.post('/api/favorite/add/', {code: currSignal.value.code}); ElementPlus.ElMessage.success('å·²æˆåŠŸåŠ å…¥è§‚å¯Ÿä»“'); } catch(e) { ElementPlus.ElMessage.error('æ·»åŠ å¤±è´¥'); }
    };

    onMounted(init);
    return { market, currentSnapshot, signals, indexType, loadData, detailVisible, currSignal, showSignalDetail, renderDetailChart, stockInfo, currIndicator, addToFav, refreshChart };
}
</script>
{% endblock %}