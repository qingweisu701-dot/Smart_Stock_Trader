{% extends 'base.html' %}
{% block title %}å¸‚åœºå…¨æ™¯é©¾é©¶èˆ±{% endblock %}

{% block content %}
<el-row :gutter="20">
    <el-col :span="6">
        <el-card shadow="hover" :body-style="{ padding: '20px' }">
            <div class="metric-card">
                <div class="metric-icon blue"><el-icon><Trend-Charts /></el-icon></div>
                <div class="metric-content">
                    <div class="metric-label">ä¸Šè¯æŒ‡æ•°</div>
                    <div class="metric-value">
                        [[ currentSnapshot.price || '--' ]]
                    </div>
                    <div class="metric-sub" :class="currentSnapshot.is_up ? 'red' : 'green'">
                        <span v-if="currentSnapshot.is_up">â–²</span><span v-else>â–¼</span>
                        [[ currentSnapshot.change || '--' ]]
                    </div>
                </div>
            </div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" :body-style="{ padding: '20px' }">
            <div class="metric-card">
                <div class="metric-icon red"><el-icon>
                        <Histogram />
                    </el-icon></div>
                <div class="metric-content">
                    <div class="metric-label">å¸‚åœºæƒ…ç»ª</div>
                    <div class="metric-value">[[market.up_count]] <small style="font-size:14px;color:#999">å®¶æ¶¨</small>
                    </div>
                    <el-progress
                        :percentage="(market.up_count + market.down_count) > 0 ? (market.up_count / (market.up_count + market.down_count) * 100) : 0"
                        :show-text="false" :stroke-width="6" color="#ff4d4f"></el-progress>
                </div>
            </div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" :body-style="{ padding: '20px' }">
            <div class="metric-card">
                <div class="metric-icon purple"><el-icon>
                        <Money />
                    </el-icon></div>
                <div class="metric-content">
                    <div class="metric-label">ä¸»åŠ›å‡€æµ</div>
                    <div class="metric-value green">-15.2äº¿</div>
                    <div class="metric-sub">åŒ—å‘èµ„é‡‘: <span class="red">+32.5äº¿</span></div>
                </div>
            </div>
        </el-card>
    </el-col>
    <el-col :span="6">
        <el-card shadow="hover" :body-style="{ padding: '20px' }" class="action-card" @click="go('/api/pattern/lab/')">
            <div class="metric-icon green"
                style="width:40px;height:40px;margin-bottom:5px;margin-right:0;font-size:20px"><el-icon>
                    <Edit />
                </el-icon></div>
            <div style="font-weight:600; color:#333">ç­–ç•¥å®éªŒå®¤</div>
            <div style="font-size:12px; color:#999">ç»˜åˆ¶/å›æµ‹æ–°å½¢æ€</div>
        </el-card>
    </el-col>
</el-row>

<el-row :gutter="20" style="margin-top:20px">
    <el-col :span="24">
        <el-card shadow="hover">
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span>ğŸ“Š æ ¸å¿ƒæŒ‡æ•°è¶‹åŠ¿ (ä¸‰çª—è”åŠ¨)</span>
                    <div style="display:flex; gap:10px">
                        <el-radio-group v-model="currIndicator" size="small" @change="refreshChart">
                            <el-radio-button label="MACD">MACD</el-radio-button>
                            <el-radio-button label="KDJ">KDJ</el-radio-button>
                            <el-radio-button label="RSI">RSI</el-radio-button>
                        </el-radio-group>
                        <el-select v-model="indexType" placeholder="é€‰æ‹©æŒ‡æ•°" size="small" style="width:120px"
                            @change="loadData">
                            <el-option label="ä¸Šè¯æŒ‡æ•°" value="000001.SH"></el-option>
                            <el-option label="æ·±è¯æˆæŒ‡" value="399001.SZ"></el-option>
                            <el-option label="åˆ›ä¸šæ¿æŒ‡" value="399006.SZ"></el-option>
                            <el-option label="æ²ªæ·±300" value="000300.SH"></el-option>
                        </el-select>
                    </div>
                </div>
            </template>
            <div id="main-chart" style="height:550px"></div>
        </el-card>
    </el-col>
</el-row>

<el-row :gutter="20" style="margin-top:20px">
    <el-col :span="24">
        <el-card shadow="hover" header="ğŸš€ å®æ—¶ä¿¡å·é¢„è­¦ä¸­å¿ƒ">
            <el-table :data="signals" style="width: 100%" stripe @row-click="showSignalDetail" highlight-current-row
                class="signal-table">
                <el-table-column prop="name" label="åç§°" width="120">
                    <template #default="scope">
                        <span style="font-weight:bold">[[ scope.row.name ]]</span>
                    </template>
                </el-table-column>
                <el-table-column prop="code" label="ä»£ç " width="120"></el-table-column>
                <el-table-column prop="pattern" label="è§¦å‘å½¢æ€">
                    <template #default="scope">
                        <el-tag effect="plain" type="danger">[[ scope.row.pattern ]]</el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="æœ€æ–°æ¶¨è·Œ" width="150">
                    <template #default="scope">
                        <span class="red" style="font-weight:bold">[[ scope.row.change ]]%</span>
                    </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="150" align="right">
                    <template #default="scope">
                        <el-button size="small" type="primary" plain round>æ·±åº¦åˆ†æ</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <div style="margin-top:15px; text-align:center">
                <el-button type="info" link @click="go('/api/analysis/scan/')">æŸ¥çœ‹æ›´å¤šæ‰«æç»“æœ >></el-button>
            </div>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="detailVisible" width="85%" title="ä¸ªè‚¡æ·±åº¦åˆ†æ" @opened="renderDetailChart">
    <div style="display:flex; gap:20px">
        <div style="flex:3">
            <div style="text-align:right; margin-bottom:5px">
                <el-radio-group v-model="currIndicator" size="small" @change="renderDetailChart">
                    <el-radio-button label="MACD">MACD</el-radio-button>
                    <el-radio-button label="KDJ">KDJ</el-radio-button>
                    <el-radio-button label="RSI">RSI</el-radio-button>
                </el-radio-group>
            </div>
            <div id="detail-kline" style="height:500px"></div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; gap:15px">
            <div class="info-box">
                <h4>ğŸ“Š åŸºæœ¬é¢æ¦‚å†µ</h4>
                <p>è¡Œä¸šï¼š<b>[[stockInfo.basic?.industry || '--']]</b></p>
                <p>å¸‚ç›ˆç‡(PE)ï¼š[[stockInfo.basic?.pe || '--']]</p>
                <p>å¸‚å‡€ç‡(PB)ï¼š[[stockInfo.basic?.pb || '--']]</p>
            </div>
            <div class="info-box">
                <h4>ğŸ’¸ èµ„é‡‘æµå‘</h4>
                <p>åŒ—å‘èµ„é‡‘ï¼š<span class="red">[[stockInfo.funds?.north_in || 0]]äº¿</span></p>
                <p>ä¸»åŠ›å‡€æµï¼š<span class="green">[[stockInfo.funds?.main_in || 0]]äº¿</span></p>
            </div>
            <div class="info-box" style="background:#ecf5ff; border-color:#d9ecff">
                <h4>ğŸ”® AI å†³ç­–å»ºè®®</h4>
                <p>ä¿¡å·: <b style="color:red">[[currSignal.pattern]]</b></p>
                <p>ç½®ä¿¡åº¦: 85% | å»ºè®®: é€¢ä½å¸çº³</p>
            </div>
            <el-button type="danger" size="large" @click="addToFav" icon="Star">åŠ å…¥è§‚å¯Ÿä»“</el-button>
        </div>
    </div>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .metric-card {
        height: 100px;
        display: flex;
        align-items: center;
        padding: 0 10px;
    }

    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 28px;
    }

    .metric-icon.blue {
        background: #e6f7ff;
        color: #1890ff;
    }

    .metric-icon.red {
        background: #fff1f0;
        color: #f5222d;
    }

    .metric-icon.green {
        background: #f6ffed;
        color: #52c41a;
    }

    .metric-icon.purple {
        background: #f9f0ff;
        color: #722ed1;
    }

    .metric-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .metric-label {
        font-size: 14px;
        color: #8c8c8c;
        margin-bottom: 4px;
    }

    .metric-value {
        font-size: 24px;
        font-weight: 600;
        color: #000;
        line-height: 1.2;
    }

    .metric-sub {
        font-size: 12px;
        color: #bfbfbf;
        margin-top: 4px;
    }

    .red {
        color: #F56C6C
    }

    .green {
        color: #67C23A
    }

    .action-card {
        text-align: center;
        height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .action-card:hover {
        transform: translateY(-2px);
        transition: all 0.3s;
    }

    .signal-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .signal-table {
        cursor: pointer;
    }

    .s-head {
        font-weight: 500;
        color: #303133
    }

    .info-box {
        background: #fafafa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #f0f0f0;
    }

    .info-box h4 {
        margin: 0 0 10px 0;
        color: #1f1f1f;
        font-size: 14px;
        font-weight: 600;
    }

    .info-box p {
        margin: 6px 0;
        font-size: 13px;
        color: #595959;
        display: flex;
        justify-content: space-between;
    }
</style>
<script>
    function pageSetup() {
        const { ref, onMounted } = Vue;
        const market = ref({ up_count: 0, down_count: 0, volume: '--', hot_sector: '--' });
        const currentSnapshot = ref({ price: '--', change: '--', is_up: true, volume: '--' });
        const signals = ref([]);
        const indexType = ref('000001.SH');
        const currIndicator = ref('MACD');

        const detailVisible = ref(false);
        const currSignal = ref({});
        const stockInfo = ref({});
        let chart1 = null, chart2 = null;
        let cachedIndexData = null;

        const init = () => { loadData(); };

        const loadData = async () => {
            try {
                const res = await axios.get(`/api/dashboard/data/?type=${indexType.value}`);
                if (res.data.code === 200 && res.data.data) {
                    market.value = res.data.data.market || {};
                    currentSnapshot.value = res.data.data.snapshot || {};
                    signals.value = res.data.data.signals || [];
                    cachedIndexData = res.data.data.index_data;
                    renderMainChart();
                }
            } catch (e) { console.error(e); }
        };

        const refreshChart = () => { if (cachedIndexData) renderMainChart(); };

        // ğŸ”¥ é¦–é¡µå¤§ç›˜ï¼šä¸‰çª—è”åŠ¨ + ä¸­æ–‡ Tooltip
        const renderMainChart = () => {
            if (!cachedIndexData) return;
            if (chart1) chart1.dispose();
            chart1 = echarts.init(document.getElementById('main-chart'));

            const d = cachedIndexData;
            const ind = d.indicators;

            let indSeries = [];
            if (currIndicator.value === 'MACD') {
                indSeries = [
                    { name: 'MACD', type: 'bar', xAxisIndex: 2, yAxisIndex: 2, data: ind.MACD, itemStyle: { color: p => p.value > 0 ? '#ef232a' : '#14b143' } },
                    { name: 'DIF', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DIF, symbol: 'none', lineStyle: { width: 1 } },
                    { name: 'DEA', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DEA, symbol: 'none', lineStyle: { width: 1 } }
                ];
            } else if (currIndicator.value === 'KDJ') {
                indSeries = [
                    { name: 'K', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.K, symbol: 'none', lineStyle: { width: 1 } },
                    { name: 'D', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.D, symbol: 'none', lineStyle: { width: 1 } },
                    { name: 'J', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.J, symbol: 'none', lineStyle: { width: 1 } }
                ];
            } else {
                indSeries = [{ name: 'RSI', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.RSI, symbol: 'none', lineStyle: { width: 1 } }];
            }

            chart1.setOption({
                tooltip: {
                    trigger: 'axis', axisPointer: { type: 'cross' },
                    // ğŸ”¥ ä¿®å¤ï¼šä¸­æ–‡ Tooltip Formatter
                    formatter: function (params) {
                        let res = `<div style="margin-bottom:5px;font-weight:bold">${params[0].name}</div>`;
                        params.forEach(p => {
                            if (p.seriesName === 'Kçº¿') {
                                const open = p.data[1], close = p.data[2], low = p.data[3], high = p.data[4];
                                // è®¡ç®—æ¶¨è·Œå¹…
                                const chg = ((close - open) / open * 100).toFixed(2);
                                const color = chg >= 0 ? '#ef232a' : '#14b143';
                                res += `Kçº¿ï¼š<span style="color:${color}">æ”¶ç›˜ ${close} (å¹…${chg}%)</span><br/>`;
                                res += `&nbsp;&nbsp;&nbsp;&nbsp;å¼€ç›˜ ${open} æœ€é«˜ ${high} æœ€ä½ ${low}<br/>`;
                            } else if (p.seriesName === 'æˆäº¤é‡') {
                                // æ ¼å¼åŒ–æˆäº¤é‡ (äº¿/ä¸‡)
                                let valStr = p.data;
                                if (p.data > 100000000) valStr = (p.data / 100000000).toFixed(2) + 'äº¿';
                                else if (p.data > 10000) valStr = (p.data / 10000).toFixed(2) + 'ä¸‡';
                                res += `æˆäº¤é‡ï¼š${valStr}<br/>`;
                            } else {
                                // æŒ‡æ ‡æ•°å€¼
                                res += `${p.seriesName}ï¼š${p.value ? p.value.toFixed(2) : '--'}<br/>`;
                            }
                        });
                        return res;
                    }
                },
                legend: { top: 0, data: ['Kçº¿', 'MA5', 'MA20', 'æˆäº¤é‡', currIndicator.value] },
                grid: [{ left: '5%', right: '5%', height: '50%' }, { left: '5%', right: '5%', top: '62%', height: '15%' }, { left: '5%', right: '5%', top: '80%', height: '15%' }],
                xAxis: [{ type: 'category', data: d.dates, boundaryGap: false, axisLine: { onZero: false } }, { type: 'category', gridIndex: 1, data: d.dates, show: false }, { type: 'category', gridIndex: 2, data: d.dates, show: false }],
                yAxis: [{ scale: true, splitArea: { show: true } }, { gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisTick: { show: false } }, { gridIndex: 2, splitNumber: 2, axisLabel: { show: false }, axisTick: { show: false } }],
                dataZoom: [{ type: 'inside', xAxisIndex: [0, 1, 2], start: 60, end: 100 }, { type: 'slider', xAxisIndex: [0, 1, 2], bottom: 0 }],
                series: [
                    { name: 'Kçº¿', type: 'candlestick', data: d.values.map(v => [v[0], v[1], v[2], v[3]]), itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' } },
                    { name: 'MA5', type: 'line', data: ind.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'MA20', type: 'line', data: ind.MA20, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: d.values.map(v => v[4]), itemStyle: { color: (p) => d.values[p.dataIndex][1] > d.values[p.dataIndex][0] ? '#ef232a' : '#14b143' } },
                    ...indSeries
                ]
            });
        };

        const showSignalDetail = (item) => { currSignal.value = item; detailVisible.value = true; };

        // å¼¹çª—è¯¦æƒ…å›¾è¡¨
        const renderDetailChart = async () => {
            if (chart2) { chart2.dispose(); chart2 = null; }

            const res = await axios.get(`/api/stock/detail/?code=${currSignal.value.code}`);
            if (res.data.code !== 200) return;
            const d = res.data.data;
            stockInfo.value = { basic: d.basic, funds: d.funds };

            setTimeout(() => {
                const dom = document.getElementById('detail-kline');
                if (!dom) return;
                chart2 = echarts.init(dom);

                const ind = d.indicators;
                let indSeries = [];
                if (currIndicator.value === 'MACD') {
                    indSeries = [{ name: 'MACD', type: 'bar', xAxisIndex: 2, yAxisIndex: 2, data: ind.MACD, itemStyle: { color: p => p.value > 0 ? '#ef232a' : '#14b143' } }, { name: 'DIF', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DIF, symbol: 'none' }, { name: 'DEA', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.DEA, symbol: 'none' }];
                } else if (currIndicator.value === 'KDJ') {
                    indSeries = [{ name: 'K', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.K, symbol: 'none' }, { name: 'D', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.D, symbol: 'none' }, { name: 'J', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.J, symbol: 'none' }];
                } else {
                    indSeries = [{ name: 'RSI', type: 'line', xAxisIndex: 2, yAxisIndex: 2, data: ind.RSI, symbol: 'none' }];
                }

                chart2.setOption({
                    tooltip: {
                        trigger: 'axis', axisPointer: { type: 'cross' },
                        // ğŸ”¥ ä¿®å¤ï¼šå¼¹çª—ä¹Ÿä½¿ç”¨ä¸­æ–‡ Tooltip
                        formatter: function (params) {
                            let res = `<div style="margin-bottom:5px;font-weight:bold">${params[0].name}</div>`;
                            params.forEach(p => {
                                if (p.seriesName === 'Kçº¿') {
                                    const open = p.data[1], close = p.data[2], low = p.data[3], high = p.data[4];
                                    const chg = ((close - open) / open * 100).toFixed(2);
                                    const color = chg >= 0 ? '#ef232a' : '#14b143';
                                    res += `Kçº¿ï¼š<span style="color:${color}">æ”¶${close} (å¹…${chg}%)</span><br/>`;
                                    res += `&nbsp;&nbsp;&nbsp;&nbsp;å¼€${open} é«˜${high} ä½${low}<br/>`;
                                } else if (p.seriesName === 'æˆäº¤é‡') {
                                    res += `æˆäº¤é‡ï¼š${p.data}<br/>`;
                                } else {
                                    res += `${p.seriesName}ï¼š${p.value ? p.value.toFixed(2) : '--'}<br/>`;
                                }
                            });
                            return res;
                        }
                    },
                    legend: { top: 0, data: ['Kçº¿', 'MA5', 'MA20', 'æˆäº¤é‡', currIndicator.value] },
                    grid: [{ left: '8%', right: '5%', height: '45%' }, { left: '8%', right: '5%', top: '58%', height: '15%' }, { left: '8%', right: '5%', top: '78%', height: '15%' }],
                    xAxis: [{ type: 'category', data: d.dates, boundaryGap: false, axisLine: { onZero: false } }, { type: 'category', gridIndex: 1, data: d.dates, show: false }, { type: 'category', gridIndex: 2, data: d.dates, show: false }],
                    yAxis: [{ scale: true, splitArea: { show: true } }, { gridIndex: 1, splitNumber: 2, axisLabel: { show: false } }, { gridIndex: 2, splitNumber: 2, axisLabel: { show: false } }],
                    dataZoom: [{ type: 'inside', xAxisIndex: [0, 1, 2], start: 50, end: 100 }, { type: 'slider', xAxisIndex: [0, 1, 2], bottom: 0 }],
                    series: [
                        { name: 'Kçº¿', type: 'candlestick', data: d.values.map(v => [v[0], v[1], v[2], v[3]]), itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' } },
                        { name: 'MA5', type: 'line', data: ind.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                        { name: 'MA20', type: 'line', data: ind.MA20, smooth: true, lineStyle: { opacity: 0.5 } },
                        { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: d.values.map(v => v[4]), itemStyle: { color: p => d.values[p.dataIndex][1] > d.values[p.dataIndex][0] ? '#ef232a' : '#14b143' } },
                        ...indSeries
                    ]
                });
            }, 50);
        };

        const addToFav = async () => {
            try { await axios.post('/api/favorite/add/', { code: currSignal.value.code }); ElementPlus.ElMessage.success('å·²æˆåŠŸåŠ å…¥è§‚å¯Ÿä»“'); } catch (e) { ElementPlus.ElMessage.error('æ·»åŠ å¤±è´¥'); }
        };

        onMounted(init);
        return { market, currentSnapshot, signals, indexType, loadData, detailVisible, currSignal, showSignalDetail, renderDetailChart, stockInfo, currIndicator, addToFav, refreshChart };
    }
</script>
{% endblock %}