{% extends 'base.html' %}
{% block title %}å¸‚åœºå…¨æ™¯é©¾é©¶èˆ±{% endblock %}

{% block content %}
<el-row :gutter="20">
    <el-col :span="24">
        <el-card>
            <template #header>
                <div style="display:flex; justify-content:space-between">
                    <span>ğŸ“Š æ ¸å¿ƒæŒ‡æ•°è¶‹åŠ¿ (å¤šæŒ‡æ ‡èåˆç‰ˆ)</span>
                    <el-select v-model="indexType" size="small" @change="loadData"><el-option label="ä¸Šè¯" value="000001.SH"></el-option></el-select>
                </div>
            </template>
            <div id="main-chart" style="height:550px"></div>
        </el-card>
    </el-col>
</el-row>
{% endblock %}

{% block scripts %}
<script>
function pageSetup() {
    const { ref, onMounted } = Vue;
    const indexType = ref('000001.SH');
    let chart = null;

    const init = async () => {
        const res = await axios.get(`/api/dashboard/data/?type=${indexType.value}`);
        if(res.data.code===200) renderChart(res.data.data.index_data);
    };

    // ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šå¤šè½´èåˆ + å›¾ä¾‹æ§åˆ¶
    const renderChart = (d) => {
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('main-chart'));

        const ind = d.indicators;
        chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            // ğŸ”¥ å›¾ä¾‹æ§åˆ¶ï¼šç”¨æˆ·ç‚¹å‡»å³å¯åˆ‡æ¢æ˜¾ç¤º/éšè—
            legend: {
                data: ['Kçº¿', 'MA5', 'MA20', 'æˆäº¤é‡', 'MACD', 'DIF', 'DEA', 'K', 'D', 'J', 'RSI'],
                selected: { 'K':false, 'D':false, 'J':false, 'RSI':false } // é»˜è®¤éšè—éƒ¨åˆ†
            },
            // ğŸ”¥ ä¸¤ä¸ª Gridï¼šä¸»å›¾(Kçº¿)+å‰¯å›¾(æŒ‡æ ‡èåˆ)
            grid: [
                { left: '5%', right: '5%', height: '55%' },
                { left: '5%', right: '5%', top: '70%', height: '20%' }
            ],
            xAxis: [
                { type: 'category', data: d.dates, scale: true, boundaryGap: false },
                { type: 'category', gridIndex: 1, data: d.dates, show: false }
            ],
            yAxis: [
                { scale: true, splitArea: { show: true } }, // ä¸»å›¾ Y è½´
                { gridIndex: 1, splitNumber: 3 }, // å‰¯å›¾ Y è½´ (MACD/KDJ/RSI å…±ç”¨)
            ],
            dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], bottom: 0 }],
            series: [
                { name: 'Kçº¿', type: 'candlestick', data: d.values.map(v=>[v[0],v[1],v[2],v[3]]), itemStyle: { color: '#ef232a', color0: '#14b143' } },
                { name: 'MA5', type: 'line', data: ind.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                { name: 'MA20', type: 'line', data: ind.MA20, smooth: true, lineStyle: { opacity: 0.5 } },

                // ä¸‹æ–¹æŒ‡æ ‡åŒº (å…¨éƒ¨æ”¾åœ¨ xAxisIndex: 1, yAxisIndex: 1)
                { name: 'MACD', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: ind.MACD, itemStyle: { color: p=>p.value>0?'#ef232a':'#14b143' } },
                { name: 'DIF', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: ind.DIF, symbol: 'none' },
                { name: 'DEA', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: ind.DEA, symbol: 'none' },

                { name: 'K', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: ind.K, symbol: 'none' },
                { name: 'D', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: ind.D, symbol: 'none' },
                { name: 'J', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: ind.J, symbol: 'none' },

                { name: 'RSI', type: 'line', xAxisIndex: 1, yAxisIndex: 1, data: ind.RSI, symbol: 'none' }
            ]
        });
    };

    onMounted(init);
    return { indexType, loadData: init };
}
</script>
{% endblock %}