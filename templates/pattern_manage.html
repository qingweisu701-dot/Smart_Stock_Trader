{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}
{% block content %}
<el-row :gutter="20">
    <el-col :span="14">
        <el-card header="ğŸ“ å½¢æ€ç»˜åˆ¶æ¿">
            <div id="draw-chart" style="height:400px; width:100%;"></div>
            <div style="margin-top:15px; text-align:center">
                <el-button @click="clearDraw">æ¸…ç©ºé‡ç”»</el-button>
                <el-button type="primary" @click="saveDialogVisible=true">ä¿å­˜å½¢æ€åˆ°åº“</el-button>
            </div>
        </el-card>
    </el-col>
    <el-col :span="10">
        <el-card header="ğŸ“š å½¢æ€æ¸…å•">
            <el-tabs>
                <el-tab-pane label="ç³»ç»Ÿé¢„è®¾ (ä¸“ä¸š)">
                    <div v-for="p in presets" :key="p.id" class="pattern-item" @click="loadPattern(p.data)">
                        <b>[[p.name]]</b>
                        <el-tag size="small" :type="p.type==='BUY'?'danger':'success'">[[p.type==='BUY'?'çœ‹æ¶¨':'çœ‹è·Œ']]</el-tag>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="æˆ‘çš„æ‰‹ç»˜">
                    <div v-for="p in userPatterns" :key="p.id" class="pattern-item" @click="loadPattern(p.data)">
                        [[p.name]] <span style="font-size:12px;color:#999">[[p.desc]]</span>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialogVisible" title="ä¿å­˜å½¢æ€">
    <el-input v-model="newPatternName" placeholder="å½¢æ€åç§° (å¦‚: æˆ‘çš„Vå‹åº•)"></el-input>
    <el-input v-model="newPatternDesc" placeholder="æè¿° (å¯é€‰)" style="margin-top:10px"></el-input>
    <template #footer><el-button type="primary" @click="savePattern">ç¡®å®šä¿å­˜</el-button></template>
</el-dialog>

<style>.pattern-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; } .pattern-item:hover { background: #f5f7fa; }</style>

<script>
function pageSetup() {
    const activeMenu = ref('1');
    const presets = ref([]);
    const userPatterns = ref([]);
    const saveDialogVisible = ref(false);
    const newPatternName = ref('');
    const newPatternDesc = ref('');

    let myChart = null;
    let drawData = []; // [[x, y], ...]
    let isDrawing = false;

    // ECharts åˆå§‹åŒ–ä¸ç»˜å›¾é€»è¾‘
    const initChart = () => {
        myChart = echarts.init(document.getElementById('draw-chart'));
        // ... (æ­¤å¤„å¤ç”¨ä¹‹å‰ kline_chart.html çš„ç»˜å›¾é€»è¾‘ï¼Œç®€åŒ–å±•ç¤º)
        const option = {
            grid: {top:20, bottom:20},
            xAxis: {type: 'value', min:0, max:100, show:false},
            yAxis: {type: 'value', min:0, max:100, show:false},
            series: [{ type: 'line', data: [], smooth: 0.3, symbol: 'none' }]
        };
        myChart.setOption(option);

        const zr = myChart.getZr();
        zr.on('mousedown', () => { isDrawing=true; drawData=[]; });
        zr.on('mousemove', (e) => {
            if(!isDrawing) return;
            const pt = myChart.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]);
            drawData.push(pt);
            myChart.setOption({series:[{data: drawData}]});
        });
        zr.on('mouseup', () => isDrawing=false);
    };

    const loadList = async () => {
        const res = await axios.get('/api/pattern/list/');
        presets.value = res.data.data.presets;
        userPatterns.value = res.data.data.users;
    };

    const loadPattern = (dataArr) => {
        // å°†ä¸€ç»´ Y è½´æ•°ç»„è½¬æ¢ä¸º [[x,y]] æ ¼å¼æ˜¾ç¤º
        const showData = dataArr.map((y, i) => [i * (100/(dataArr.length-1)), y * 10]); // ç®€å•ç¼©æ”¾
        myChart.setOption({series:[{data: showData}]});
        drawData = showData; // å­˜ä¸‹æ¥ç”¨äºåŒ¹é…æˆ–ä¿å­˜
    };

    const savePattern = async () => {
        // æå– Y è½´æ•°æ®å¹¶å½’ä¸€åŒ–
        const yData = drawData.map(p => p[1]);
        await axios.post('/api/pattern/save/', { name: newPatternName.value, desc: newPatternDesc.value, data: yData });
        saveDialogVisible.value = false;
        loadList();
    };

    const clearDraw = () => { drawData=[]; myChart.setOption({series:[{data:[]}]}); };

    onMounted(() => { initChart(); loadList(); });
    return { activeMenu, presets, userPatterns, saveDialogVisible, newPatternName, newPatternDesc, loadPattern, savePattern, clearDraw };
}
</script>
{% endblock %}