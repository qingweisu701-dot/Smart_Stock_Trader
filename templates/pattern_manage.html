{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}

{% block content %}
<el-row :gutter="20" style="height: calc(100vh - 100px);">

    <el-col :span="14" style="height:100%">
        <el-card style="height:100%; display:flex; flex-direction:column">
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <el-radio-group v-model="drawMode" size="small">
                        <el-radio-button label="mouse">ğŸ–Œï¸ é¼ æ ‡æ‰‹ç»˜</el-radio-button>
                        <el-radio-button label="kline">ğŸ§± Kçº¿ç²¾è°ƒ</el-radio-button>
                    </el-radio-group>
                    <div>
                        <el-button v-if="drawMode==='mouse'" size="small" type="warning" plain @click="convertToKline">è½¬ä¸ºKçº¿ç²¾è°ƒ â¡ï¸</el-button>
                        <el-button type="primary" size="small" icon="Check" @click="prepareSave">ä¿å­˜å½¢æ€</el-button>
                    </div>
                </div>
            </template>

            <div v-show="drawMode==='mouse'" style="flex:1; display:flex; flex-direction:column">
                <div class="tip-box">ğŸ’¡ åœ¨ä¸‹æ–¹åŒºåŸŸæŒ‰ä½å·¦é”®ç»˜åˆ¶è¶‹åŠ¿ï¼Œç”»å®Œåå¯â€œè½¬ä¸ºKçº¿â€è¿›è¡Œç»†èŠ‚è°ƒæ•´</div>
                <div id="draw-canvas" style="flex:1; border:1px dashed #ccc; min-height:300px"></div>
                <div style="text-align:right; margin-top:10px">
                    <el-button size="small" icon="Delete" @click="clearDraw">æ¸…ç©ºç”»å¸ƒ</el-button>
                </div>
            </div>

            <div v-show="drawMode==='kline'" style="flex:1; display:flex; flex-direction:column; overflow-y:auto">
                <div id="kline-editor" style="height:350px; width:100%"></div>

                <div class="control-panel">
                    <div style="margin-bottom:10px">
                        <el-button-group>
                            <el-button size="small" type="success" icon="Plus" @click="addCandle">åŠ ä¸€æ ¹</el-button>
                            <el-button size="small" type="danger" icon="Minus" @click="removeCandle">åˆ æœ«å°¾</el-button>
                        </el-button-group>
                        <span style="margin-left:10px; font-size:12px; color:#666" v-if="selectedIdx===null">ğŸ‘ˆ ç‚¹å‡»ä¸Šæ–¹Kçº¿æŸ±ä½“å¯æ‹–åŠ¨å‚æ•°</span>
                    </div>

                    <div v-if="selectedIdx !== null" class="slider-box">
                        <div style="font-weight:bold; margin-bottom:5px; color:#409EFF">æ­£åœ¨è°ƒæ•´ç¬¬ [[selectedIdx+1]] æ ¹</div>
                        <el-row :gutter="20">
                            <el-col :span="12">
                                <div class="s-row"><span>é«˜ High</span><el-slider v-model="currentCandle.high" :max="100" size="small" @input="updateChart"/></div>
                                <div class="s-row"><span>ä½ Low</span><el-slider v-model="currentCandle.low" :max="100" size="small" @input="updateChart"/></div>
                            </el-col>
                            <el-col :span="12">
                                <div class="s-row"><span>æ”¶ Close</span><el-slider v-model="currentCandle.close" :max="100" size="small" @input="updateChart"/></div>
                                <div class="s-row"><span>å¼€ Open</span><el-slider v-model="currentCandle.open" :max="100" size="small" @input="updateChart"/></div>
                            </el-col>
                        </el-row>
                    </div>
                </div>
            </div>
        </el-card>
    </el-col>

    <el-col :span="10" style="height:100%">
        <el-card style="height:100%; overflow-y:auto">
            <template #header>ğŸ“š å½¢æ€æ¸…å•</template>
            <el-tabs>
                <el-tab-pane label="ç»å…¸å½¢æ€">
                    <div v-for="p in list.presets" :key="p.id" class="p-item" @click="loadP(p)">
                        <el-tag size="small" :type="p.type==='BUY'?'danger':'success'">[[p.type]]</el-tag>
                        <span style="margin-left:8px; font-weight:bold">[[p.name]]</span>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="æˆ‘çš„æ”¶è—/æ‰‹ç»˜">
                    <div v-if="list.users.length===0" style="text-align:center; color:#999; margin-top:20px">æš‚æ— æ•°æ®</div>
                    <div v-for="p in list.users" :key="p.id" class="p-item" @click="loadP(p)">
                        <el-tag size="small" type="info">è‡ª</el-tag>
                        <span style="margin-left:8px">[[p.name]]</span>
                        <el-button type="text" size="small" style="float:right; color:#F56C6C" @click.stop="deletePattern(p.id)">åˆ é™¤</el-button>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="ğŸ¤– æ™ºèƒ½ä¿å­˜" width="30%">
    <div v-if="aiTrend" :class="aiTrend==='BUY'?'ai-box-buy':'ai-box-sell'">
        <el-icon><Cpu /></el-icon> AI è¯†åˆ«è¶‹åŠ¿ï¼š<b>[[ aiTrend==='BUY' ? 'çœ‹æ¶¨ (å»ºè®®ä¹°å…¥)' : 'çœ‹è·Œ (å»ºè®®å–å‡º)' ]]</b>
    </div>
    <el-form label-position="top" style="margin-top:15px">
        <el-form-item label="å½¢æ€åç§°"><el-input v-model="saveDialog.name"></el-input></el-form-item>
        <el-form-item label="ä¿¡å·ç±»å‹">
            <el-radio-group v-model="saveDialog.desc">
                <el-radio label="BUY">ä¹°å…¥ä¿¡å·</el-radio>
                <el-radio label="SELL">å–å‡ºä¿¡å·</el-radio>
            </el-radio-group>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="doSave">ç¡®è®¤ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .tip-box { background: #e6f7ff; color: #1890ff; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 10px; }
    .p-item { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
    .p-item:hover { background: #f9f9f9; }
    .control-panel { margin-top: 15px; padding: 10px; background: #f5f7fa; border-radius: 4px; }
    .slider-box { border-top: 1px solid #eee; padding-top: 10px; margin-top: 5px; }
    .s-row { display: flex; align-items: center; margin-bottom: 5px; }
    .s-row span { width: 60px; font-size: 12px; color: #666; }
    .ai-box-buy { background: #f0f9eb; color: #67c23a; padding: 10px; border-radius: 4px; }
    .ai-box-sell { background: #fef0f0; color: #f56c6c; padding: 10px; border-radius: 4px; }
</style>

<script>
function pageSetup() {
    const activeMenu = ref('1');
    const drawMode = ref('mouse');
    const list = ref({presets:[], users:[]});
    const saveDialog = ref({visible:false, name:'', desc:'BUY'});
    const aiTrend = ref('');

    // æ•°æ®
    const klineData = ref([{open:40, close:60, low:30, high:70}, {open:60, close:50, low:45, high:65}]);
    const selectedIdx = ref(null);
    const currentCandle = ref({open:0, close:0, low:0, high:0});
    let drawPoints = [];
    let isDrawing = false;
    let chart1=null, chart2=null;

    const initCharts = () => {
        chart1 = echarts.init(document.getElementById('draw-canvas'));
        chart2 = echarts.init(document.getElementById('kline-editor'));

        // æ‰‹ç»˜é€»è¾‘
        chart1.getZr().on('mousedown', () => { isDrawing=true; drawPoints=[]; });
        chart1.getZr().on('mousemove', e => {
            if(!isDrawing) return;
            const pt = chart1.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]);
            if(pt) { drawPoints.push(pt[1]); renderDraw(); }
        });
        chart1.getZr().on('mouseup', () => isDrawing=false);

        // Kçº¿ç‚¹å‡»é€»è¾‘
        chart2.on('click', 'series.candlestick', params => {
            selectedIdx.value = params.dataIndex;
            currentCandle.value = {...klineData.value[params.dataIndex]};
        });

        renderDraw();
        renderKline();
    };

    const renderDraw = () => {
        chart1.setOption({
            grid: {top:10, bottom:10}, xAxis: {show:false, type:'category', data:drawPoints.map((_,i)=>i)},
            yAxis: {min:0, max:100, show:false},
            series: [{type:'line', data:drawPoints, showSymbol:false, smooth:0.3, lineStyle:{width:3}}]
        });
    };

    const renderKline = () => {
        const d = klineData.value.map(k => [k.open, k.close, k.low, k.high]);
        chart2.setOption({
            tooltip: {trigger:'axis'}, xAxis: {data:klineData.value.map((_,i)=>i+1)}, yAxis: {scale:true, min:0, max:100},
            series: [{
                type:'candlestick', data:d,
                itemStyle: {color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'},
                select: {itemStyle: {borderColor:'#E6A23C', borderWidth:3}}, selectedMode: 'single'
            }]
        });
        if(selectedIdx.value!==null) chart2.dispatchAction({type:'select', seriesIndex:0, dataIndex:selectedIdx.value});
    };

    const updateChart = () => {
        if(selectedIdx.value!==null) { klineData.value[selectedIdx.value] = {...currentCandle.value}; renderKline(); }
    };

    const convertToKline = () => {
        if(drawPoints.length<5) return ElementPlus.ElMessage.warning('ç»˜åˆ¶å¤ªçŸ­');
        const step = Math.floor(drawPoints.length/6);
        const newK = [];
        for(let i=0; i<6; i++) {
            const seg = drawPoints.slice(i*step, (i+1)*step);
            newK.push({open:seg[0], close:seg[seg.length-1], high:Math.max(...seg), low:Math.min(...seg)});
        }
        klineData.value = newK;
        drawMode.value = 'kline';
        setTimeout(renderKline, 100);
    };

    const loadList = async () => {
        const res = await axios.get('/api/pattern/list/');
        list.value = res.data.data;
    };

    const loadP = (p) => {
        if(drawMode.value === 'mouse') {
            drawPoints = Array.isArray(p.data[0]) ? p.data.map(k=>k.close||k[1]) : p.data;
            renderDraw();
        } else {
            if(!Array.isArray(p.data) || typeof p.data[0]==='number') return ElementPlus.ElMessage.warning('æ­¤ä¸ºçº¯è¶‹åŠ¿æ•°æ®ï¼Œè¯·åˆ‡æ¢åˆ°é¼ æ ‡æ‰‹ç»˜æ¨¡å¼æŸ¥çœ‹');
            klineData.value = p.data;
            renderKline();
        }
    };

    const prepareSave = async () => {
        const type = drawMode.value==='mouse'?'DRAW':'KLINE';
        const data = type==='DRAW'?drawPoints:klineData.value;
        const res = await axios.post('/api/pattern/analyze/', {type, data});
        aiTrend.value = res.data.data.trend;
        saveDialog.value.desc = aiTrend.value==='SELL'?'SELL':'BUY';
        saveDialog.value.visible = true;
    };

    const doSave = async () => {
        if(!saveDialog.value.name) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥åç§°');
        await axios.post('/api/pattern/save/', {
            name: saveDialog.value.name, desc: saveDialog.value.desc,
            type: drawMode.value==='mouse'?'DRAW':'KLINE',
            data: drawMode.value==='mouse'?drawPoints:klineData.value
        });
        saveDialog.value.visible = false;
        loadList();
        ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸ');
    };

    onMounted(() => { setTimeout(initCharts, 200); loadList(); });
    // ç®€å•å®ç° add/remove/clear
    const addCandle = () => { klineData.value.push({open:50,close:50,high:60,low:40}); renderKline(); };
    const removeCandle = () => { klineData.value.pop(); selectedIdx.value=null; renderKline(); };
    const clearDraw = () => { drawPoints=[]; renderDraw(); };
    const deletePattern = (id) => { /* ç•¥ï¼Œæš‚æœªå®ç°åç«¯åˆ é™¤æ¥å£ï¼Œå¯é¢„ç•™ */ };

    return { activeMenu, drawMode, list, klineData, selectedIdx, currentCandle, saveDialog, aiTrend, updateChart, convertToKline, loadP, prepareSave, doSave, addCandle, removeCandle, clearDraw, deletePattern };
}
</script>
{% endblock %}