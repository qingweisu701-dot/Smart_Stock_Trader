{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}
{% block content %}
<el-row :gutter="20">
    <el-col :span="10">
        <el-card>
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span>ğŸ–Œï¸ è¶‹åŠ¿çº¿æ‰‹ç»˜ (å®è§‚)</span>
                    <div>
                        <el-button size="small" type="danger" icon="Delete" @click="clearDraw" plain>é‡ç”»</el-button>
                        <el-button size="small" type="primary" @click="openSaveDialog('DRAW')">ä¿å­˜è¶‹åŠ¿</el-button>
                    </div>
                </div>
            </template>
            <div class="tip-box">æŒ‰ä½é¼ æ ‡å·¦é”®ç»˜åˆ¶ä»·æ ¼èµ°åŠ¿æ›²çº¿</div>
            <div id="draw-canvas" style="height:400px; border:1px solid #eee; cursor:crosshair"></div>
        </el-card>
    </el-col>

    <el-col :span="14">
        <el-card>
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span>ğŸ§± Kçº¿å½¢æ€æ„é€  (å¾®è§‚)</span>
                    <div>
                        <el-button size="small" type="success" @click="addCandle">â• åŠ ä¸€æ ¹</el-button>
                        <el-button size="small" type="danger" @click="removeCandle">â– åˆ ä¸€æ ¹</el-button>
                        <el-button size="small" type="primary" @click="openSaveDialog('KLINE')">ä¿å­˜Kçº¿</el-button>
                    </div>
                </div>
            </template>

            <el-row :gutter="10">
                <el-col :span="16">
                    <div id="kline-builder" style="height:350px;"></div>
                </el-col>
                <el-col :span="8" style="background:#f9f9f9; padding:10px; border-radius:4px">
                    <div v-if="selectedCandleIndex !== null">
                        <div style="font-weight:bold; margin-bottom:10px; text-align:center">
                            ç¼–è¾‘ç¬¬ <span style="color:red">[[ selectedCandleIndex + 1 ]]</span> æ ¹Kçº¿
                        </div>

                        <div class="slider-group">
                            <span class="label">æœ€é«˜ä»· (High)</span>
                            <el-slider v-model="currentCandle.high" :min="0" :max="100" @input="updateKLine"></el-slider>
                        </div>
                        <div class="slider-group">
                            <span class="label">å¼€ç›˜ä»· (Open)</span>
                            <el-slider v-model="currentCandle.open" :min="0" :max="100" @input="updateKLine"></el-slider>
                        </div>
                        <div class="slider-group">
                            <span class="label">æ”¶ç›˜ä»· (Close)</span>
                            <el-slider v-model="currentCandle.close" :min="0" :max="100" @input="updateKLine"></el-slider>
                        </div>
                        <div class="slider-group">
                            <span class="label">æœ€ä½ä»· (Low)</span>
                            <el-slider v-model="currentCandle.low" :min="0" :max="100" @input="updateKLine"></el-slider>
                        </div>
                    </div>
                    <div v-else style="color:#999; text-align:center; padding-top:100px">
                        è¯·ç‚¹å‡»å·¦ä¾§å›¾è¡¨ä¸­çš„<br>Kçº¿æŸ±ä½“è¿›è¡Œç¼–è¾‘
                    </div>
                </el-col>
            </el-row>

            <el-table :data="klineData" size="small" border style="margin-top:10px" height="150">
                <el-table-column label="åºå·" type="index" width="50"></el-table-column>
                <el-table-column label="å¼€ç›˜"><template #default="s"><el-input-number v-model="s.row.open" size="small" :controls="false" @change="updateKLine"/></template></el-table-column>
                <el-table-column label="æ”¶ç›˜"><template #default="s"><el-input-number v-model="s.row.close" size="small" :controls="false" @change="updateKLine"/></template></el-table-column>
                <el-table-column label="æœ€é«˜"><template #default="s"><el-input-number v-model="s.row.high" size="small" :controls="false" @change="updateKLine"/></template></el-table-column>
                <el-table-column label="æœ€ä½"><template #default="s"><el-input-number v-model="s.row.low" size="small" :controls="false" @change="updateKLine"/></template></el-table-column>
            </el-table>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="ä¿å­˜è‡ªå®šä¹‰å½¢æ€" width="30%">
    <el-form label-width="80px">
        <el-form-item label="åç§°">
            <el-input v-model="saveDialog.name" placeholder="å¦‚: ä¹Œäº‘ç›–é¡¶å˜ä½“"></el-input>
        </el-form-item>
        <el-form-item label="æ–¹å‘">
             <el-radio-group v-model="saveDialog.desc">
                 <el-radio label="çœ‹æ¶¨(Buy)">ğŸ”´ çœ‹æ¶¨</el-radio>
                 <el-radio label="çœ‹è·Œ(Sell)">ğŸŸ¢ çœ‹è·Œ</el-radio>
             </el-radio-group>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="submitSave">ä¿å­˜</el-button></template>
</el-dialog>

<style>
    .slider-group { margin-bottom: 10px; }
    .slider-group .label { font-size: 12px; color: #666; display: block; margin-bottom: -5px; }
    .tip-box { background: #f0f9eb; color: #67c23a; padding: 5px 10px; font-size: 12px; border-radius: 3px; margin-bottom: 10px; }
</style>

<script>
function pageSetup() {
    const activeMenu = ref('1');
    const drawChart = ref(null);
    const klineChart = ref(null);

    // é¼ æ ‡ç»˜å›¾æ•°æ®
    let lineData = [];
    let isDrawing = false;

    // Kçº¿æ„é€ æ•°æ® (é»˜è®¤ç»™ä¸€ä¸ªé˜³çº¿ä¸€ä¸ªé˜´çº¿)
    const klineData = ref([
        { open: 20, close: 50, high: 60, low: 10 },
        { open: 55, close: 35, high: 65, low: 30 }
    ]);
    const selectedCandleIndex = ref(null);
    const currentCandle = ref({}); // å½“å‰æ­£åœ¨ç¼–è¾‘çš„Kçº¿æ•°æ®å‰¯æœ¬

    const saveDialog = ref({ visible: false, type: '', name: '', desc: 'çœ‹æ¶¨(Buy)' });

    // åˆå§‹åŒ–å›¾è¡¨
    onMounted(() => {
        initDrawChart();
        initKlineChart();
    });

    const initDrawChart = () => {
        const myChart = echarts.init(document.getElementById('draw-canvas'));
        drawChart.value = myChart;
        myChart.setOption({
            grid: { top: 10, bottom: 10, left: 10, right: 10 },
            xAxis: { type: 'value', show: false, min: 0, max: 100 },
            yAxis: { type: 'value', show: false, min: 0, max: 100 },
            series: [{ type: 'line', data: [], smooth: 0.3, showSymbol: false, lineStyle: {width: 3, color: '#409EFF'} }]
        });

        const zr = myChart.getZr();
        zr.on('mousedown', () => { isDrawing = true; lineData = []; });
        zr.on('mousemove', (e) => {
            if (!isDrawing) return;
            const pt = myChart.convertFromPixel({ seriesIndex: 0 }, [e.offsetX, e.offsetY]);
            lineData.push(pt);
            myChart.setOption({ series: [{ data: lineData }] });
        });
        zr.on('mouseup', () => isDrawing = false);
    };

    const initKlineChart = () => {
        const myChart = echarts.init(document.getElementById('kline-builder'));
        klineChart.value = myChart;

        myChart.on('click', 'series.candlestick', (params) => {
            // ç‚¹å‡»Kçº¿ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡å¼
            selectedCandleIndex.value = params.dataIndex;
            // ç»‘å®šå½“å‰æ•°æ®åˆ°æ»‘å—å¯¹è±¡ (æ·±åº¦æ‹·è´)
            currentCandle.value = { ...klineData.value[params.dataIndex] };
        });

        renderKline();
    };

    const renderKline = () => {
        // è½¬æ¢æ•°æ®æ ¼å¼ç»™ ECharts [Open, Close, Low, High]
        const echartsData = klineData.value.map(item => [item.open, item.close, item.low, item.high]);

        klineChart.value.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            grid: { top: 20, bottom: 20, left: 30, right: 30 },
            xAxis: { data: klineData.value.map((_, i) => i + 1) },
            yAxis: { scale: true, min: 0, max: 100 },
            series: [{
                type: 'candlestick',
                data: echartsData,
                itemStyle: {
                    color: '#ef232a', // é˜³çº¿çº¢
                    color0: '#14b143', // é˜´çº¿ç»¿
                    borderColor: '#ef232a',
                    borderColor0: '#14b143'
                },
                // é«˜äº®é€‰ä¸­çŠ¶æ€
                select: { itemStyle: { borderColor: '#E6A23C', borderWidth: 2 } },
                selectedMode: 'single'
            }]
        });

        // ä¿æŒé€‰ä¸­çŠ¶æ€
        if (selectedCandleIndex.value !== null) {
            klineChart.value.dispatchAction({
                type: 'select',
                seriesIndex: 0,
                dataIndex: selectedCandleIndex.value
            });
        }
    };

    // æ»‘å—æ‹–åŠ¨å›è°ƒ
    const updateKLine = () => {
        if (selectedCandleIndex.value !== null) {
            // å°†æ»‘å—çš„å€¼åŒæ­¥å›æ•°æ®æº
            klineData.value[selectedCandleIndex.value] = { ...currentCandle.value };
            renderKline();
        }
    };

    const addCandle = () => {
        klineData.value.push({ open: 50, close: 50, high: 60, low: 40 });
        renderKline();
    };

    const removeCandle = () => {
        if (klineData.value.length > 1) {
            klineData.value.pop();
            selectedCandleIndex.value = null;
            renderKline();
        }
    };

    const clearDraw = () => {
        lineData = [];
        drawChart.value.setOption({ series: [{ data: [] }] });
    };

    const openSaveDialog = (type) => {
        saveDialog.value.type = type;
        saveDialog.value.visible = true;
    };

    const submitSave = async () => {
        let payload = {};
        if (saveDialog.value.type === 'DRAW') {
            if (lineData.length < 5) return ElementPlus.ElMessage.warning('ç»˜åˆ¶æ•°æ®å¤ªå°‘');
            // åªå–Yè½´æ•°æ®ï¼Œå½’ä¸€åŒ–
            const yData = lineData.map(p => p[1]);
            payload = { type: 'DRAW', name: saveDialog.value.name, desc: saveDialog.value.desc, data: yData };
        } else {
            // ä¿å­˜Kçº¿åºåˆ—
            payload = { type: 'KLINE', name: saveDialog.value.name, desc: saveDialog.value.desc, data: klineData.value };
        }

        try {
            await axios.post('/api/pattern/save/', payload);
            ElementPlus.ElMessage.success('å½¢æ€ä¿å­˜æˆåŠŸï¼Œå¯å‰å¾€åˆ†æé¡µé¢ä½¿ç”¨');
            saveDialog.value.visible = false;
        } catch (e) {
            ElementPlus.ElMessage.error('ä¿å­˜å¤±è´¥');
        }
    };

    return { activeMenu, drawChart, klineData, selectedCandleIndex, currentCandle, updateKLine, addCandle, removeCandle, clearDraw, openSaveDialog, saveDialog, submitSave };
}
</script>
{% endblock %}