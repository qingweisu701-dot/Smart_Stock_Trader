{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}

{% block content %}
<el-row :gutter="20">
    <el-col :span="16">
        <el-card>
            <template #header>
                <el-radio-group v-model="drawMode" size="small">
                    <el-radio-button label="mouse">ğŸ–±ï¸ é¼ æ ‡æ‰‹ç»˜</el-radio-button>
                    <el-radio-button label="block">ğŸ§± ç§¯æœ¨æ„é€ </el-radio-button>
                </el-radio-group>
                <div style="float:right">
                    <el-button v-if="drawMode==='mouse'" size="small" type="danger" plain @click="clearDraw">æ¸…ç©ºç”»å¸ƒ</el-button>
                    <el-button type="primary" size="small" @click="saveDialog.visible=true">ä¿å­˜å½¢æ€</el-button>
                </div>
            </template>

            <div v-show="drawMode==='mouse'">
                <div class="tip-box">ğŸ’¡ æŒ‰ä½é¼ æ ‡å·¦é”®åœ¨åŒºåŸŸå†…ç»˜åˆ¶ï¼Œæ¨¡æ‹ŸKçº¿èµ°åŠ¿æ›²çº¿</div>
                <div id="draw-chart" style="height:400px; border:1px dashed #ccc"></div>
            </div>

            <div v-show="drawMode==='block'" style="height:400px; padding:20px; overflow-y:auto">
                <div class="tip-box">ğŸ’¡ ç‚¹å‡»ä¸‹æ–¹â€œæ·»åŠ â€æŒ‰é’®å¢åŠ Kçº¿ï¼Œç‚¹å‡»å›¾è¡¨ä¸­Kçº¿æŸ±ä½“å¯è°ƒæ•´æ•°å€¼</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px">
                    <el-tag v-for="(val, idx) in klineData" :key="idx" closable @close="removeCandle(idx)" size="large" effect="dark">
                        ç¬¬[[idx+1]]æ ¹
                    </el-tag>
                    <el-button size="small" type="success" @click="addCandle" circle icon="Plus"></el-button>
                </div>

                <div id="block-preview" style="height:250px;"></div>

                <div v-if="selectedCandleIndex !== null" style="background:#f5f7fa; padding:15px; margin-top:10px; border-radius:4px;">
                    <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        æ­£åœ¨ç¼–è¾‘ï¼šç¬¬ <span style="color:#409EFF; font-size:16px;">[[ selectedCandleIndex+1 ]]</span> æ ¹Kçº¿
                    </div>
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <div class="slider-group">
                                <span class="label">æœ€é«˜ä»· (High)</span>
                                <el-slider v-model="currentCandle.high" :min="0" :max="100" @input="updateKLine"></el-slider>
                            </div>
                            <div class="slider-group">
                                <span class="label">å¼€ç›˜ä»· (Open)</span>
                                <el-slider v-model="currentCandle.open" :min="0" :max="100" @input="updateKLine"></el-slider>
                            </div>
                        </el-col>
                        <el-col :span="12">
                            <div class="slider-group">
                                <span class="label">æ”¶ç›˜ä»· (Close)</span>
                                <el-slider v-model="currentCandle.close" :min="0" :max="100" @input="updateKLine"></el-slider>
                            </div>
                            <div class="slider-group">
                                <span class="label">æœ€ä½ä»· (Low)</span>
                                <el-slider v-model="currentCandle.low" :min="0" :max="100" @input="updateKLine"></el-slider>
                            </div>
                        </el-col>
                    </el-row>
                </div>
                <div v-else style="color:#999; text-align:center; padding:30px 0;">
                    ğŸ‘ˆ ç‚¹å‡»ä¸Šæ–¹å›¾è¡¨ä¸­çš„ Kçº¿æŸ±ä½“ å¼€å§‹å¾®è°ƒ
                </div>
            </div>
        </el-card>
    </el-col>

    <el-col :span="8">
        <el-card header="ğŸ“š å½¢æ€åº“ (ç‚¹å‡»åŠ è½½)">
            <el-tabs>
                <el-tab-pane label="ç»å…¸å½¢æ€">
                    <div style="max-height: 500px; overflow-y: auto;">
                        <div v-for="p in list.presets" :key="p.id" class="p-item" @click="loadP(p)">
                            <el-tag size="small" :type="p.type==='BUY'?'danger':'success'" effect="dark">
                                [[p.type==='BUY'?'ä¹°':'å–']]
                            </el-tag>
                            <span style="font-weight:bold; margin-left:5px">[[p.name]]</span>
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="æˆ‘çš„æ‰‹ç»˜">
                     <div v-if="list.users.length === 0" style="color:#999; padding:20px; text-align:center">æš‚æ— ä¿å­˜çš„å½¢æ€</div>
                     <div v-for="p in list.users" :key="p.id" class="p-item" @click="loadP(p)">
                        <el-tag size="small" type="info">è‡ª</el-tag> [[p.name]]
                     </div>
                </el-tab-pane>
            </el-tabs>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="ä¿å­˜è‡ªå®šä¹‰å½¢æ€" width="30%">
    <el-form label-position="top">
        <el-form-item label="å½¢æ€åç§°">
            <el-input v-model="saveDialog.name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„åŒåº•ç­–ç•¥"></el-input>
        </el-form-item>
        <el-form-item label="å½¢æ€å«ä¹‰">
             <el-radio-group v-model="saveDialog.desc">
                 <el-radio label="çœ‹æ¶¨(Buy)" border>ğŸ”´ çœ‹æ¶¨ä¿¡å·</el-radio>
                 <el-radio label="çœ‹è·Œ(Sell)" border>ğŸŸ¢ çœ‹è·Œä¿¡å·</el-radio>
             </el-radio-group>
        </el-form-item>
    </el-form>
    <template #footer>
        <el-button @click="saveDialog.visible=false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="doSave">ç¡®è®¤ä¿å­˜</el-button>
    </template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .p-item { padding:10px; cursor:pointer; border-bottom:1px solid #eee; transition: background 0.3s; }
    .p-item:hover { background:#f0f9eb; }
    .slider-group { margin-bottom: 5px; }
    .slider-group .label { font-size: 12px; color: #909399; }
    .tip-box { background: #fdf6ec; color: #e6a23c; padding: 8px 12px; font-size: 13px; border-radius: 4px; margin-bottom: 15px; border: 1px solid #faecd8; }
</style>

<script>
function pageSetup() {
    const activeMenu = ref('1');
    const drawMode = ref('mouse');
    const list = ref({presets:[], users:[]});

    // Kçº¿æ„é€ æ•°æ®
    const klineData = ref([{ open: 40, close: 60, high: 70, low: 30 }, { open: 60, close: 50, high: 65, low: 45 }]);
    const selectedCandleIndex = ref(null);
    const currentCandle = ref({ open:0, close:0, high:0, low:0 });

    const saveDialog = ref({ visible: false, name: '', desc: 'çœ‹æ¶¨(Buy)' });

    let chart1 = null, chart2 = null;
    let drawData = [];
    let isDown = false;

    const initCharts = () => {
        chart1 = echarts.init(document.getElementById('draw-chart'));
        chart2 = echarts.init(document.getElementById('block-preview'));

        // é¼ æ ‡ç»˜å›¾
        const zr = chart1.getZr();
        zr.on('mousedown', () => { isDown=true; drawData=[]; });
        zr.on('mousemove', (e) => {
            if(!isDown) return;
            const pt = chart1.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]);
            if(pt) {
                drawData.push(pt[1]); // åªå­˜Yè½´
                updateChart1();
            }
        });
        zr.on('mouseup', () => isDown=false);

        // Kçº¿ç‚¹å‡»äº‹ä»¶
        chart2.on('click', 'series.candlestick', (params) => {
            selectedCandleIndex.value = params.dataIndex;
            // æ·±åº¦æ‹·è´ï¼Œé˜²æ­¢è”åŠ¨å¤ªå¿«
            currentCandle.value = JSON.parse(JSON.stringify(klineData.value[params.dataIndex]));
        });

        updateChart1();
        updateChart2();
    };

    const updateChart1 = () => {
        // ç”Ÿæˆ X è½´ç´¢å¼•
        const xData = drawData.map((_, i) => i);
        chart1.setOption({
            grid: {top:20, bottom:20, left:20, right:20},
            xAxis: {show:false, type:'category', data: xData},
            yAxis: {min