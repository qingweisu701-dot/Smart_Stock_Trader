{% load static %}
<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½é‡åŒ–æŠ•ç ”å¹³å°</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
    <style>
        body {
            margin: 0;
            background: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }

        .el-aside {
            background: #001529;
            color: rgba(255, 255, 255, 0.65);
            height: 100vh;
            box-shadow: 2px 0 6px rgba(0, 21, 41, 0.35);
            z-index: 10;
        }

        .logo {
            height: 64px;
            line-height: 64px;
            padding-left: 24px;
            font-size: 20px;
            font-weight: 600;
            background: #002140;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            overflow: hidden;
            transition: all 0.3s;
        }

        .logo span {
            margin-left: 10px;
            font-family: 'PingFang SC', sans-serif;
        }

        .header {
            background: #fff;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 4px rgba(0, 21, 41, 0.08);
            z-index: 9;
        }

        .el-menu {
            border-right: none;
            background: transparent;
        }

        .el-menu-item {
            height: 50px;
            line-height: 50px;
            margin: 4px 0;
        }

        .el-menu-item.is-active {
            background-color: #1890ff !important;
            color: #fff;
        }

        .el-main {
            padding: 24px;
            min-height: calc(100vh - 64px);
        }

        [v-cloak] {
            display: none;
        }

        /* Global Card Override */
        .el-card {
            border-radius: 4px;
            border: 1px solid #f0f0f0;
        }

        .el-card__header {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 500;
        }

        .el-card__body {
            padding: 24px;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <el-container>
            <el-aside width="220px">
                <div class="logo" @click="go('/api/dashboard/')">
                    <el-icon :size="24" color="#1890ff"><Trend-Charts /></el-icon>
                    <span>Smart Trader</span>
                </div>
                <el-menu background-color="#001529" text-color="rgba(255,255,255,0.65)" active-text-color="#fff"
                    :default-active="activeMenu" :default-openeds="['1', '2', '3']">
                    <el-menu-item index="0" @click="go('/api/dashboard/')"><el-icon>
                            <Odometer />
                        </el-icon><span>é¦–é¡µ (Dashboard)</span></el-menu-item>
                    <el-sub-menu index="1">
                        <template #title><el-icon>
                                <Edit />
                            </el-icon><span>å›¾å½¢ç®¡ç†</span></template>
                        <el-menu-item index="1-1" @click="go('/api/pattern/lab/')">å½¢æ€å®éªŒå®¤</el-menu-item>
                    </el-sub-menu>
                    <el-sub-menu index="2">
                        <template #title><el-icon>
                                <Search />
                            </el-icon><span>å¸‚åœºåˆ†æ</span></template>
                        <el-menu-item index="2-1" @click="go('/api/analysis/scan/')">æ™ºèƒ½ç­›é€‰å™¨</el-menu-item>
                        <el-menu-item index="2-2" @click="go('/api/analysis/fav/')">æˆ‘çš„è§‚å¯Ÿä»“</el-menu-item>
                    </el-sub-menu>
                    <el-sub-menu index="3">
                        <template #title><el-icon>
                                <Cpu />
                            </el-icon><span>å†³ç­–ä¸­å¿ƒ</span></template>
                        <el-menu-item index="3-1" @click="go('/api/decision/center/')">æ·±åº¦åˆ†æ</el-menu-item>
                    </el-sub-menu>
                    <el-menu-item index="4" @click="go('/api/trade/history/')"><el-icon>
                            <List />
                        </el-icon><span>äº¤æ˜“æµæ°´</span></el-menu-item>
                </el-menu>
            </el-aside>
            <el-container>
                <el-header class="header">
                    <div style="display:flex; align-items:center">
                        <el-icon style="margin-right:10px; cursor:pointer" @click="toggleCollapse">
                            <Fold />
                        </el-icon>
                        <el-breadcrumb separator="/">
                            <el-breadcrumb-item :to="{path:'/api/dashboard/'}">é¦–é¡µ</el-breadcrumb-item>
                            <el-breadcrumb-item>[[pageTitle]]</el-breadcrumb-item>
                        </el-breadcrumb>
                    </div>
                    <div style="display:flex; align-items:center; gap:20px">
                        <el-badge :value="0" class="item" style="cursor: pointer; display:flex; align-items:center">
                            <el-icon size="20">
                                <Bell />
                            </el-icon>
                        </el-badge>
                        <div style="display:flex; align-items:center; cursor:pointer">
                            <el-avatar size="small" style="background:#1890ff">A</el-avatar>
                            <span style="margin-left:8px; font-size:14px; color:#606266">Admin User</span>
                        </div>
                    </div>
                </el-header>
                <el-main>{% block content %}{% endblock %}</el-main>
            </el-container>
        </el-container>
    </div>

    {% block scripts %}{% endblock %}

    <script>
        const { createApp, ref, onMounted } = Vue;
        if (typeof pageSetup === 'undefined') { window.pageSetup = () => ({}); }

        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const path = window.location.pathname;
                let m = '0', t = 'é¦–é¡µ';
                if (path.includes('pattern')) { m = '1-1'; t = 'å›¾å½¢ç®¡ç†'; }
                else if (path.includes('analysis/scan')) { m = '2-1'; t = 'æ™ºèƒ½ç­›é€‰'; }
                else if (path.includes('analysis/fav')) { m = '2-2'; t = 'æˆ‘çš„è§‚å¯Ÿä»“'; }
                else if (path.includes('decision')) { m = '3-1'; t = 'å†³ç­–ä¸­å¿ƒ'; }

                const activeMenu = ref(m);
                const pageTitle = ref(t);
                const isCollapse = ref(false);
                const go = (url) => window.location.href = url;
                const toggleCollapse = () => { isCollapse.value = !isCollapse.value; };

                // ğŸ”¥ æ ¸å¿ƒï¼šå…¨å±€æ¶ˆæ¯è½®è¯¢ (æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ç­–ç•¥å‘½ä¸­)
                const startPolling = () => {
                    setInterval(async () => {
                        try {
                            const res = await axios.get('/api/message/check/');
                            if (res.data.data && res.data.data.length > 0) {
                                res.data.data.forEach(msg => {
                                    ElementPlus.ElNotification({
                                        title: msg.title,
                                        message: msg.content,
                                        type: 'success',
                                        duration: 0 // ä¸è‡ªåŠ¨å…³é—­ï¼Œç›´åˆ°ç”¨æˆ·ç‚¹å‡»
                                    });
                                });
                            }
                        } catch (e) { console.log('Polling error', e); }
                    }, 10000);
                };

                onMounted(startPolling);

                return { activeMenu, pageTitle, go, isCollapse, toggleCollapse, ...window.pageSetup() };
            }
        });
        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
        app.mount('#app');
    </script>
</body>

</html>