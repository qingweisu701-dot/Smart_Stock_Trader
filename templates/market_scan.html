{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container style="height:85vh; border:1px solid #eee">
    <el-aside width="320px" style="padding:15px; background:#fff; overflow-y:auto">
        <h3>ğŸ” æ™ºèƒ½ç­›é€‰</h3>
        <el-form label-position="top">
            <el-form-item label="1. å½¢æ€åŒ¹é…">
                <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€" clearable style="width:100%">
                    <el-option-group label="ğŸ“ˆ é¢„è®¾çœ‹æ¶¨"><el-option v-for="p in presets.buy" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"/></el-option-group>
                    <el-option-group label="ğŸ“‰ é¢„è®¾çœ‹è·Œ"><el-option v-for="p in presets.sell" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"/></el-option-group>
                    <el-option-group label="ğŸ‘¤ æˆ‘çš„"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"/></el-option-group>
                </el-select>
            </el-form-item>
            <el-form-item label="2. æŒ‡æ ‡ç­›é€‰">
                <el-checkbox-group v-model="filters.strategies">
                    <el-checkbox label="MA_GOLD">å‡çº¿é‡‘å‰</el-checkbox>
                    <el-checkbox label="MACD_GOLD">MACDé‡‘å‰</el-checkbox>
                </el-checkbox-group>
            </el-form-item>
            <el-form-item label="3. ä»·æ ¼åŒºé—´(OHLC)">
                <el-row :gutter="5"><el-col :span="12"><el-input v-model="filters.minClose" placeholder="æ”¶ç›˜Min"/></el-col><el-col :span="12"><el-input v-model="filters.maxClose" placeholder="Max"/></el-input></el-col></el-row>
            </el-form-item>
            <el-form-item label="4. å¸‚å€¼è§„æ¨¡">
                <el-select v-model="filters.marketCap" style="width:100%">
                    <el-option label="å…¨éƒ¨" value=""></el-option>
                    <el-option label="å¤§ç›˜ (>200äº¿)" value="LARGE"></el-option>
                    <el-option label="ä¸­ç›˜ (50-200äº¿)" value="MID"></el-option>
                    <el-option label="å°ç›˜ (<50äº¿)" value="SMALL"></el-option>
                </el-select>
            </el-form-item>
            <el-button type="primary" style="width:100%" @click="runScan" :loading="loading">æ‰«æå¸‚åœº</el-button>
        </el-form>
    </el-aside>

    <el-main>
        <div v-if="results.length > 0">
            <el-alert :title="`æ‰«æåˆ° ${results.length} æ”¯è‚¡ç¥¨`" type="success" :closable="false" style="margin-bottom:10px"/>
            <el-table :data="results" stripe border height="100%">
                <el-table-column prop="code" label="ä»£ç " width="100"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="120"></el-table-column>
                <el-table-column label="ä¿¡å·å»ºè®®">
                    <template #default="s">
                        <el-tag :type="s.row.match_type==='BUY'?'danger':'success'" effect="dark">
                            [[ s.row.match_type==='BUY'?'ä¹°å…¥':'å–å‡º' ]]
                        </el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="AIç½®ä¿¡åº¦" width="200">
                    <template #default="s">
                        <el-progress :percentage="s.row.confidence" :color="s.row.confidence>80?'#F56C6C':'#E6A23C'"/>
                    </template>
                </el-table-column>
                <el-table-column prop="price" label="ç°ä»·"></el-table-column>
                <el-table-column label="æ“ä½œ">
                    <template #default="s">
                        <el-button size="small" @click="addFav(s.row)">æ”¶è—</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <el-empty v-else description="è¯·è®¾ç½®æ¡ä»¶å¹¶æ‰«æ"></el-empty>
    </el-main>
</el-container>
{% endblock %}

{% block scripts %}
<script>
function pageSetup() {
    const loading = ref(false);
    const filters = ref({ patternId:'', strategies:[], minClose:'', maxClose:'', marketCap:'', sector:'' });
    const presets = ref({ buy:[], sell:[], user:[] });
    const results = ref([]);

    const init = async () => {
        const res = await axios.get('/api/pattern/list/');
        const all = res.data.data.presets;
        presets.value.buy = all.filter(p=>p.type==='BUY');
        presets.value.sell = all.filter(p=>p.type==='SELL');
        presets.value.user = res.data.data.users;
    };

    const runScan = async () => {
        loading.value = true;
        try {
            let pData = null;
            if (filters.value.patternId) {
                const [source, id] = filters.value.patternId.split(':');
                if (source === 'PRESET') {
                    pData = [...presets.value.buy, ...presets.value.sell].find(x => x.id === id).data;
                } else {
                    pData = presets.value.user.find(x => x.id == id).data;
                }
            }
            const res = await axios.post('/api/analysis/run/', { pattern_data: pData, filters: filters.value });
            results.value = res.data.data;
            if(results.value.length === 0) ElementPlus.ElMessage.info('æ— ç»“æœ');
        } finally { loading.value = false; }
    };

    const addFav = async (row) => {
        await axios.post('/api/favorite/add/', {code:row.code});
        ElementPlus.ElMessage.success('å·²æ”¶è—');
    };

    onMounted(init);
    return { loading, filters, presets, results, runScan, addFav };
}
</script>
{% endblock %}