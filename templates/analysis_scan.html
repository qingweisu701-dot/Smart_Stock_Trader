{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}

{% block content %}
<el-container style="height:85vh; border:1px solid #eee; background:#fff">
    <el-aside width="360px" style="background:#f7f9fc; border-right:1px solid #e6e6e6; display:flex; flex-direction:column">

        <div style="padding:15px; background:#fff; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center">
            <span style="font-weight:bold; color:#303133"><el-icon><Filter /></el-icon> ç­–ç•¥é…ç½®</span>
            <div>
                <el-button type="info" size="small" plain @click="strategyDrawer=true">
                    <el-icon><Management /></el-icon> ç®¡ç†
                </el-button>
                <el-button type="success" size="small" plain @click="goProfitAnalysis">
                    <el-icon><Trend-Charts /></el-icon> æ”¶ç›Š
                </el-button>
            </div>
        </div>

        <div style="flex:1; overflow-y:auto; padding:10px">
            <el-form label-position="top">
                <el-card shadow="never" class="filter-card">
                    <div slot="header" class="card-header">ğŸ“Š å½¢æ€ä¸é˜ˆå€¼</div>
                    <el-form-item label="ç›®æ ‡å½¢æ€">
                        <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€" clearable style="width:100%">
                            <el-option-group label="ç³»ç»Ÿé¢„è®¾"><el-option v-for="p in presets.sys" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"/></el-option-group>
                            <el-option-group label="æˆ‘çš„æ¨¡æ¿"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"/></el-option-group>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="ç›¸ä¼¼åº¦é˜ˆå€¼ (0-100)">
                        <el-input-number v-model="filters.minScore" :min="0" :max="100" controls-position="right" style="width: 100%"></el-input-number>
                    </el-form-item>
                </el-card>

                <el-card shadow="never" class="filter-card">
                    <div slot="header" class="card-header">âš¡ ç½‘æ ¼ä¸ç›‘æ§</div>
                    <el-form-item label="è§¦å‘æ¡ä»¶">
                        <el-checkbox-group v-model="filters.gridConditions">
                            <el-checkbox label="grid_buy">ç½‘æ ¼ä¹°å…¥</el-checkbox>
                            <el-checkbox label="break_up">çªç ´å‹åŠ›</el-checkbox>
                        </el-checkbox-group>
                    </el-form-item>
                    <el-form-item label="è‚¡ä»·ç›‘æ§">
                        <el-row :gutter="5"><el-col :span="12"><el-input v-model="filters.priceBreak" placeholder="çªç ´ä»·" size="small"/></el-col><el-col :span="12"><el-input v-model="filters.priceFall" placeholder="å›è½ä»·" size="small"/></el-col></el-row>
                    </el-form-item>
                </el-card>

                <el-card shadow="never" class="filter-card">
                    <div slot="header" class="card-header">ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡</div>
                    <el-checkbox-group v-model="filters.strategies">
                        <el-row>
                            <el-col :span="12"><el-checkbox label="MA_GOLD">å‡çº¿é‡‘å‰</el-checkbox></el-col>
                            <el-col :span="12"><el-checkbox label="MACD_GOLD">MACDé‡‘å‰</el-checkbox></el-col>
                            <el-col :span="12"><el-checkbox label="KDJ_GOLD">KDJé‡‘å‰</el-checkbox></el-col>
                        </el-row>
                    </el-checkbox-group>
                </el-card>
            </el-form>
        </div>

        <div style="padding:15px; background:#fff; border-top:1px solid #eee; text-align:center">
            <el-button type="primary" size="large" style="width:100%; margin-bottom:10px" @click="runScan" :loading="loading" icon="Search">å¼€å§‹å…¨å¸‚åœºæ‰«æ</el-button>
            <el-button type="warning" plain style="width:100%" @click="saveStrategyDialog=true" icon="Star">ä¿å­˜ä¸ºç›‘æ§ç­–ç•¥</el-button>
        </div>
    </el-aside>

    <el-main style="background:#f5f7fa; padding:15px">
        <div v-if="results.length > 0">
            <el-alert :title="`æ‰«æå®Œæˆï¼Œå‘½ä¸­ ${results.length} ä¸ªæ ‡çš„`" type="success" :closable="false" show-icon style="margin-bottom:15px"/>
            <el-table :data="results" stripe border height="calc(100vh - 180px)" @row-click="showDetail" style="cursor:pointer; box-shadow:0 2px 12px 0 rgba(0,0,0,0.05)">
                <el-table-column prop="code" label="ä»£ç " width="90" fixed></el-table-column>
                <el-table-column prop="name" label="åç§°" width="100" fixed></el-table-column>
                <el-table-column label="ä¿¡å·" width="100"><template #default="s"><el-tag :type="s.row.match_type==='BUY'?'danger':'success'" size="small">[[s.row.match_type]]</el-tag></template></el-table-column>
                <el-table-column label="ç›¸ä¼¼åº¦" width="100"><template #default="s"><span style="color:#409EFF">[[s.row.score]]</span></template></el-table-column>
                <el-table-column label="ä¹°/å–ç‚¹" width="140"><template #default="s"><div style="font-size:12px"><span style="color:#F56C6C">ä¹°:[[s.row.buy_point]]</span><br><span style="color:#67C23A">å–:[[s.row.sell_point]]</span></div></template></el-table-column>
                <el-table-column prop="holding_period" label="å‘¨æœŸ" width="100"></el-table-column>
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                    <template #default="s">
                        <el-button size="small" type="primary" @click.stop="openTrade(s.row)">æ¡ä»¶å•</el-button>
                        <el-button size="small" @click.stop="addFav(s.row)">æ”¶è—</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <div v-else style="display:flex; justify-content:center; align-items:center; height:100%; color:#909399; flex-direction:column">
            <el-icon size="60" style="margin-bottom:20px; color:#e0e0e0"><Data-Analysis /></el-icon>
            <p>è¯·é…ç½®å·¦ä¾§ç­–ç•¥å¹¶æ‰«æ</p>
        </div>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="80%" title="èµ°åŠ¿è¯¦æƒ…" @opened="renderDetailChart">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" title="æ–°å»ºæ¡ä»¶å•" width="35%">
    <el-form label-position="top">
        <el-form-item label="ç›‘æ§æ ‡çš„"><el-tag type="info" size="large">[[trade.name]] ([[trade.code]])</el-tag></el-form-item>
        <el-row :gutter="20">
            <el-col :span="12"><el-form-item label="æ–¹å‘"><el-radio-group v-model="trade.type"><el-radio-button label="BUY">ä¹°å…¥</el-radio-button><el-radio-button label="SELL">å–å‡º</el-radio-button></el-radio-group></el-form-item></el-col>
            <el-col :span="12"><el-form-item label="æœ‰æ•ˆæœŸ"><el-select v-model="trade.valid"><el-option label="å½“æ—¥æœ‰æ•ˆ" value="day"></el-option><el-option label="æ°¸ä¹…æœ‰æ•ˆ" value="forever"></el-option></el-select></el-form-item></el-col>
        </el-row>
        <el-form-item label="è§¦å‘æ¡ä»¶">
            <el-input v-model="trade.triggerValue" placeholder="è¾“å…¥ä»·æ ¼"><template #prepend>ä»·æ ¼ â‰¥</template></el-input>
        </el-form-item>
        <el-form-item label="å§”æ‰˜è®¾ç½®">
            <el-row :gutter="10"><el-col :span="12"><el-input v-model="trade.price" placeholder="ä»·æ ¼"/></el-col><el-col :span="12"><el-input v-model="trade.volume" placeholder="æ•°é‡"/></el-col></el-row>
        </el-form-item>
    </el-form>
    <template #footer><el-button @click="trade.visible=false">å–æ¶ˆ</el-button><el-button type="danger" @click="submitTrade">æäº¤</el-button></template>
</el-dialog>

<el-dialog v-model="saveStrategyDialog" title="ä¿å­˜ä¸ªæ€§åŒ–ç­–ç•¥" width="30%">
    <el-form><el-form-item label="ç­–ç•¥åç§°"><el-input v-model="strategyName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ä½å¸ç­–ç•¥"/></el-form-item><el-form-item label="å®æ—¶ç›‘æ§"><el-switch v-model="monitorEnabled" active-text="å¼€å¯ç›‘æ§"></el-switch></el-form-item></el-form>
    <template #footer><el-button type="primary" @click="doSaveStrategy">ä¿å­˜</el-button></template>
</el-dialog>

<el-drawer v-model="strategyDrawer" title="æˆ‘çš„ç­–ç•¥ç®¡ç†" size="30%">
    <div v-for="s in strategies" :key="s.id" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center">
        <div>
            <div style="font-weight:bold">[[s.name]]</div>
            <div style="font-size:12px; color:#999; margin-top:5px">åˆ›å»ºäº: [[s.create_time.substring(0,10)]]</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px">
            <el-switch v-model="s.is_monitoring" @change="toggleMonitor(s)" active-text="ç›‘æ§"></el-switch>
            <el-button type="danger" icon="Delete" circle size="small" @click="delStrategy(s.id)"></el-button>
        </div>
    </div>
</el-drawer>
{% endblock %}

{% block scripts %}
<style>
    .filter-card { margin-bottom: 15px; border-radius: 4px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-header { font-weight: bold; font-size: 14px; color: #303133; }
    .el-form-item { margin-bottom: 15px; }
</style>
<script>
function pageSetup() {
    const { ref, onMounted } = Vue;
    const loading = ref(false);
    const activeNames = ref(['1', '2', '3']);
    const filters = ref({ patternId:'', minScore: 60, marketCap:'', strategies:[], minClose:'', maxClose:'', priceBreak:'', priceFall:'', dailyChange:[-5, 5], gridConditions:[] });
    const presets = ref({sys:[], user:[]});
    const results = ref([]);
    const strategies = ref([]); // ç­–ç•¥åˆ—è¡¨

    const detailVisible = ref(false);
    const trade = ref({ visible:false, code:'', name:'', type:'BUY', price:0, volume:100, valid:'day', triggerValue:'' });
    const saveStrategyDialog = ref(false);
    const strategyDrawer = ref(false);
    const strategyName = ref('');
    const monitorEnabled = ref(false);
    const currCode = ref('');
    let chart = null;

    const init = async () => {
        const res = await axios.get('/api/pattern/list/');
        presets.value.sys = res.data.data.presets;
        presets.value.user = res.data.data.users;
        loadStrategies();
    };

    const loadStrategies = async () => {
        const res = await axios.get('/api/strategy/list/');
        strategies.value = res.data.data;
    };

    const runScan = async () => {
        loading.value = true;
        try {
            let pData = null;
            if(filters.value.patternId) {
                const [src, id] = filters.value.patternId.split(':');
                const list = src==='PRESET' ? presets.value.sys : presets.value.user;
                pData = list.find(x=>x.id==id).data;
            }
            const res = await axios.post('/api/analysis/run/', { pattern_data: pData, filters: filters.value });
            results.value = res.data.data;
            if(results.value.length === 0) ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨');
        } finally { loading.value = false; }
    };

    const goProfitAnalysis = () => window.location.href = '/api/analysis/profit/';

    const doSaveStrategy = async () => {
        if(!strategyName.value) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥åç§°');
        await axios.post('/api/strategy/save/', { name: strategyName.value, filters: filters.value, monitor: monitorEnabled.value });
        saveStrategyDialog.value = false; loadStrategies(); ElementPlus.ElMessage.success('ç­–ç•¥å·²ä¿å­˜');
    };

    const toggleMonitor = async (s) => {
        await axios.post('/api/strategy/toggle_monitor/', {id: s.id});
        ElementPlus.ElMessage.success(s.is_monitoring ? 'ç›‘æ§å·²å¼€å¯' : 'ç›‘æ§å·²åœæ­¢');
    };

    const delStrategy = async (id) => {
        await axios.post('/api/strategy/delete/', {id: id});
        loadStrategies();
    };

    const showDetail = (row) => { currCode.value = row.code; detailVisible.value = true; };
    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currCode.value}`);
        const d = res.data.data;
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('detail-chart'));
        // ğŸ”¥ ä¿®å¤ï¼šåŠ å…¥ dataZoom
        chart.setOption({
            tooltip:{trigger:'axis'}, xAxis:{data:d.dates}, yAxis:{scale:true},
            dataZoom: [{type:'inside'}, {type:'slider', bottom:0}],
            series:[{type:'candlestick', data:d.values, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}}]
        });
    };

    const openTrade = (row) => { trade.value.visible=true; trade.value.code=row.code; trade.value.name=row.name; trade.value.price=row.price; };
    const submitTrade = async () => { await axios.post('/api/trade/order/', trade.value); trade.value.visible=false; ElementPlus.ElMessage.success('æ¡ä»¶å•æäº¤æˆåŠŸ'); };
    const addFav = async (row) => { await axios.post('/api/favorite/add/', {code:row.code}); ElementPlus.ElMessage.success('å·²æ”¶è—'); };

    onMounted(init);
    return { loading, activeNames, filters, presets, results, strategies, detailVisible, trade, saveStrategyDialog, strategyDrawer, strategyName, monitorEnabled, runScan, goProfitAnalysis, doSaveStrategy, toggleMonitor, delStrategy, showDetail, renderDetailChart, openTrade, submitTrade, addFav };
}
</script>
{% endblock %}