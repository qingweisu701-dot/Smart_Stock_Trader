{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container style="height:85vh; border:1px solid #eee; background:#fff">
    <el-aside width="340px" style="padding:20px; border-right:1px solid #eee; overflow-y:auto">
        <h3 style="color:#001529"><el-icon><Filter /></el-icon> æ™ºèƒ½ç­›é€‰å™¨</h3>
        <el-form label-position="top">

            <div class="filter-box">
                <div class="f-label">1. å½¢æ€æ¨¡å¼</div>
                <el-select v-model="filters.patternId" placeholder="é€‰æ‹©ç›®æ ‡å½¢æ€" clearable style="width:100%">
                    <el-option-group label="ğŸ“ˆ ç»å…¸çœ‹æ¶¨"><el-option v-for="p in presets.buy" :key="p.id" :label="'ğŸ”´ '+p.name" :value="'PRESET:'+p.id"></el-option></el-option-group>
                    <el-option-group label="ğŸ“‰ ç»å…¸çœ‹è·Œ"><el-option v-for="p in presets.sell" :key="p.id" :label="'ğŸŸ¢ '+p.name" :value="'PRESET:'+p.id"></el-option></el-option-group>
                    <el-option-group label="ğŸ‘¤ æˆ‘çš„æ¨¡æ¿"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"></el-option></el-option-group>
                </el-select>
            </div>

            <div class="filter-box">
                <div class="f-label">2. æŠ€æœ¯æŒ‡æ ‡ (å¤šé€‰)</div>
                <el-checkbox-group v-model="filters.strategies">
                    <el-checkbox label="MA_GOLD">å‡çº¿é‡‘å‰</el-checkbox>
                    <el-checkbox label="MACD_GOLD">MACDé‡‘å‰</el-checkbox>
                </el-checkbox-group>
            </div>

            <div class="filter-box">
                <div class="f-label">3. ä»·æ ¼å››ç»´ç­›é€‰ (OHLC)</div>
                <el-row :gutter="5" style="margin-bottom:5px">
                    <el-col :span="12"><el-input v-model="filters.minOpen" placeholder="å¼€ç›˜ä»· >" size="small"></el-input></el-col>
                    <el-col :span="12"><el-input v-model="filters.maxOpen" placeholder="å¼€ç›˜ä»· <" size="small"></el-input></el-col>
                </el-row>
                <el-row :gutter="5" style="margin-bottom:5px">
                    <el-col :span="12"><el-input v-model="filters.minClose" placeholder="æ”¶ç›˜ä»· >" size="small"></el-input></el-col>
                    <el-col :span="12"><el-input v-model="filters.maxClose" placeholder="æ”¶ç›˜ä»· <" size="small"></el-input></el-col>
                </el-row>
                <el-row :gutter="5">
                    <el-col :span="12"><el-input v-model="filters.minHigh" placeholder="æœ€é«˜ä»· >" size="small"></el-input></el-col>
                    <el-col :span="12"><el-input v-model="filters.maxLow" placeholder="æœ€ä½ä»· <" size="small"></el-input></el-col>
                </el-row>
            </div>

            <div class="filter-box">
                <div class="f-label">4. å¸‚å€¼è§„æ¨¡ (æ•°å€¼åŒ–)</div>
                <el-select v-model="filters.marketCap" placeholder="é€‰æ‹©å¸‚å€¼" style="width:100%">
                    <el-option label="å…¨éƒ¨" value=""></el-option>
                    <el-option label="å¤§ç›˜è‚¡ (>200äº¿)" value="LARGE"></el-option>
                    <el-option label="ä¸­ç›˜è‚¡ (50äº¿-200äº¿)" value="MID"></el-option>
                    <el-option label="å°ç›˜è‚¡ (<50äº¿)" value="SMALL"></el-option>
                </el-select>
            </div>

            <el-button type="primary" size="large" style="width:100%; margin-top:15px" @click="runScan" :loading="loading" icon="Search">å¼€å§‹å…¨å¸‚åœºæ‰«æ</el-button>
        </el-form>
    </el-aside>

    <el-main style="background:#f5f7fa">
        <div v-if="results.length > 0">
            <el-alert :title="`æ‰«æå®Œæˆï¼Œå…±å‘½ä¸­ ${results.length} ä¸ªæ ‡çš„`" type="success" show-icon style="margin-bottom:15px" :closable="false"></el-alert>
            <el-table :data="results" stripe border style="width:100%; cursor:pointer" @row-click="showDetail" height="calc(100vh - 180px)">
                <el-table-column prop="code" label="ä»£ç " width="100" fixed></el-table-column>
                <el-table-column prop="name" label="åç§°" width="120" fixed></el-table-column>
                <el-table-column label="ä¿¡å·å»ºè®®" width="140">
                    <template #default="s">
                        <el-tag :type="s.row.match_type==='BUY'?'danger':'success'" effect="dark">
                            [[ s.row.match_type==='BUY'?'ğŸ”´ å»ºè®®ä¹°å…¥':'ğŸŸ¢ å»ºè®®å–å‡º' ]]
                        </el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="AIç½®ä¿¡åº¦" width="200">
                    <template #default="s">
                         <el-progress :percentage="s.row.confidence" :stroke-width="15" :text-inside="true" :color="s.row.confidence>80?'#F56C6C':'#E6A23C'"></el-progress>
                    </template>
                </el-table-column>
                <el-table-column prop="price" label="æœ€æ–°ä»·" width="100"></el-table-column>
                <el-table-column label="æ“ä½œ" fixed="right" width="180">
                    <template #default="s">
                        <el-button size="small" type="primary" @click.stop="openTrade(s.row)">äº¤æ˜“</el-button>
                        <el-button size="small" @click.stop="addFav(s.row)">æ”¶è—</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <div v-else style="display:flex; justify-content:center; align-items:center; height:100%; color:#909399">
            <div>
                <el-icon size="50"><Data-Analysis /></el-icon>
                <p>è¯·åœ¨å·¦ä¾§è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»â€œå¼€å§‹æ‰«æâ€</p>
            </div>
        </div>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="85%" title="èµ°åŠ¿è¯¦æƒ…" @opened="renderDetailChart">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" title="ä¸‹å•" width="30%">
    <el-form label-width="60px">
        <el-form-item label="æ ‡çš„"><b>[[trade.name]]</b> ([[trade.code]])</el-form-item>
        <el-form-item label="æ–¹å‘">
            <el-radio-group v-model="trade.type">
                <el-radio-button label="BUY"><span style="color:red">ä¹°å…¥</span></el-radio-button>
                <el-radio-button label="SELL"><span style="color:green">å–å‡º</span></el-radio-button>
            </el-radio-group>
        </el-form-item>
        <el-form-item label="ä»·æ ¼"><el-input-number v-model="trade.price" :precision="2" :step="0.1"/></el-form-item>
        <el-form-item label="æ•°é‡"><el-input-number v-model="trade.volume" :step="100"/></el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="submitTrade">ç¡®è®¤æäº¤</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .filter-box { margin-bottom: 20px; border-bottom: 1px dashed #eee; padding-bottom: 15px; }
    .f-label { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #606266; }
</style>
<script>
function pageSetup() {
    const loading = ref(false);
    const filters = ref({ patternId:'', strategies:[], minOpen:'', maxOpen:'', minClose:'', maxClose:'', minHigh:'', maxLow:'', marketCap:'', sector:'' });
    const presets = ref({ buy:[], sell:[], user:[] });
    const results = ref([]);

    const detailVisible = ref(false);
    const currentCode = ref('');
    let detailChart = null;
    const trade = ref({ visible:false, code:'', name:'', price:0, volume:100, type:'BUY' });

    onMounted(async () => {
        const res = await axios.get('/api/pattern/list/');
        const all = res.data.data.presets;
        presets.value.buy = all.filter(p=>p.type==='BUY');
        presets.value.sell = all.filter(p=>p.type==='SELL');
        presets.value.user = res.data.data.users;
    });

    const runScan = async () => {
        loading.value = true;
        try {
            let pData = null;
            if (filters.value.patternId) {
                const [source, id] = filters.value.patternId.split(':');
                if (source === 'PRESET') {
                    pData = [...presets.value.buy, ...presets.value.sell].find(x => x.id === id).data;
                } else {
                    pData = presets.value.user.find(x => x.id == id).data;
                }
            }
            const res = await axios.post('/api/analysis/run/', { pattern_data: pData, filters: filters.value });
            results.value = res.data.data;
            if(results.value.length === 0) ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨');
        } finally { loading.value = false; }
    };

    const showDetail = (row) => { currentCode.value = row.code; detailVisible.value = true; };

    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currentCode.value}`);
        const d = res.data.data;
        if(detailChart) detailChart.dispose();
        detailChart = echarts.init(document.getElementById('detail-chart'));

        // æ ‡æ³¨
        const marks = d.signals.map(s => ({ name: s.msg, coord: [s.idx, d.values[s.idx][1]], value: s.msg, itemStyle: {color: s.type==='BUY'?'#F56C6C':'#00C853'} }));

        detailChart.setOption({
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross' },
                // ğŸ”¥ ä¸“ä¸šçš„ Tooltip æ˜¾ç¤º
                formatter: function (params) {
                    let res = params[0].name + '<br/>';
                    for (let i = 0; i < params.length; i++) {
                        if (params[i].seriesName === 'æ—¥K') {
                            const data = params[i].data;
                            // data: [index, open, close, low, high]
                            res += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${params[i].color};"></span>`;
                            res += `å¼€:${data[1]} æ”¶:${data[2]} ä½:${data[3]} é«˜:${data[4]}<br/>`;
                        } else {
                            res += `${params[i].marker} ${params[i].seriesName}: ${params[i].value}<br/>`;
                        }
                    }
                    return res;
                }
            },
            legend: { data: ['æ—¥K', 'MA5', 'MA20'] },
            grid: { left: '3%', right: '3%', bottom: '10%' },
            xAxis: { data: d.dates },
            yAxis: { scale: true },
            dataZoom: [{ type: 'inside' }, { type: 'slider', bottom: 0 }],
            series: [
                {
                    name: 'æ—¥K', type: 'candlestick', data: d.values,
                    itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' },
                    markPoint: { data: marks, symbolSize: 60 }
                },
                { name: 'MA5', type: 'line', data: d.mas.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                { name: 'MA20', type: 'line', data: d.mas.MA20, smooth: true, lineStyle: { opacity: 0.5 } }
            ]
        });
    };

    const openTrade = (row) => { trade.value = { visible:true, code:row.code, name:row.name, price:row.price, volume:100, type:'BUY' }; };
    const submitTrade = async () => { await axios.post('/api/trade/order/', trade.value); trade.value.visible=false; ElementPlus.ElMessage.success('ä¸‹å•æˆåŠŸ'); };
    const addFav = async (row) => { await axios.post('/api/favorite/add/', {code:row.code}); ElementPlus.ElMessage.success('å·²æ”¶è—'); };

    return { loading, filters, presets, results, runScan, showDetail, detailVisible, renderDetailChart, trade, openTrade, submitTrade, addFav };
}
</script>
{% endblock %}