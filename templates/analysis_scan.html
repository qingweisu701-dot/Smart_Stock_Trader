{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container style="height:85vh; border:1px solid #eee; background:#fff">
    <el-aside width="360px" style="padding:15px; border-right:1px solid #eee; overflow-y:auto">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h3 style="margin:0"><el-icon><Filter /></el-icon> ä¸“ä¸šç­›é€‰</h3>
            <el-button type="success" size="small" plain @click="goProfitAnalysis"><el-icon><Trend-Charts /></el-icon> æ”¶ç›Šåˆ†æ</el-button>
        </div>
        <el-form label-position="top">
            <el-card shadow="never" class="filter-card">
                <div slot="header" class="card-header">ğŸ“Š å½¢æ€ä¸é˜ˆå€¼</div>
                <el-form-item label="ç›®æ ‡å½¢æ€">
                    <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€" clearable style="width:100%">
                        <el-option-group label="ç³»ç»Ÿé¢„è®¾"><el-option v-for="p in presets.sys" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"/></el-option-group>
                        <el-option-group label="æˆ‘çš„æ¨¡æ¿"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"/></el-option-group>
                    </el-select>
                </el-form-item>
                <el-form-item label="ç›¸ä¼¼åº¦é˜ˆå€¼">
                    <el-input-number v-model="filters.minScore" :min="0" :max="100" controls-position="right" style="width:100%"></el-input-number>
                </el-form-item>
            </el-card>
            <el-card shadow="never" class="filter-card">
                <div slot="header" class="card-header">âš¡ ç›‘æ§æ¡ä»¶</div>
                <el-form-item label="ç½‘æ ¼è§¦å‘"><el-checkbox-group v-model="filters.gridConditions"><el-checkbox label="grid_buy">ç½‘æ ¼ä¹°å…¥</el-checkbox></el-checkbox-group></el-form-item>
                <el-form-item label="ä»·æ ¼ç›‘æ§"><el-row :gutter="5"><el-col :span="12"><el-input v-model="filters.priceBreak" placeholder="çªç ´ä»·"/></el-col><el-col :span="12"><el-input v-model="filters.priceFall" placeholder="å›è½ä»·"/></el-col></el-row></el-form-item>
            </el-card>
            <div style="margin-top:20px"><el-button type="primary" size="large" style="width:100%" @click="runScan" :loading="loading">å¼€å§‹æ‰«æ</el-button><el-button type="warning" plain style="width:100%;margin-top:10px" @click="saveStrategyDialog=true">ä¿å­˜ç­–ç•¥</el-button></div>
        </el-form>
    </el-aside>

    <el-main style="background:#f5f7fa; padding:15px">
        <div v-if="results.length > 0">
            <el-alert :title="`æ‰«æå®Œæˆï¼Œå‘½ä¸­ ${results.length} ä¸ªæ ‡çš„`" type="success" :closable="false" style="margin-bottom:10px"/>
            <el-table :data="results" stripe border height="calc(100vh - 150px)" @row-click="showDetail">
                <el-table-column prop="code" label="ä»£ç " width="90"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="100"></el-table-column>
                <el-table-column label="ä¿¡å·"><template #default="s"><el-tag :type="s.row.match_type==='BUY'?'danger':'success'" size="small">[[s.row.match_type]]</el-tag></template></el-table-column>
                <el-table-column label="ä¹°/å–ç‚¹"><template #default="s"><span style="color:#F56C6C">ä¹°:[[s.row.buy_point]]</span> <span style="color:#67C23A">å–:[[s.row.sell_point]]</span></template></el-table-column>
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                    <template #default="s"><el-button size="small" type="primary" @click.stop="openTrade(s.row)">æ¡ä»¶å•</el-button><el-button size="small" @click.stop="addFav(s.row)">æ”¶è—</el-button></template>
                </el-table-column>
            </el-table>
        </div>
        <div v-else style="display:flex;justify-content:center;align-items:center;height:100%;color:#999"><p>è¯·åœ¨å·¦ä¾§é…ç½®ç­–ç•¥å¹¶æ‰«æ</p></div>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="85%" title="ä¸ªè‚¡æ·±åº¦åˆ†æ" @opened="renderDetailChart">
    <div style="text-align:right; margin-bottom:10px">
        <el-radio-group v-model="currIndicator" size="small" @change="renderDetailChart">
            <el-radio-button label="MACD">MACD</el-radio-button><el-radio-button label="KDJ">KDJ</el-radio-button><el-radio-button label="RSI">RSI</el-radio-button>
        </el-radio-group>
    </div>
    <div id="detail-chart" style="height:550px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" title="æ–°å»ºæ¡ä»¶å•" width="35%">
    <el-form label-position="top">
        <el-form-item label="ç›‘æ§æ ‡çš„"><el-tag type="info">[[trade.name]] ([[trade.code]])</el-tag></el-form-item>
        <el-row :gutter="20">
            <el-col :span="12"><el-form-item label="æ–¹å‘"><el-radio-group v-model="trade.type"><el-radio-button label="BUY">ä¹°å…¥</el-radio-button><el-radio-button label="SELL">å–å‡º</el-radio-button></el-radio-group></el-form-item></el-col>
            <el-col :span="12"><el-form-item label="è§¦å‘ä»·"><el-input v-model="trade.triggerValue"><template #prepend>åƒ¹æ ¼â‰¥</template></el-input></el-form-item></el-col>
        </el-row>
        <el-form-item label="å§”æ‰˜"><el-row :gutter="10"><el-col :span="12"><el-input v-model="trade.price" placeholder="ä»·æ ¼"/></el-col><el-col :span="12"><el-input v-model="trade.volume" placeholder="æ•°é‡"/></el-col></el-row></el-form-item>
    </el-form>
    <template #footer><el-button @click="trade.visible=false">å–æ¶ˆ</el-button><el-button type="danger" @click="submitTrade">æäº¤</el-button></template>
</el-dialog>

<el-dialog v-model="saveStrategyDialog" title="ä¿å­˜ç­–ç•¥" width="30%">
    <el-form><el-form-item label="åç§°"><el-input v-model="strategyName"/></el-form-item><el-form-item label="ç›‘æ§"><el-switch v-model="monitorEnabled"/></el-form-item></el-form>
    <template #footer><el-button type="primary" @click="doSaveStrategy">ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>.filter-card{margin-bottom:15px;}</style>
<script>
function pageSetup() {
    const { ref, onMounted } = Vue;
    const loading = ref(false);
    const activeNames = ref(['1','2','3']);
    const filters = ref({ patternId:'', minScore:60, marketCap:'', strategies:[], priceBreak:'', priceFall:'', dailyChange:[-5,5], gridConditions:[] });
    const presets = ref({sys:[], user:[]});
    const results = ref([]);
    const detailVisible = ref(false);
    const trade = ref({visible:false, code:'', name:'', type:'BUY', price:0, volume:100, triggerValue:''});
    const saveStrategyDialog = ref(false);
    const strategyName = ref('');
    const monitorEnabled = ref(false);
    const currCode = ref('');
    const currIndicator = ref('MACD');
    let chart = null;

    const init = async () => {
        const res = await axios.get('/api/pattern/list/');
        presets.value.sys = res.data.data.presets;
        presets.value.user = res.data.data.users;
    };

    const runScan = async () => {
        loading.value = true;
        try {
            let pData = null;
            if(filters.value.patternId) {
                const [src, id] = filters.value.patternId.split(':');
                const list = src==='PRESET'?presets.value.sys:presets.value.user;
                pData = list.find(x=>x.id==id).data;
            }
            const res = await axios.post('/api/analysis/run/', {pattern_data:pData, filters:filters.value});
            results.value = res.data.data;
            if(results.value.length===0) ElementPlus.ElMessage.warning('æ— åŒ¹é…ç»“æœ');
        } finally { loading.value = false; }
    };

    const goProfitAnalysis = () => window.location.href = '/api/analysis/profit/';
    const doSaveStrategy = async () => {
        if(!strategyName.value) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥åç§°');
        await axios.post('/api/strategy/save/', {name:strategyName.value, filters:filters.value, monitor:monitorEnabled.value});
        saveStrategyDialog.value = false; ElementPlus.ElMessage.success('ç­–ç•¥å·²ä¿å­˜');
    };

    const showDetail = (row) => { currCode.value = row.code; detailVisible.value = true; };

    // ğŸ”¥ ä¿®å¤ï¼šåŒæ­¥ä½¿ç”¨æ–°çš„å›¾è¡¨æ¸²æŸ“é€»è¾‘ (å¸¦ä¸­æ–‡ Tooltip)
    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currCode.value}`);
        if(res.data.code !== 200) return;
        const d = res.data.data;
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('detail-chart'));

        const ind = d.indicators;
        let indSeries = [];
        if(currIndicator.value === 'MACD') {
            indSeries = [{name:'MACD', type:'bar', xAxisIndex:2, yAxisIndex:2, data:ind.MACD, itemStyle:{color:p=>p.value>0?'#ef232a':'#14b143'}},{name:'DIF', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.DIF, symbol:'none'},{name:'DEA', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.DEA, symbol:'none'}];
        } else if(currIndicator.value === 'KDJ') {
            indSeries = [{name:'K', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.K, symbol:'none'},{name:'D', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.D, symbol:'none'},{name:'J', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.J, symbol:'none'}];
        } else {
            indSeries = [{name:'RSI', type:'line', xAxisIndex:2, yAxisIndex:2, data:ind.RSI, symbol:'none'}];
        }

        chart.setOption({
            tooltip: {
                trigger:'axis', axisPointer:{type:'cross'},
                // ğŸ”¥ ä¿®å¤ï¼šä¸­æ–‡ Tooltip
                formatter: function (params) {
                    let res = `<div style="margin-bottom:5px;font-weight:bold">${params[0].name}</div>`;
                    params.forEach(p => {
                        if(p.seriesName === 'Kçº¿') {
                            const open = p.data[1], close = p.data[2];
                            const chg = ((close - open) / open * 100).toFixed(2);
                            const color = chg >= 0 ? '#ef232a' : '#14b143';
                            res += `Kçº¿ï¼š<span style="color:${color}">æ”¶${close} (å¹…${chg}%)</span><br/>`;
                        } else if(p.seriesName === 'æˆäº¤é‡') {
                            res += `æˆäº¤é‡ï¼š${(p.data).toLocaleString()}<br/>`;
                        } else {
                            res += `${p.seriesName}ï¼š${p.value ? p.value.toFixed(2) : '--'}<br/>`;
                        }
                    });
                    return res;
                }
            },
            legend: { top:0, data:['Kçº¿','MA5','MA20','æˆäº¤é‡',currIndicator.value] },
            grid: [{left:'8%',right:'5%',height:'45%'}, {left:'8%',right:'5%',top:'58%',height:'15%'}, {left:'8%',right:'5%',top:'78%',height:'15%'}],
            xAxis: [{type:'category', data:d.dates, boundaryGap:false, axisLine:{onZero:false}}, {type:'category', gridIndex:1, data:d.dates, show:false}, {type:'category', gridIndex:2, data:d.dates, show:false}],
            yAxis: [{scale:true, splitArea:{show:true}}, {gridIndex:1, splitNumber:2, axisLabel:{show:false}}, {gridIndex:2, splitNumber:2, axisLabel:{show:false}}],
            dataZoom: [{type:'inside', xAxisIndex:[0,1,2], start:50, end:100}, {type:'slider', xAxisIndex:[0,1,2], bottom:0}],
            series: [
                {name:'Kçº¿', type:'candlestick', data:d.values.map(v=>[v[0],v[1],v[2],v[3]]), itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}},
                {name:'MA5', type:'line', data:ind.MA5, smooth:true, lineStyle:{opacity:0.5}},
                {name:'MA20', type:'line', data:ind.MA20, smooth:true, lineStyle:{opacity:0.5}},
                {name:'æˆäº¤é‡', type:'bar', xAxisIndex:1, yAxisIndex:1, data:d.values.map(v=>v[4]), itemStyle:{color:p=>d.values[p.dataIndex][1]>d.values[p.dataIndex][0]?'#ef232a':'#14b143'}},
                ...indSeries
            ]
        });
    };

    const openTrade = (row) => { trade.value.visible=true; trade.value.code=row.code; trade.value.name=row.name; trade.value.price=row.price; };
    const submitTrade = async () => { await axios.post('/api/trade/order/', trade.value); trade.value.visible=false; ElementPlus.ElMessage.success('æ¡ä»¶å•æäº¤æˆåŠŸ'); };
    const addFav = async (row) => { await axios.post('/api/favorite/add/', {code:row.code}); ElementPlus.ElMessage.success('å·²æ”¶è—'); };

    onMounted(init);
    return { loading, activeNames, filters, presets, results, detailVisible, trade, saveStrategyDialog, strategyName, monitorEnabled, runScan, goProfitAnalysis, doSaveStrategy, showDetail, renderDetailChart, openTrade, submitTrade, addFav, currIndicator };
}
</script>
{% endblock %}