{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container style="height:85vh; border:1px solid #eee; background:#fff">
    <el-aside width="340px" style="padding:15px; border-right:1px solid #eee; overflow-y:auto">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h3 style="margin:0"><el-icon><Filter /></el-icon> ä¸“ä¸šç­›é€‰</h3>
            <el-button type="success" size="small" plain @click="goProfitAnalysis">
                <el-icon><Trend-Charts /></el-icon> æ”¶ç›Šåˆ†æ
            </el-button>
        </div>

        <el-form label-position="top">
            <el-collapse v-model="activeNames">
                <el-collapse-item title="ğŸ“Š å½¢æ€ä¸åŸºæœ¬é¢" name="1">
                    <el-form-item label="å½¢æ€åŒ¹é…">
                        <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€" clearable style="width:100%">
                            <el-option-group label="é¢„è®¾å½¢æ€"><el-option v-for="p in presets.sys" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"/></el-option-group>
                            <el-option-group label="æˆ‘çš„æ¨¡æ¿"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"/></el-option-group>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="å¸‚å€¼è§„æ¨¡">
                        <el-radio-group v-model="filters.marketCap" size="small">
                            <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                            <el-radio-button label="LARGE">å¤§ç›˜</el-radio-button>
                            <el-radio-button label="SMALL">å°ç›˜</el-radio-button>
                        </el-radio-group>
                    </el-form-item>
                </el-collapse-item>

                <el-collapse-item title="âš¡ ç½‘æ ¼ä¸ç›‘æ§æ¡ä»¶" name="2">
                    <el-form-item label="è‚¡ä»·ç›‘æ§ (å…ƒ)">
                        <el-row :gutter="5">
                            <el-col :span="12"><el-input v-model="filters.priceBreak" placeholder="çªç ´ä»·"></el-input></el-col>
                            <el-col :span="12"><el-input v-model="filters.priceFall" placeholder="å›è½ä»·"></el-input></el-col>
                        </el-row>
                    </el-form-item>
                    <el-form-item label="æ—¥æ¶¨è·Œå¹… (%)">
                        <el-slider v-model="filters.dailyChange" range :min="-10" :max="10"></el-slider>
                    </el-form-item>
                    <el-form-item label="ç½‘æ ¼ç­–ç•¥">
                        <el-checkbox-group v-model="filters.gridConditions">
                            <el-checkbox label="grid_buy">ç½‘æ ¼ä¹°å…¥</el-checkbox>
                            <el-checkbox label="grid_sell">ç½‘æ ¼å–å‡º</el-checkbox>
                        </el-checkbox-group>
                    </el-form-item>
                </el-collapse-item>

                <el-collapse-item title="ğŸ“ˆ æŒ‡æ ‡ä¿¡å·" name="3">
                    <el-form-item label="å‡çº¿ç³»ç»Ÿ">
                        <el-checkbox-group v-model="filters.strategies">
                            <el-checkbox label="MA_GOLD">å‡çº¿é‡‘å‰</el-checkbox>
                            <el-checkbox label="PRICE_UP_MA20">ç«™ä¸Š20æ—¥çº¿</el-checkbox>
                        </el-checkbox-group>
                    </el-form-item>
                    <el-form-item label="MACDå½¢æ€">
                        <el-checkbox-group v-model="filters.strategies">
                            <el-checkbox label="MACD_GOLD">MACDé‡‘å‰</el-checkbox>
                            <el-checkbox label="MACD_BOTTOM">åº•èƒŒç¦»</el-checkbox>
                        </el-checkbox-group>
                    </el-form-item>
                </el-collapse-item>
            </el-collapse>

            <div style="margin-top:20px; display:flex; gap:10px">
                <el-button type="primary" style="flex:1" @click="runScan" :loading="loading">å¼€å§‹æ‰«æ</el-button>
                <el-button type="warning" plain icon="Star" @click="saveStrategyDialog=true">ä¿å­˜ç­–ç•¥</el-button>
            </div>
        </el-form>
    </el-aside>

    <el-main>
        <div v-if="results.length > 0">
            <el-alert :title="`æ‰«æå®Œæˆï¼Œå…± ${results.length} æ¡ç»“æœ`" type="success" :closable="false" style="margin-bottom:10px"/>
            <el-table :data="results" stripe border height="calc(100vh - 150px)" @row-click="showDetail" style="cursor:pointer">
                <el-table-column prop="code" label="ä»£ç " width="90"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="100"></el-table-column>
                <el-table-column label="ä¿¡å·" width="100">
                    <template #default="s"><el-tag :type="s.row.match_type==='BUY'?'danger':'success'" size="small">[[s.row.match_type]]</el-tag></template>
                </el-table-column>
                <el-table-column label="æ½œåœ¨ä¹°/å–ç‚¹" width="140">
                    <template #default="s">
                        <div style="font-size:12px">
                            <span style="color:#F56C6C">ä¹°: [[s.row.buy_point]]</span><br>
                            <span style="color:#67C23A">å–: [[s.row.sell_point]]</span>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="holding_period" label="å»ºè®®å‘¨æœŸ" width="100"></el-table-column>
                <el-table-column label="ç½®ä¿¡åº¦" width="150">
                    <template #default="s"><el-progress :percentage="s.row.confidence" :color="s.row.confidence>80?'#F56C6C':'#E6A23C'"/></template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="180" fixed="right">
                    <template #default="s">
                        <el-button size="small" type="primary" @click.stop="openTrade(s.row)">æ¡ä»¶å•</el-button>
                        <el-button size="small" @click.stop="addFav(s.row)">æ”¶è—</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <el-empty v-else description="è¯·é…ç½®å·¦ä¾§ç­–ç•¥è¿›è¡Œæ‰«æ"></el-empty>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="80%" title="èµ°åŠ¿è¯¦æƒ…" @opened="renderDetailChart">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" title="æ–°å»ºæ¡ä»¶å•" width="35%">
    <el-form label-position="top">
        <el-alert title="é£é™©æç¤ºï¼šæ¡ä»¶å•è§¦å‘åå°†è‡ªåŠ¨æäº¤å§”æ‰˜" type="info" :closable="false" style="margin-bottom:15px"/>
        <el-form-item label="ç›‘æ§æ ‡çš„">
            <el-tag type="info">[[trade.name]] ([[trade.code]])</el-tag>
        </el-form-item>
        <el-row :gutter="20">
            <el-col :span="12">
                <el-form-item label="ä¹°å–æ–¹å‘">
                    <el-radio-group v-model="trade.type" size="small">
                        <el-radio-button label="BUY">ä¹°å…¥</el-radio-button>
                        <el-radio-button label="SELL">å–å‡º</el-radio-button>
                    </el-radio-group>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="æœ‰æ•ˆæœŸ">
                    <el-select v-model="trade.valid" size="small">
                        <el-option label="å½“æ—¥æœ‰æ•ˆ" value="day"></el-option>
                        <el-option label="æ°¸ä¹…æœ‰æ•ˆ" value="forever"></el-option>
                    </el-select>
                </el-form-item>
            </el-col>
        </el-row>
        <el-form-item label="è§¦å‘æ¡ä»¶">
            <el-radio-group v-model="trade.conditionType" size="small" style="margin-bottom:10px">
                <el-radio-button label="price">ä»·æ ¼</el-radio-button>
                <el-radio-button label="percent">æ¶¨è·Œå¹…</el-radio-button>
                <el-radio-button label="macd">MACDå½¢æ€</el-radio-button>
            </el-radio-group>
            <el-input v-model="trade.triggerValue" placeholder="è¯·è¾“å…¥è§¦å‘æ•°å€¼"><template #prepend>[[trade.conditionType==='price'?'â‰¥':'æ•°å€¼']]</template></el-input>
        </el-form-item>
        <el-form-item label="å§”æ‰˜è®¾ç½®">
            <el-row :gutter="10">
                <el-col :span="12"><el-input v-model="trade.price" placeholder="å§”æ‰˜ä»·æ ¼"><template #prepend>ä»·æ ¼</template></el-input></el-col>
                <el-col :span="12"><el-input v-model="trade.volume" placeholder="æ•°é‡"><template #prepend>è‚¡æ•°</template></el-input></el-col>
            </el-row>
        </el-form-item>
    </el-form>
    <template #footer><el-button @click="trade.visible=false">å–æ¶ˆ</el-button><el-button type="danger" @click="submitTrade">æäº¤æ¡ä»¶å•</el-button></template>
</el-dialog>

<el-dialog v-model="saveStrategyDialog" title="ä¿å­˜ä¸ªæ€§åŒ–ç­–ç•¥" width="30%">
    <el-form>
        <el-form-item label="ç­–ç•¥åç§°"><el-input v-model="strategyName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ä½å¸ç­–ç•¥"/></el-form-item>
        <el-form-item label="å®æ—¶ç›‘æ§">
            <el-switch v-model="monitorEnabled" active-text="å¼€å¯å®æ—¶ç›‘æ§" inactive-text="ä»…ä¿å­˜"></el-switch>
        </el-form-item>
        <div style="font-size:12px; color:#666">å¼€å¯ç›‘æ§åï¼Œç³»ç»Ÿå°†å®æ—¶æ‰«æï¼Œè§¦å‘æ—¶æ¨é€æ¶ˆæ¯ã€‚</div>
    </el-form>
    <template #footer><el-button type="primary" @click="doSaveStrategy">ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<script>
function pageSetup() {
    const { ref, onMounted } = Vue;
    const loading = ref(false);
    const activeNames = ref(['1', '2', '3']);
    const filters = ref({ patternId:'', marketCap:'', strategies:[], priceBreak:'', priceFall:'', dailyChange:[-5, 5], gridConditions:[] });
    const presets = ref({sys:[], user:[]});
    const results = ref([]);
    const detailVisible = ref(false);
    const trade = ref({ visible:false, code:'', name:'', type:'BUY', price:0, volume:100, valid:'day', conditionType:'price', triggerValue:'' });
    const saveStrategyDialog = ref(false);
    const strategyName = ref('');
    const monitorEnabled = ref(false);
    const currCode = ref('');
    let chart = null;

    const init = async () => {
        const res = await axios.get('/api/pattern/list/');
        presets.value.sys = res.data.data.presets;
        presets.value.user = res.data.data.users;
    };

    const runScan = async () => {
        loading.value = true;
        try {
            let pData = null;
            if(filters.value.patternId) {
                const [src, id] = filters.value.patternId.split(':');
                const list = src==='PRESET' ? presets.value.sys : presets.value.user;
                pData = list.find(x=>x.id==id).data;
            }
            const res = await axios.post('/api/analysis/run/', { pattern_data: pData, filters: filters.value });
            results.value = res.data.data;
            if(results.value.length === 0) ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨');
        } finally { loading.value = false; }
    };

    const goProfitAnalysis = () => window.location.href = '/api/analysis/profit/';

    const doSaveStrategy = async () => {
        if(!strategyName.value) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥åç§°');
        await axios.post('/api/strategy/save/', { name: strategyName.value, filters: filters.value, monitor: monitorEnabled.value });
        saveStrategyDialog.value = false; ElementPlus.ElMessage.success('ç­–ç•¥å·²ä¿å­˜');
    };

    const showDetail = (row) => { currCode.value = row.code; detailVisible.value = true; };
    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currCode.value}`);
        const d = res.data.data;
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('detail-chart'));
        chart.setOption({
            tooltip:{trigger:'axis'}, xAxis:{data:d.dates}, yAxis:{scale:true},
            series:[{type:'candlestick', data:d.values, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}}]
        });
    };

    const openTrade = (row) => { trade.value.visible=true; trade.value.code=row.code; trade.value.name=row.name; trade.value.price=row.price; };
    const submitTrade = async () => { await axios.post('/api/trade/order/', trade.value); trade.value.visible=false; ElementPlus.ElMessage.success('æ¡ä»¶å•æäº¤æˆåŠŸ'); };
    const addFav = async (row) => { await axios.post('/api/favorite/add/', {code:row.code}); ElementPlus.ElMessage.success('å·²æ”¶è—'); };

    onMounted(init);
    return { loading, activeNames, filters, presets, results, detailVisible, trade, saveStrategyDialog, strategyName, monitorEnabled, runScan, goProfitAnalysis, doSaveStrategy, showDetail, renderDetailChart, openTrade, submitTrade, addFav };
}
</script>
{% endblock %}