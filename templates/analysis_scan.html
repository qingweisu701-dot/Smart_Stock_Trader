{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container style="height:85vh; border:1px solid #eee">
    <el-aside width="320px" style="padding:15px; background:#fff; overflow-y:auto">
        <h3>ğŸ” æ™ºèƒ½ç­›é€‰</h3>
        <el-form label-position="top">
            <el-form-item label="1. å½¢æ€åŒ¹é…">
                <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€" clearable style="width:100%">
                    <el-option-group label="ç»å…¸å½¢æ€"><el-option v-for="p in presets.sys" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"/></el-option-group>
                    <el-option-group label="æˆ‘çš„æ¨¡æ¿"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"/></el-option-group>
                </el-select>
            </el-form-item>

            <el-form-item label="2. ä»·æ ¼åŒºé—´ (OHLC)">
                <el-row :gutter="5"><el-col :span="12"><el-input v-model="filters.minOpen" placeholder="å¼€ç›˜Min"/></el-col><el-col :span="12"><el-input v-model="filters.maxOpen" placeholder="Max"/></el-input></el-col></el-row>
                <el-row :gutter="5" style="margin-top:5px"><el-col :span="12"><el-input v-model="filters.minClose" placeholder="æ”¶ç›˜Min"/></el-col><el-col :span="12"><el-input v-model="filters.maxClose" placeholder="Max"/></el-input></el-col></el-row>
            </el-form-item>

            <el-form-item label="3. å¸‚å€¼è§„æ¨¡">
                <el-radio-group v-model="filters.marketCap" size="small">
                    <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                    <el-radio-button label="LARGE">å¤§(>200äº¿)</el-radio-button>
                    <el-radio-button label="SMALL">å°(<50äº¿)</el-radio-button>
                </el-radio-group>
            </el-form-item>

            <el-form-item label="4. ç­–ç•¥æŒ‡æ ‡">
                <el-checkbox-group v-model="filters.strategies">
                    <el-checkbox label="MA_GOLD">å‡çº¿é‡‘å‰</el-checkbox>
                    <el-checkbox label="MACD_GOLD">MACDé‡‘å‰</el-checkbox>
                </el-checkbox-group>
            </el-form-item>

            <el-button type="primary" style="width:100%" @click="runScan" :loading="loading">å¼€å§‹æ‰«æ</el-button>
        </el-form>
    </el-aside>

    <el-main>
        <el-table :data="results" stripe border @row-click="showDetail" style="cursor:pointer">
            <el-table-column prop="code" label="ä»£ç " width="100"></el-table-column>
            <el-table-column prop="name" label="åç§°" width="120"></el-table-column>
            <el-table-column label="å»ºè®®">
                <template #default="s">
                    <el-tag :type="s.row.match_type==='BUY'?'danger':'success'" effect="dark">[[s.row.match_type]]</el-tag>
                </template>
            </el-table-column>
            <el-table-column label="ç½®ä¿¡åº¦" width="180">
                <template #default="s"><el-progress :percentage="s.row.confidence"/></template>
            </el-table-column>
            <el-table-column prop="price" label="ç°ä»·"></el-table-column>
            <el-table-column label="æ“ä½œ">
                <template #default="s"><el-button size="small" @click.stop="addFav(s.row)">æ”¶è—</el-button></template>
            </el-table-column>
        </el-table>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="80%" title="èµ°åŠ¿è¯¦æƒ…" @opened="renderDetail">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>
{% endblock %}

{% block scripts %}
<script>
function pageSetup() {
    const loading=ref(false);
    const filters=ref({patternId:'', strategies:[], minOpen:'', maxOpen:'', minClose:'', maxClose:'', marketCap:''});
    const presets=ref({sys:[], user:[]});
    const results=ref([]);

    const detailVisible=ref(false);
    const currCode=ref('');
    let chart=null;

    const init = async () => {
        const res = await axios.get('/api/pattern/list/');
        presets.value.sys = res.data.data.presets;
        presets.value.user = res.data.data.users;
    };

    const runScan = async () => {
        loading.value=true;
        try {
            let pData = null;
            if(filters.value.patternId) {
                const [src, id] = filters.value.patternId.split(':');
                const list = src==='PRESET'?presets.value.sys:presets.value.user;
                pData = list.find(x=>x.id==id).data;
            }
            const res = await axios.post('/api/analysis/run/', {pattern_data:pData, filters:filters.value});
            results.value = res.data.data;
        } finally { loading.value=false; }
    };

    const showDetail = (row) => { currCode.value=row.code; detailVisible.value=true; };
    const renderDetail = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currCode.value}`);
        const d = res.data.data;
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('detail-chart'));

        // ä»¿ä¸œæ–¹è´¢å¯Œ Tooltip
        const formatter = (params) => {
            let s = params[0].name + '<br/>';
            for(let p of params) {
                if(p.seriesName==='Kçº¿') {
                    s += `å¼€:${p.data[1]} æ”¶:${p.data[2]} ä½:${p.data[3]} é«˜:${p.data[4]}<br/>`;
                } else s += `${p.seriesName}: ${p.value}<br/>`;
            }
            return s;
        };

        chart.setOption({
            tooltip:{trigger:'axis', formatter}, legend:{data:['Kçº¿','MA5','MA20']},
            xAxis:{data:d.dates}, yAxis:{scale:true}, dataZoom:[{type:'inside'}],
            series:[
                {name:'Kçº¿', type:'candlestick', data:d.values, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}},
                {name:'MA5', type:'line', data:d.mas.MA5, smooth:true},
                {name:'MA20', type:'line', data:d.mas.MA20, smooth:true}
            ]
        });
    };

    const addFav = async (row) => { await axios.post('/api/favorite/add/', {code:row.code}); ElementPlus.ElMessage.success('å·²æ”¶è—'); };
    onMounted(init);
    return { loading, filters, presets, results, runScan, showDetail, detailVisible, renderDetail, addFav };
}
</script>
{% endblock %}