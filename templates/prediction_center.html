{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ | AI Stock</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <style>
        body { margin: 0; padding: 0; background-color: #f0f2f5; font-family: sans-serif; }
        .el-aside { background: #001529; color: white; height: 100vh; }
        .el-header { background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .logo-area { height: 60px; line-height: 60px; text-align: center; font-weight: bold; font-size: 20px; color: white; background: #002140; }

        .predict-card { margin-top: 20px; text-align: center; padding: 30px; }
        .suggestion-box { font-size: 24px; font-weight: bold; margin: 20px 0; }
        .chart-box { height: 500px; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <el-aside width="220px">
                <div class="logo-area">ğŸ¤– æ™ºèƒ½å†³ç­–ç³»ç»Ÿ</div>
                <el-menu active-text-color="#409EFF" background-color="#001529" text-color="#fff" default-active="3">
                    <el-menu-item index="1" @click="goUrl('/api/chart/')"><i class="el-icon-s-home"></i><span>ç³»ç»Ÿé¦–é¡µ</span></el-menu-item>
                    <el-sub-menu index="2">
                        <template #title><span>æ¨¡å¼åŒ¹é…åˆ†æ</span></template>
                        <el-menu-item index="2-1" @click="goUrl('/api/chart/')">ç‰¹å®šèµ°åŠ¿ç­›é€‰</el-menu-item>
                        <el-menu-item index="2-2" @click="goUrl('/api/history/')">å†å²å›æµ‹è®°å½•</el-menu-item>
                    </el-sub-menu>
                    <el-menu-item index="3" @click="window.location.href='/api/prediction/'"><span>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ</span></el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header>
                    <h3>ğŸ”® AI é‡åŒ–é¢„æµ‹ä¸­å¿ƒ (LSTM Model)</h3>
                    <el-tag>V 1.0.0</el-tag>
                </el-header>

                <el-main>
                    <el-card shadow="hover">
                        <el-row :gutter="20">
                            <el-col :span="18">
                                <el-input v-model="stockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚ 000001)" size="large">
                                    <template #prepend>è‚¡ç¥¨ä»£ç </template>
                                </el-input>
                            </el-col>
                            <el-col :span="6">
                                <el-button type="primary" size="large" @click="runPrediction" :loading="loading" style="width: 100%">
                                    å¼€å§‹é¢„æµ‹æœªæ¥5æ—¥
                                </el-button>
                            </el-col>
                        </el-row>
                    </el-card>

                    <el-card v-if="result" class="predict-card" shadow="always">
                        <h3>ğŸ“ˆ [[ stockCode ]] é¢„æµ‹åˆ†ææŠ¥å‘Š</h3>

                        <div class="suggestion-box" :style="{ color: result.suggestion_color === 'red' ? '#F56C6C' : '#67C23A' }">
                            [[ result.suggestion ]]
                        </div>

                        <p>é¢„è®¡æœªæ¥5æ—¥ç´¯è®¡æ”¶ç›Šç‡:
                            <span :style="{ fontWeight: 'bold', color: result.final_return > 0 ? 'red' : 'green' }">
                                [[ result.final_return ]]%
                            </span>
                        </p>

                        <div id="predict-chart" class="chart-box"></div>
                    </el-card>
                </el-main>
            </el-container>
        </el-container>
    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>

    <script>
        const { createApp, ref } = Vue;
        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const stockCode = ref('000001');
                const loading = ref(false);
                const result = ref(null);
                let myChart = null;

                const goUrl = (url) => window.location.href = url;

                const runPrediction = async () => {
                    loading.value = true;
                    result.value = null;
                    try {
                        // æ¨¡æ‹ŸåŠ è½½æ—¶é—´ï¼Œè®©ç”¨æˆ·è§‰å¾—ç®—æ³•åœ¨åŠªåŠ›è®¡ç®—
                        await new Promise(r => setTimeout(r, 800));

                        const res = await axios.post('/api/prediction/run/', { code: stockCode.value });

                        if (res.data.code === 200) {
                            result.value = res.data.data;
                            // ç­‰å¾… DOM æ¸²æŸ“åå†ç”»å›¾
                            setTimeout(() => renderChart(), 100);
                            ElementPlus.ElMessage.success('é¢„æµ‹å®Œæˆ');
                        } else {
                            ElementPlus.ElMessage.error(res.data.msg);
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('ç³»ç»Ÿé”™è¯¯');
                    } finally {
                        loading.value = false;
                    }
                };

                const renderChart = () => {
                    const dom = document.getElementById('predict-chart');
                    myChart = echarts.init(dom);

                    const data = result.value;
                    // æ‹¼æ¥å†å²å’Œæœªæ¥æ•°æ®ï¼Œä¸­é—´ç¨å¾®æ–­å¼€æˆ–è¿æ¥
                    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æŠŠå†å²çš„æœ€åä¸€ä¸ªç‚¹ä½œä¸ºæœªæ¥çš„èµ·ç‚¹
                    const fullDates = [...data.history_dates, ...data.future_dates];

                    // å†å²æ•°æ®å¡«å…… (æœªæ¥éƒ¨åˆ†è¡¥ null)
                    const historySeries = [...data.history_prices, ...new Array(data.future_prices.length).fill(null)];

                    // æœªæ¥æ•°æ®å¡«å…… (å†å²éƒ¨åˆ†è¡¥ nullï¼Œæ³¨æ„è¡”æ¥)
                    // ä¸ºäº†è®©çº¿è¿èµ·æ¥ï¼ŒæŠŠå†å²æœ€åä¸€ä¸ªç‚¹åŠ è¿›å»
                    const lastHistoryPrice = data.history_prices[data.history_prices.length - 1];
                    const futureSeries = new Array(data.history_prices.length - 1).fill(null);
                    futureSeries.push(lastHistoryPrice);
                    futureSeries.push(...data.future_prices);

                    const option = {
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['å†å²èµ°åŠ¿', 'AIé¢„æµ‹èµ°åŠ¿'] },
                        xAxis: { type: 'category', data: fullDates },
                        yAxis: { scale: true },
                        series: [
                            {
                                name: 'å†å²èµ°åŠ¿',
                                type: 'line',
                                data: historySeries,
                                itemStyle: { color: '#333' },
                                showSymbol: false
                            },
                            {
                                name: 'AIé¢„æµ‹èµ°åŠ¿',
                                type: 'line',
                                data: futureSeries,
                                lineStyle: { type: 'dashed', width: 3, color: '#409EFF' }, // è™šçº¿
                                itemStyle: { color: '#409EFF' }
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                return { stockCode, loading, result, runPrediction, goUrl };
            }
        });
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>