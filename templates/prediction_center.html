{% extends 'base.html' %}
{% block title %}æ”¶ç›Šå›æµ‹ä¸AI{% endblock %}
{% block content %}
<el-container style="height: 85vh; border: 1px solid #eee">
    <el-aside width="250px" style="background:#fff; border-right:1px solid #ddd; padding:10px">
        <h4>â­ å¾…åˆ†æè‚¡ç¥¨</h4>
        <div v-for="item in favList" :key="item.code" class="fav-item" @click="selectStock(item.code)">
            [[item.name]] <span style="float:right; color:#999">[[item.code]]</span>
        </div>
        <div style="margin-top:20px; text-align:center">
            <el-button size="small" @click="go('/api/analysis/')">â• å»ç­›é€‰æ›´å¤š</el-button>
        </div>
    </el-aside>

    <el-main>
        <div style="margin-bottom:15px; display:flex; gap:10px">
            <el-input v-model="targetCode" placeholder="è¾“å…¥ä»£ç " style="width:200px"></el-input>
            <el-button type="primary" @click="runAll">å¼€å§‹åˆ†æ</el-button>
        </div>

        <el-tabs type="border-card">
            <el-tab-pane label="ğŸ”® AI è¶‹åŠ¿é¢„æµ‹">
                <div v-if="predictRes" style="text-align:center; padding:20px">
                    <h2>[[ predictRes.suggestion ]]</h2>
                    <p>æœªæ¥5æ—¥é¢„æœŸ: <b :style="{color: predictRes.final_return>0?'red':'green'}">[[ predictRes.final_return ]]%</b></p>
                </div>
                <div id="p-chart" style="height:400px"></div>
            </el-tab-pane>

            <el-tab-pane label="ğŸ“Š å†å²ç­–ç•¥å›æµ‹">
                <div v-if="backtestRes" style="display:flex; justify-content:space-around; padding:15px; background:#f9f9f9">
                    <div>æ”¶ç›Š: <b style="color:red">[[backtestRes.metrics.total_return]]%</b></div>
                    <div>å›æ’¤: <b style="color:green">[[backtestRes.metrics.max_drawdown]]%</b></div>
                    <div>èƒœç‡: <b>[[backtestRes.metrics.win_rate]]%</b></div>
                </div>
                <div id="b-chart" style="height:400px; margin-top:20px"></div>
            </el-tab-pane>
        </el-tabs>
    </el-main>
</el-container>
{% endblock %}

{% block scripts %}
<style>.fav-item { padding:10px; cursor:pointer; border-bottom:1px solid #eee } .fav-item:hover{background:#ecf5ff}</style>
<script>
function pageSetup() {
    const activeMenu = ref('3');
    const favList = ref([]);
    const targetCode = ref('000001');
    const predictRes = ref(null);
    const backtestRes = ref(null);
    let chartP=null, chartB=null;

    const go = (url) => window.location.href = url;

    onMounted(async () => {
        const res = await axios.get('/api/favorite/list/');
        favList.value = res.data.data;
    });

    const selectStock = (code) => { targetCode.value = code; runAll(); };

    const runAll = async () => {
        // AI é¢„æµ‹
        const res1 = await axios.post('/api/prediction/run/', {code: targetCode.value});
        predictRes.value = res1.data.data;
        setTimeout(() => {
            if(chartP) chartP.dispose();
            chartP = echarts.init(document.getElementById('p-chart'));
            const d = predictRes.value;
            const x = [...d.history_dates, ...d.future_dates];
            const y1 = d.history_prices;
            const y2 = Array(y1.length-1).fill(null).concat([y1[y1.length-1]], d.future_prices);
            chartP.setOption({
                tooltip:{trigger:'axis'}, xAxis:{data:x}, yAxis:{scale:true},
                series:[{type:'line', data:y1, name:'å†å²'}, {type:'line', data:y2, name:'é¢„æµ‹', lineStyle:{type:'dashed'}}]
            });
        }, 100);

        // å›æµ‹
        const res2 = await axios.post('/api/backtest/run/', {code: targetCode.value});
        backtestRes.value = res2.data.data;
        setTimeout(() => {
            if(chartB) chartB.dispose();
            chartB = echarts.init(document.getElementById('b-chart'));
            const d = backtestRes.value.chart;
            chartB.setOption({
                tooltip:{trigger:'axis'}, xAxis:{data:d.map(i=>i.date)}, yAxis:{scale:true},
                series:[{type:'line', data:d.map(i=>i.value), areaStyle:{opacity:0.2}}]
            });
        }, 100);
    };

    return { activeMenu, favList, targetCode, predictRes, backtestRes, selectStock, runAll, go };
}
</script>
{% endblock %}