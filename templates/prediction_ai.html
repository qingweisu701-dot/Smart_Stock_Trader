{% extends 'base.html' %}
{% block title %}AI趋势预测{% endblock %}
{% block content %}
<el-container style="height: 85vh; border: 1px solid #eee; background:#fff">
    <el-aside width="250px" style="border-right:1px solid #eee; padding:10px">
        <el-input v-model="code" placeholder="输入代码搜索" prefix-icon="Search" @change="runPredict"></el-input>
        <div style="margin-top:10px; color:#999; font-size:12px">我的收藏</div>
        <div v-for="item in favList" :key="item.code" class="fav-item" @click="code=item.code; runPredict()">
            [[item.name]] <span style="float:right">[[item.code]]</span>
        </div>
    </el-aside>
    <el-main>
        <div v-if="result" style="text-align:center">
            <h2 :style="{color: result.final_return>0?'red':'green'}">[[ result.suggestion ]]</h2>
            <p>未来5日涨幅预测: <b>[[ result.final_return ]]%</b></p>
        </div>
        <div id="chart" style="height:400px; width:100%"></div>
    </el-main>
</el-container>
{% endblock %}

{% block scripts %}
<style>.fav-item{padding:10px; cursor:pointer; border-bottom:1px solid #eee} .fav-item:hover{background:#f9f9f9}</style>
<script>
function pageSetup() {
    const code = ref('000001');
    const favList = ref([]);
    const result = ref(null);
    let chart = null;

    const runPredict = async () => {
        const res = await axios.post('/api/prediction/run/', {code: code.value});
        result.value = res.data.data;
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('chart'));

        const d = res.data.data;
        const x = [...d.history_dates, ...d.future_dates];
        const y1 = d.history_prices;
        const y2 = Array(y1.length-1).fill(null).concat([y1[y1.length-1]], d.future_prices);

        chart.setOption({
            tooltip:{trigger:'axis'}, xAxis:{data:x}, yAxis:{scale:true},
            series:[{type:'line', data:y1, name:'历史'}, {type:'line', data:y2, name:'AI预测', lineStyle:{type:'dashed'}}]
        });
    };

    onMounted(async () => {
        const res = await axios.get('/api/favorite/list/');
        favList.value = res.data.data;
        runPredict();
    });

    return { code, favList, result, runPredict };
}
</script>
{% endblock %}