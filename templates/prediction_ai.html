{% extends 'base.html' %}
{% block title %}AI æ™ºèƒ½é¢„æµ‹{% endblock %}

{% block content %}
<el-container style="height:85vh; padding:20px; background:#f0f2f5">
    <el-row :gutter="20" style="width:100%">
        <el-col :span="6">
            <el-card class="box-card" style="height:100%">
                <template #header>
                    <span>ğŸ¤– æ™ºèƒ½é¢„æµ‹é…ç½®</span>
                </template>

                <el-form label-position="top">
                    <el-form-item label="æ ‡çš„ä»£ç ">
                        <el-input v-model="stockCode" placeholder="å¦‚ 600519.SH" clearable></el-input>
                    </el-form-item>
                    <el-form-item label="é¢„æµ‹ç®—æ³•æ¨¡å‹">
                        <el-select v-model="selectedModel" style="width:100%">
                            <el-option label="LSTM æ—¶åºæ·±åº¦ç½‘ç»œ (æ¨è)" value="LSTM"></el-option>
                            <el-option label="RandomForest é›†æˆå­¦ä¹ " value="Ensemble"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-button type="primary" @click="runPredict" :loading="loading" style="width:100%" icon="VideoPlay">å¼€å§‹é¢„æµ‹</el-button>
                </el-form>

                <div v-if="result" style="margin-top:30px; border-top:1px solid #eee; padding-top:20px">
                    <div style="text-align:center">
                        <el-progress type="dashboard" :percentage="result.score" :color="scoreColor"></el-progress>
                        <div style="font-weight:bold; font-size:16px">[[result.suggestion]]</div>
                        <div style="font-size:12px; color:#999">åŸºäº [[result.model]] æ¨¡å‹</div>
                    </div>
                    <div style="margin-top:10px">
                        <div v-for="(f,i) in result.factors" :key="i" style="font-size:12px; margin-bottom:5px">
                            <el-tag size="small" :type="f.type==='bull'?'danger':'success'">[[f.name]]</el-tag> [[f.desc]]
                        </div>
                    </div>
                </div>
            </el-card>
        </el-col>

        <el-col :span="18">
            <el-card v-if="result" style="height:100%; display:flex; flex-direction:column">
                <template #header>
                    <span>ğŸ“ˆ è¶‹åŠ¿é¢„æµ‹ä¸å»ºè®® ([[result.code]])</span>
                </template>

                <el-row :gutter="20" style="margin-bottom:20px; text-align:center">
                    <el-col :span="6"><div style="background:#f9f9f9;padding:10px">å»ºè®®ä¹°å…¥<br><b style="color:#f56c6c">[[result.advice.buy_price]]</b></div></el-col>
                    <el-col :span="6"><div style="background:#f9f9f9;padding:10px">ç›®æ ‡æ­¢ç›ˆ<br><b style="color:#f56c6c">[[result.advice.sell_price]]</b></div></el-col>
                    <el-col :span="6"><div style="background:#f9f9f9;padding:10px">å»ºè®®å‘¨æœŸ<br><b style="color:#409eff">[[result.advice.period]]</b></div></el-col>
                    <el-col :span="6"><div style="background:#f9f9f9;padding:10px">é¢„æœŸæ”¶ç›Š<br><b style="color:#e6a23c">[[result.final_return]]%</b></div></el-col>
                </el-row>

                <div id="predict-chart" style="flex:1; min-height:400px"></div>
            </el-card>
            <el-empty v-else description="è¯·é…ç½®å‚æ•°åè¿è¡Œ"></el-empty>
        </el-col>
    </el-row>
</el-container>
{% endblock %}

{% block scripts %}
<script>
function pageSetup() {
    const { ref, onMounted, computed } = Vue;
    const stockCode = ref('');
    const selectedModel = ref('LSTM'); // é»˜è®¤æ¨¡å‹
    const loading = ref(false);
    const result = ref(null);
    let chart = null;

    onMounted(() => {
        const params = new URLSearchParams(window.location.search);
        if(params.get('code')) {
            stockCode.value = params.get('code');
            runPredict();
        }
    });

    const scoreColor = computed(() => {
        if(!result.value) return '#909399';
        return result.value.score >= 60 ? '#F56C6C' : '#67C23A';
    });

    const runPredict = async () => {
        if(!stockCode.value) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥ä»£ç ');
        loading.value = true;
        try {
            // ğŸ”¥ å‘é€æ¨¡å‹å‚æ•°
            const res = await axios.post('/api/prediction/run/', {
                code: stockCode.value,
                model: selectedModel.value
            });
            if(res.data.code === 200) {
                result.value = res.data.data;
                setTimeout(() => renderChart(res.data.data), 100);
            } else {
                ElementPlus.ElMessage.error(res.data.msg);
            }
        } catch(e) { ElementPlus.ElMessage.error('Error'); }
        finally { loading.value = false; }
    };

    const renderChart = (data) => {
        if(chart) chart.dispose();
        chart = echarts.init(document.getElementById('predict-chart'));

        const historyLen = data.history_dates.length;
        const allDates = [...data.history_dates, ...data.future_dates];
        const historySeries = data.history_prices.concat(new Array(data.future_prices.length).fill(null));
        const futureSeries = new Array(historyLen-1).fill(null);
        futureSeries.push(data.history_prices[historyLen-1]);
        futureSeries.push(...data.future_prices);

        chart.setOption({
            tooltip: { trigger: 'axis' },
            legend: { data: ['å†å²', 'é¢„æµ‹'] },
            xAxis: { data: allDates },
            yAxis: { scale: true },
            series: [
                { name: 'å†å²', type: 'line', data: historySeries, itemStyle: { color: '#333' } },
                { name: 'é¢„æµ‹', type: 'line', data: futureSeries, itemStyle: { color: '#f56c6c' }, lineStyle: { type: 'dashed' } }
            ]
        });
    };

    return { stockCode, selectedModel, loading, result, runPredict, scoreColor };
}
</script>
{% endblock %}