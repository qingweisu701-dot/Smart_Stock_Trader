{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½è‚¡ç¥¨åˆ†æç³»ç»Ÿ | Proç‰ˆ</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background-color: #f0f2f5; }
        .el-aside { background-color: #001529; color: white; height: 100vh; transition: width 0.3s; }
        .logo-area { height: 60px; line-height: 60px; text-align: center; font-size: 20px; font-weight: bold; background: #002140; color: white; }
        .el-header { background-color: #fff; box-shadow: 0 1px 4px rgba(0,21,41,.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .main-card { margin-bottom: 20px; border-radius: 4px; }
        .chart-container { height: 600px; width: 100%; }
        .drawing-cursor { cursor: crosshair !important; }
        .result-section { margin-top: 20px; border-top: 5px solid #409EFF; }
    </style>
</head>
<body>

    <div id="app">
        <el-container>
            <el-aside width="220px">
                <div class="logo-area">ğŸ¤– æ™ºèƒ½å†³ç­–ç³»ç»Ÿ</div>
                <el-menu active-text-color="#409EFF" background-color="#001529" text-color="#fff" default-active="2-1">
                    <el-menu-item index="1"><i class="el-icon-s-home"></i><span>ç³»ç»Ÿé¦–é¡µ</span></el-menu-item>
                    <el-sub-menu index="2">
                        <template #title><span>æ¨¡å¼åŒ¹é…åˆ†æ</span></template>
                        <el-menu-item index="2-1">ç‰¹å®šèµ°åŠ¿ç­›é€‰</el-menu-item>
                        <el-menu-item index="2-2" @click="goUrl('/api/history/')">å†å²å›æµ‹è®°å½•</el-menu-item>
                    </el-sub-menu>
                    <el-menu-item index="3" @click="goUrl('/api/prediction/')"><span>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ</span></el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header>
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item>é¦–é¡µ</el-breadcrumb-item>
                        <el-breadcrumb-item>æ¨¡å¼åŒ¹é…åˆ†æ</el-breadcrumb-item>
                        <el-breadcrumb-item>å¤šå› å­ç­›é€‰</el-breadcrumb-item>
                    </el-breadcrumb>
                    <div><el-avatar size="small" style="background: #409EFF">User</el-avatar></div>
                </el-header>

                <el-main>
                    <el-card class="main-card" shadow="hover">
                        <el-row :gutter="20" align="middle" style="margin-bottom: 15px;">
                            <el-col :span="5">
                                <el-input v-model="stockCode" placeholder="ä»£ç  (å¦‚ 000001)" prefix-icon="Search"></el-input>
                            </el-col>
                            <el-col :span="19">
                                <el-button type="primary" @click="fetchData" :loading="loading" plain>æŸ¥è¯¢Kçº¿</el-button>
                                <el-divider direction="vertical"></el-divider>

                                <el-radio-group v-model="tradeMode" size="default" style="margin-right: 15px">
                                    <el-radio-button label="BUY">ğŸ“ˆ æ‰¾ä¹°ç‚¹</el-radio-button>
                                    <el-radio-button label="SELL">ğŸ“‰ æ‰¾å–ç‚¹</el-radio-button>
                                </el-radio-group>

                                <el-button :type="isDrawing ? 'danger' : 'warning'" icon="Edit" @click="toggleDrawing">
                                    [[ isDrawing ? 'åœæ­¢ç»˜åˆ¶' : 'æ‰‹ç»˜é¢„æœŸå½¢æ€' ]]
                                </el-button>
                                <el-button type="info" icon="Delete" @click="clearCanvas" circle plain></el-button>
                            </el-col>
                        </el-row>

                        <el-row :gutter="20" align="middle" style="background: #f9fafc; padding: 10px; border-radius: 4px;">
                            <el-col :span="2" style="text-align: right; color: #666; font-size: 14px;">
                                ğŸ¯ ç­›é€‰æ¡ä»¶:
                            </el-col>

                            <el-col :span="4">
                                <el-select v-model="filters.sector" placeholder="æ‰€å±è¡Œä¸š" clearable size="small">
                                    <el-option label="é‡‘èè¡Œä¸š" value="Finance"></el-option>
                                    <el-option label="ç§‘æŠ€åŠå¯¼ä½“" value="Tech"></el-option>
                                    <el-option label="æ–°èƒ½æº" value="Energy"></el-option>
                                    <el-option label="åŒ»è¯åŒ»ç–—" value="Medical"></el-option>
                                </el-select>
                            </el-col>

                            <el-col :span="6">
                                <div style="display: flex; align-items: center;">
                                    <el-input v-model="filters.minPrice" placeholder="æœ€ä½ä»·" size="small" style="width: 80px"></el-input>
                                    <span style="margin: 0 5px">-</span>
                                    <el-input v-model="filters.maxPrice" placeholder="æœ€é«˜ä»·" size="small" style="width: 80px"></el-input>
                                    <span style="margin-left: 5px; font-size: 12px; color: #999">å…ƒ</span>
                                </div>
                            </el-col>

                            <el-col :span="5">
                                <el-select v-model="filters.marketCap" placeholder="å¸‚å€¼è§„æ¨¡" clearable size="small">
                                    <el-option label="å¤§ç›˜è‚¡ (>1000äº¿)" value="LARGE"></el-option>
                                    <el-option label="ä¸­å°ç›˜ (<500äº¿)" value="SMALL"></el-option>
                                </el-select>
                            </el-col>

                            <el-col :span="7" style="text-align: right;">
                                <el-button type="success" icon="Cpu" @click="submitPattern">
                                    å¼€å§‹æ™ºèƒ½åŒ¹é… (DTW)
                                </el-button>
                            </el-col>
                        </el-row>

                        <div style="margin-top: 5px; text-align: right;">
                             <span style="margin-left: 15px; color: #909399; font-size: 13px;">[[ statusText ]]</span>
                        </div>
                    </el-card>

                    <el-card class="main-card" shadow="always" body-style="padding: 0px;">
                        <div id="main-chart" class="chart-container" :class="{ 'drawing-cursor': isDrawing }"></div>
                    </el-card>

                    <el-card v-if="matchResult.length > 0" class="main-card result-section">
                        <template #header>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; font-size: 16px;">
                                    ğŸ¯ åŒ¹é…ç»“æœ ([[ tradeMode === 'BUY' ? 'æ½œåœ¨ä¹°å…¥æœºä¼š' : 'æ½œåœ¨å–å‡ºé£é™©' ]])
                                </span>
                                <el-tag type="success">è®¡ç®—å®Œæˆ</el-tag>
                            </div>
                        </template>

                        <el-table :data="matchResult" stripe style="width: 100%" border>
                            <el-table-column prop="code" label="ä»£ç " width="100">
                                <template #default="scope"><el-tag effect="dark">[[ scope.row.code ]]</el-tag></template>
                            </el-table-column>

                            <el-table-column prop="date" label="è§¦å‘æ—¥æœŸ" width="120"></el-table-column>

                            <el-table-column prop="trigger" label="è§¦å‘ä¿¡å· (Trigger)" width="180">
                                <template #default="scope">
                                    <el-tag :type="tradeMode === 'BUY' ? 'danger' : 'success'" effect="plain" style="font-weight: bold;">
                                        âš¡ [[ scope.row.trigger ]]
                                    </el-tag>
                                </template>
                            </el-table-column>

                            <el-table-column prop="score" label="å½¢æ€ç›¸ä¼¼åº¦" width="120" sortable>
                                <template #default="scope">
                                    <span style="font-weight: bold; color: #F56C6C">[[ scope.row.score ]] åˆ†</span>
                                </template>
                            </el-table-column>

                            <el-table-column prop="price" label="å½“å‰ä»·">
                                <template #default="scope">Â¥ [[ scope.row.price ]]</template>
                            </el-table-column>

                            <el-table-column label="æ“ä½œ" width="220">
                                <template #default="scope">
                                    <el-button size="small" @click="stockCode = scope.row.code; fetchData()">è¯¦æƒ…</el-button>
                                    <el-button size="small" type="primary" @click="handleTrade(scope.row)">
                                        æ¨¡æ‹Ÿ[[ tradeMode === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º' ]]
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </el-main>
            </el-container>
        </el-container>
    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // 1. å®šä¹‰æ‰€æœ‰å˜é‡ (Refs)
                const stockCode = ref('000001');
                const loading = ref(false);
                const isDrawing = ref(false);
                const statusText = ref('å°±ç»ª');
                const matchResult = ref([]);
                const tradeMode = ref('BUY');

                // æ–°å¢ï¼šç­›é€‰æ¡ä»¶
                const filters = ref({
                    sector: '',
                    minPrice: '',
                    maxPrice: '',
                    marketCap: ''
                });

                let myChart = null;
                let drawingSeriesData = [];

                // 2. é¡µé¢è·³è½¬è¾…åŠ©
                const goUrl = (url) => window.location.href = url;

                // 3. åˆå§‹åŒ–å›¾è¡¨
                const initChart = () => {
                    const chartDom = document.getElementById('main-chart');
                    myChart = echarts.init(chartDom);
                    const zr = myChart.getZr();

                    zr.on('mousedown', () => {
                        if (!isDrawing.value) return;
                        drawingSeriesData = [];
                        myChart.setOption({ tooltip: { show: false } });
                        statusText.value = 'æ­£åœ¨ç»˜åˆ¶...';
                    });

                    zr.on('mousemove', params => {
                        if (!isDrawing.value || !params.target) return;
                        const pt = myChart.convertFromPixel({ seriesIndex: 0 }, [params.offsetX, params.offsetY]);
                        if (pt) {
                            drawingSeriesData.push(pt);
                            myChart.setOption({ series: [{}, {}, {}, {}, {}, { data: drawingSeriesData }] });
                        }
                    });

                    zr.on('mouseup', () => {
                        if (isDrawing.value) {
                             myChart.setOption({ tooltip: { show: true } });
                             statusText.value = 'ç»˜åˆ¶å®Œæˆ';
                        }
                    });
                    window.onresize = () => myChart.resize();
                };

                // 4. è·å–æ•°æ®
                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`/api/kline/?code=${stockCode.value}`);
                        if (res.data.code === 200) {
                            const d = res.data.data;
                            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é…åˆåç«¯æ–°çš„è¿”å›ç»“æ„ (mas, volumes)
                            // å¦‚æœåç«¯è¿˜æ²¡æ”¹å¥½ï¼Œå¯èƒ½ä¼šæŠ¥é”™ã€‚ç¡®ä¿åç«¯ views.py ä¹Ÿæ˜¯æœ€æ–°ç‰ˆ
                            renderChart(d.dates, d.values, d.mas, d.volumes);
                        } else { ElementPlus.ElMessage.error(res.data.msg); }
                    } catch (e) { ElementPlus.ElMessage.error('è¯·æ±‚å¤±è´¥'); }
                    finally { loading.value = false; }
                };

                // 5. æ¸²æŸ“å›¾è¡¨ (åŒ…å«å‡çº¿å’Œæˆäº¤é‡)
                const renderChart = (dates, values, mas, volumes) => {
                    // å®¹é”™å¤„ç†ï¼šå¦‚æœåç«¯æ²¡ä¼  mas (è¿˜æ˜¯æ—§æ¥å£)ï¼Œç»™ä¸ªç©ºå¯¹è±¡é˜²æ­¢æŠ¥é”™
                    mas = mas || { MA5:[], MA10:[], MA20:[] };
                    volumes = volumes || [];

                    const option = {
                        backgroundColor: '#fff',
                        animation: false,
                        tooltip: {
                            trigger: 'axis', axisPointer: { type: 'cross' },
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderWidth: 1, borderColor: '#ccc', textStyle: { color: '#000' }
                        },
                        axisPointer: { link: { xAxisIndex: 'all' } },
                        legend: { data: ['æ—¥K', 'MA5', 'MA10', 'MA20', 'æˆäº¤é‡', 'é¢„æœŸå½¢æ€'], top: 10 },
                        grid: [
                            { left: '5%', right: '5%', height: '60%', top: '10%' },
                            { left: '5%', right: '5%', top: '75%', height: '15%' }
                        ],
                        xAxis: [
                            { type: 'category', data: dates, scale: true, boundaryGap: false, axisLine: { onZero: false }, splitLine: { show: false }, min: 'dataMin', max: 'dataMax' },
                            { type: 'category', gridIndex: 1, data: dates, scale: true, boundaryGap: false, axisLine: { onZero: false }, axisTick: { show: false }, axisLabel: { show: false }, min: 'dataMin', max: 'dataMax' }
                        ],
                        yAxis: [
                            { scale: true, splitLine: { show: true, lineStyle: { color: '#eee' } } },
                            { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisLine: { show: false }, splitLine: { show: false } }
                        ],
                        dataZoom: [
                            { type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 },
                            { type: 'slider', xAxisIndex: [0, 1], bottom: 0, start: 50, end: 100 }
                        ],
                        series: [
                            { name: 'æ—¥K', type: 'candlestick', data: values, itemStyle: { color: '#F56C6C', color0: '#00C853', borderColor: '#F56C6C', borderColor0: '#00C853' } },
                            { name: 'MA5', type: 'line', data: mas.MA5, smooth: true, lineStyle: { opacity: 0.8, width: 1, color: '#f6bd16' }, showSymbol: false },
                            { name: 'MA10', type: 'line', data: mas.MA10, smooth: true, lineStyle: { opacity: 0.8, width: 1, color: '#5b8ff9' }, showSymbol: false },
                            { name: 'MA20', type: 'line', data: mas.MA20, smooth: true, lineStyle: { opacity: 0.8, width: 1, color: '#9d58f9' }, showSymbol: false },
                            {
                                name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: volumes,
                                itemStyle: { color: (params) => params.value[2] === 1 ? '#F56C6C' : '#00C853' }
                            },
                            {
                                name: 'é¢„æœŸå½¢æ€', type: 'line', smooth: 0.3, symbol: 'none',
                                lineStyle: { color: '#E6A23C', width: 3, type: 'solid' },
                                data: [], z: 999
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                // 6. äº¤äº’é€»è¾‘
                const toggleDrawing = () => {
                    isDrawing.value = !isDrawing.value;
                    statusText.value = isDrawing.value ? 'è¯·æŒ‰ä½é¼ æ ‡å·¦é”®ç»˜å›¾' : 'ä»…æµè§ˆ';
                    if (isDrawing.value) {
                        drawingSeriesData = [];
                        // é‡ç½®æ—¶è¦ä¿ç•™6ä¸ªç³»åˆ—çš„ä½ç½®ï¼Œåªæ¸…ç©ºæœ€åä¸€ä¸ª
                        myChart.setOption({ series: [{}, {}, {}, {}, {}, { data: [] }] });
                    }
                };

                const clearCanvas = () => {
                    drawingSeriesData = [];
                    myChart.setOption({ series: [{}, {}, {}, {}, {}, { data: [] }] });
                    matchResult.value = [];
                };

                // 7. æäº¤åŒ¹é…
                const submitPattern = async () => {
                    if (drawingSeriesData.length < 5) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆç»˜åˆ¶å½¢æ€'); return;
                    }
                    const loadingInst = ElementPlus.ElLoading.service({ text: 'æ­£åœ¨å¤šå› å­ç­›é€‰ä¸åŒ¹é…...', background: 'rgba(255,255,255,0.8)' });

                    try {
                        const res = await axios.post('/api/match/', {
                            prices: drawingSeriesData.map(i => i[1]),
                            mode: tradeMode.value,
                            filters: filters.value // å‘é€ç­›é€‰æ¡ä»¶
                        });
                        if (res.data.code === 200) {
                            matchResult.value = res.data.data;
                            ElementPlus.ElMessage.success(`åŒ¹é…å®Œæˆï¼Œæ‰¾åˆ° ${matchResult.value.length} ä¸ªæœºä¼š`);
                            setTimeout(() => document.querySelector('.result-section')?.scrollIntoView({ behavior: 'smooth' }), 300);
                        } else { ElementPlus.ElMessage.warning(res.data.msg); }
                    } catch (e) { ElementPlus.ElMessage.error('ç³»ç»Ÿé”™è¯¯'); }
                    finally { loadingInst.close(); }
                };

                const handleTrade = async (row) => {
                    try {
                        await axios.post('/api/order/', {
                            code: row.code, date: row.date, type: tradeMode.value,
                            price: row.price, volume: 100, trigger: row.trigger
                        });
                        ElementPlus.ElMessage.success(`äº¤æ˜“æˆåŠŸï¼š${row.code}`);
                    } catch (e) { ElementPlus.ElMessage.error('äº¤æ˜“å¤±è´¥'); }
                };

                onMounted(() => { initChart(); fetchData(); });

                // 8. å¿…é¡»åœ¨æœ€åè¿”å›æ‰€æœ‰å˜é‡å’Œå‡½æ•°
                return {
                    stockCode, loading, isDrawing, statusText, matchResult, tradeMode, filters,
                    fetchData, toggleDrawing, clearCanvas, submitPattern, handleTrade, goUrl
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
        app.mount('#app');
    </script>
</body>
</html>