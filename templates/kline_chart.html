{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½è‚¡ç¥¨åˆ†æç³»ç»Ÿ | Ultimate</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background-color: #f0f2f5; }
        .el-aside { background-color: #001529; color: white; height: 100vh; transition: width 0.3s; }
        .logo-area { height: 60px; line-height: 60px; text-align: center; font-size: 20px; font-weight: bold; background: #002140; color: white; }
        .el-header { background-color: #fff; box-shadow: 0 1px 4px rgba(0,21,41,.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .main-card { margin-bottom: 20px; border-radius: 4px; }
        .chart-container { height: 600px; width: 100%; }
        .drawing-cursor { cursor: crosshair !important; }
        .result-section { margin-top: 20px; border-top: 5px solid #409EFF; }
        .input-table .el-input__inner { padding: 0 5px; text-align: center; }
        .strategy-tag { margin-right: 10px; margin-bottom: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="app">
        <el-container>
            <el-aside width="220px">
                <div class="logo-area">ğŸ¤– æ™ºèƒ½å†³ç­–ç³»ç»Ÿ</div>
                <el-menu active-text-color="#409EFF" background-color="#001529" text-color="#fff" default-active="2-1">
                    <el-menu-item index="1"><i class="el-icon-s-home"></i><span>ç³»ç»Ÿé¦–é¡µ</span></el-menu-item>
                    <el-sub-menu index="2">
                        <template #title><span>æ¨¡å¼åŒ¹é…åˆ†æ</span></template>
                        <el-menu-item index="2-1">ç‰¹å®šèµ°åŠ¿ç­›é€‰</el-menu-item>
                        <el-menu-item index="2-2" @click="goUrl('/api/history/')">å†å²å›æµ‹è®°å½•</el-menu-item>
                    </el-sub-menu>
                    <el-menu-item index="3" @click="goUrl('/api/prediction/')"><span>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ</span></el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header>
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item>é¦–é¡µ</el-breadcrumb-item>
                        <el-breadcrumb-item>æ¨¡å¼åŒ¹é…åˆ†æ</el-breadcrumb-item>
                        <el-breadcrumb-item>å¤šå› å­ç­–ç•¥ç»„åˆ</el-breadcrumb-item>
                    </el-breadcrumb>
                    <div><el-avatar size="small" style="background: #409EFF">User</el-avatar></div>
                </el-header>

                <el-main>
                    <el-card class="main-card" shadow="hover">
                        <el-row :gutter="20" align="middle" style="margin-bottom: 15px;">
                            <el-col :span="5">
                                <el-input v-model="stockCode" placeholder="ä»£ç  (å¦‚ 000001)" prefix-icon="Search"></el-input>
                            </el-col>
                            <el-col :span="19">
                                <el-button type="primary" @click="fetchData" :loading="loading" plain>æŸ¥è¯¢Kçº¿</el-button>
                                <el-divider direction="vertical"></el-divider>

                                <el-button :type="isDrawing ? 'danger' : 'warning'" icon="Edit" @click="toggleDrawing">
                                    [[ isDrawing ? 'åœæ­¢ç»˜åˆ¶' : 'æ‰‹ç»˜å½¢æ€' ]]
                                </el-button>
                                <el-button type="primary" icon="Grid" @click="openTableDialog" plain>è¡¨æ ¼å®šä¹‰</el-button>
                                <el-button type="info" icon="Delete" @click="clearCanvas" circle plain style="margin-left: 10px"></el-button>
                            </el-col>
                        </el-row>

                       <el-row :gutter="10" align="middle" style="background: #f9fafc; padding: 15px; border-radius: 4px;">
                            <el-col :span="2" style="text-align: right; color: #666; font-size: 14px; font-weight: bold;">
                                ğŸ¯ åŸºç¡€ç­›é€‰:
                            </el-col>

                            <el-col :span="3">
                                <el-input v-model="filters.codeQuery" placeholder="ä»£ç è¿‡æ»¤" size="small" clearable prefix-icon="Search"></el-input>
                            </el-col>

                            <el-col :span="3">
                                <el-select v-model="filters.sector" placeholder="æ‰€å±è¡Œä¸š" clearable size="small">
                                    <el-option label="é‡‘èè¡Œä¸š" value="Finance"></el-option>
                                    <el-option label="ç§‘æŠ€åŠå¯¼ä½“" value="Tech"></el-option>
                                    <el-option label="æ–°èƒ½æº" value="Energy"></el-option>
                                </el-select>
                            </el-col>

                            <el-col :span="5">
                                <div style="display: flex; align-items: center;">
                                    <el-input v-model="filters.minPrice" placeholder="æœ€ä½ä»·" size="small" style="width: 70px"></el-input>
                                    <span style="margin: 0 5px; color:#ccc">-</span>
                                    <el-input v-model="filters.maxPrice" placeholder="æœ€é«˜ä»·" size="small" style="width: 70px"></el-input>
                                </div>
                            </el-col>

                            <el-col :span="6">
                                <el-button type="warning" icon="Setting" plain size="small" style="width: 100%" @click="strategyDialogVisible = true">
                                    é…ç½®æŒ‡æ ‡ç­–ç•¥
                                    <span v-if="selectedStrategies.length > 0" style="margin-left: 5px; font-weight: bold">
                                        ([[ selectedStrategies.length ]])
                                    </span>
                                </el-button>
                            </el-col>

                            <el-col :span="5" style="text-align: right;">
                                <el-button type="success" icon="Cpu" size="default" @click="submitPattern" style="width: 100%">
                                    å¼€å§‹åŒ¹é…
                                </el-button>
                            </el-col>
                        </el-row>

                        <div v-if="selectedStrategies.length > 0" style="margin-top: 10px; padding-left: 20px;">
                            <span style="font-size: 13px; color: #666; margin-right: 10px;">å½“å‰ç»„åˆ ([[ strategyLogic === 'AND' ? 'ä¸”' : 'æˆ–' ]]): </span>
                            <el-tag v-for="tag in selectedStrategies" :key="tag" size="small" class="strategy-tag" effect="dark" type="warning">
                                [[ getStrategyLabel(tag) ]]
                            </el-tag>
                        </div>

                        <div style="margin-top: 5px; text-align: right;">
                             <span style="margin-left: 15px; color: #909399; font-size: 13px;">[[ statusText ]]</span>
                        </div>
                    </el-card>

                    <el-card class="main-card" shadow="always" body-style="padding: 0px;">
                        <div id="main-chart" class="chart-container" :class="{ 'drawing-cursor': isDrawing }"></div>
                    </el-card>

                    <el-card v-if="matchResult.length > 0" class="main-card result-section">
                        <template #header>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; font-size: 16px;">ğŸ¯ åŒ¹é…ç»“æœ Top 5</span>
                                <el-tag type="success">è®¡ç®—å®Œæˆ</el-tag>
                            </div>
                        </template>

                        <el-table :data="matchResult" stripe style="width: 100%" border>
                            <el-table-column prop="code" label="ä»£ç " width="100">
                                <template #default="scope"><el-tag effect="dark">[[ scope.row.code ]]</el-tag></template>
                            </el-table-column>
                            <el-table-column prop="trigger" label="è§¦å‘ç­–ç•¥" width="180">
                                <template #default="scope">
                                    <el-tag :type="scope.row.trigger !== 'ä¸æ»¡è¶³ç­–ç•¥' ? 'danger' : 'info'" effect="plain">
                                        [[ scope.row.trigger ]]
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="score" label="ç»¼åˆå¾—åˆ†" width="120" sortable>
                                <template #default="scope">
                                    <span style="font-weight: bold; color: #F56C6C">[[ scope.row.score ]]</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="price" label="å½“å‰ä»·">
                                <template #default="scope">Â¥ [[ scope.row.price ]]</template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" width="220">
                                <template #default="scope">
                                    <el-button size="small" @click="stockCode = scope.row.code; fetchData()">è¯¦æƒ…</el-button>
                                    <el-button size="small" type="primary" @click="handleTrade(scope.row)">æ¨¡æ‹Ÿäº¤æ˜“</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </el-main>
            </el-container>

            <el-dialog v-model="tableDialogVisible" title="é€šè¿‡æ•°æ®å®šä¹‰ K çº¿ç»„åˆå›¾å½¢" width="60%">
                <div style="margin-bottom: 10px">
                    <el-button size="small" type="primary" @click="addTableRow" plain>+ æ–°å¢ä¸€è¡Œ</el-button>
                </div>
                <el-table :data="inputTableData" border style="width: 100%" max-height="300" size="small" class="input-table">
                    <el-table-column label="æ—¥æœŸ" width="140"><template #default="scope"><el-input v-model="scope.row.date" placeholder="YYYY-MM-DD"></el-input></template></el-table-column>
                    <el-table-column label="æ”¶ç›˜ä»· (å…³é”®)"><template #default="scope"><el-input v-model="scope.row.close" type="number" style="font-weight: bold; color: #409EFF"></el-input></template></el-table-column>
                    <el-table-column label="æ“ä½œ" width="60"><template #default="scope"><el-button type="danger" icon="Delete" circle size="small" @click="deleteRow(scope.$index)"></el-button></template></el-table-column>
                </el-table>
                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="tableDialogVisible = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="generateFromTable">ç”Ÿæˆå¹¶åŒ¹é…</el-button>
                    </span>
                </template>
            </el-dialog>

            <el-dialog v-model="strategyDialogVisible" title="æ„å»ºå¤šå› å­ç­–ç•¥ç»„åˆ" width="40%">
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">è¯·å‹¾é€‰éœ€è¦ç»“åˆçš„æŠ€æœ¯æŒ‡æ ‡æ¡ä»¶ï¼š</p>

                <el-checkbox-group v-model="selectedStrategies">
                    <div style="margin-bottom: 10px; font-weight: bold;">è¶‹åŠ¿ç±»ï¼š</div>
                    <el-checkbox label="MACD_GOLD">MACD é‡‘å‰ (è¶‹åŠ¿å¯åŠ¨)</el-checkbox>
                    <el-checkbox label="MACD_DEAD">MACD æ­»å‰ (è¶‹åŠ¿ç»“æŸ)</el-checkbox>
                    <el-checkbox label="MA_LONG">å‡çº¿å¤šå¤´æ’åˆ— (&gt;MA5&gt;MA20)</el-checkbox>
                    <el-checkbox label="MA_SHORT">å‡çº¿ç©ºå¤´æ’åˆ— (&lt;MA5&lt;MA20)</el-checkbox>

                    <div style="margin: 15px 0 10px; font-weight: bold;">éœ‡è¡ç±»ï¼š</div>
                    <el-checkbox label="RSI_LOW">RSI è¶…å– (&lt;30 æŠ„åº•)</el-checkbox>
                    <el-checkbox label="RSI_HIGH">RSI è¶…ä¹° (&gt;70 é€ƒé¡¶)</el-checkbox>
                </el-checkbox-group>

                <el-divider></el-divider>

                <div style="display: flex; align-items: center;">
                    <span style="margin-right: 15px; font-weight: bold;">ç»„åˆé€»è¾‘å…³ç³»ï¼š</span>
                    <el-radio-group v-model="strategyLogic">
                        <el-radio label="AND">æ»¡è¶³æ‰€æœ‰æ¡ä»¶ (AND)</el-radio>
                        <el-radio label="OR">æ»¡è¶³ä»»ä¸€æ¡ä»¶ (OR)</el-radio>
                    </el-radio-group>
                </div>

                <template #footer>
                    <span class="dialog-footer">
                        <el-button @click="strategyDialogVisible = false">å®Œæˆé…ç½®</el-button>
                    </span>
                </template>
            </el-dialog>

        </el-container>
    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // 1. å˜é‡å®šä¹‰
                const stockCode = ref('000001');
                const loading = ref(false);
                const isDrawing = ref(false);
                const statusText = ref('å°±ç»ª');
                const matchResult = ref([]);
                const tradeMode = ref('BUY');
                // æ–°å¢äº† codeQuery å­—æ®µ
                const filters = ref({
                    codeQuery: '', // <--- æ–°å¢
                    sector: '',
                    minPrice: '',
                    maxPrice: '',
                    marketCap: ''
                });

                // å¼¹çª—å˜é‡
                const tableDialogVisible = ref(false);
                const inputTableData = ref([
                     { date: '2023-01-01', close: 10.2 }, { date: '2023-01-02', close: 10.4 },
                     { date: '2023-01-03', close: 10.1 }, { date: '2023-01-04', close: 9.6 },
                     { date: '2023-01-05', close: 9.8 }
                ]);

                // ç­–ç•¥å˜é‡
                const strategyDialogVisible = ref(false);
                const selectedStrategies = ref([]);
                const strategyLogic = ref('OR');

                let myChart = null;
                let drawingSeriesData = [];
                let isMouseDown = false;

                const strategyLabels = {
                    'MACD_GOLD': 'MACDé‡‘å‰', 'MACD_DEAD': 'MACDæ­»å‰',
                    'MA_LONG': 'å‡çº¿å¤šå¤´', 'MA_SHORT': 'å‡çº¿ç©ºå¤´',
                    'RSI_LOW': 'RSIè¶…å–', 'RSI_HIGH': 'RSIè¶…ä¹°'
                };
                const getStrategyLabel = (tag) => strategyLabels[tag] || tag;

                // 2. åˆå§‹åŒ–å›¾è¡¨
                const initChart = () => {
                    const chartDom = document.getElementById('main-chart');
                    if (!chartDom) return;
                    myChart = echarts.init(chartDom);
                    const zr = myChart.getZr();

                    zr.on('mousedown', () => {
                        if (!isDrawing.value) return;
                        isMouseDown = true;
                        myChart.setOption({ tooltip: { show: false } });
                        drawingSeriesData = [];
                        statusText.value = 'æ­£åœ¨ç»˜åˆ¶...';
                    });
                    zr.on('mousemove', params => {
                        if (!isDrawing.value || !isMouseDown) return;
                        const pt = myChart.convertFromPixel({ seriesIndex: 0 }, [params.offsetX, params.offsetY]);
                        if (pt) {
                            drawingSeriesData.push(pt);
                            updateDrawingLine(drawingSeriesData);
                        }
                    });
                    zr.on('mouseup', () => {
                        if (isDrawing.value && isMouseDown) {
                             isMouseDown = false;
                             myChart.setOption({ tooltip: { show: true } });
                             statusText.value = 'ç»˜åˆ¶å®Œæˆ';
                        }
                    });
                    zr.on('globalout', () => isMouseDown = false);
                    window.onresize = () => myChart.resize();
                };

                const updateDrawingLine = (data) => {
                    myChart.setOption({
                        series: [{
                            id: 'user-drawing-line',
                            type: 'line', smooth: 0.3, symbol: 'none',
                            lineStyle: { color: '#E6A23C', width: 4, type: 'solid' },
                            z: 9999, xAxisIndex: 0, yAxisIndex: 0, data: data
                        }]
                    }, { lazyUpdate: false });
                };

                // 3. æ¸²æŸ“å›¾è¡¨
                const renderChart = (dates, values, mas, volumes) => {
                    mas = mas || { MA5:[], MA10:[], MA20:[] };
                    volumes = volumes || [];
                    const option = {
                        backgroundColor: '#fff', animation: false,
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)', // èƒŒæ™¯ç¨å¾®é€æ˜ä¸€ç‚¹
                            borderColor: '#ccc',
                            borderWidth: 1,
                            textStyle: { color: '#333' }, // å¼ºåˆ¶æ–‡å­—é¢œè‰²
                            formatter: function (params) {
                                let result = '';
                                if (!params || params.length === 0) return '';

                                // 1. æ˜¾ç¤ºæ—¥æœŸ (å–ç¬¬ä¸€ä¸ªæ•°æ®çš„è½´æ ‡ç­¾)
                                result += `<div style="font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px;">${params[0].axisValue}</div>`;

                                params.forEach(function (item) {
                                    // === Kçº¿æ•°æ® (SeriesType: candlestick) ===
                                    if (item.seriesType === 'candlestick') {
                                        // item.value åœ¨ ECharts ä¸­é€šå¸¸æ˜¯ [index, open, close, lowest, highest, ...]
                                        // æˆ‘ä»¬çš„æ•°æ®æºé¡ºåºæ˜¯ df[['open', 'close', 'low', 'high', 'vol']]
                                        // æ˜ å°„åï¼švalue[1]=å¼€ç›˜, value[2]=æ”¶ç›˜, value[3]=æœ€ä½, value[4]=æœ€é«˜
                                        const open = item.value[1];
                                        const close = item.value[2];
                                        const low = item.value[3];
                                        const high = item.value[4];

                                        // è®¡ç®—æ¶¨è·Œå¹… (ä¸ºäº†æ˜¾ç¤ºå¥½çœ‹)
                                        let change = 0;
                                        if (open !== 0) {
                                            change = (close - open) / open * 100;
                                        }
                                        const color = change >= 0 ? '#F56C6C' : '#00C853'; // çº¢æ¶¨ç»¿è·Œ
                                        const sign = change >= 0 ? '+' : '';

                                        // æ‹¼å‡‘ä¸­æ–‡ HTML
                                        result += `
                                            <div style="margin-bottom: 5px;">
                                                <span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${item.color};"></span>
                                                <span style="font-weight: bold;">${item.seriesName}</span>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; font-family: monospace; color: #666; margin-bottom: 8px;">
                                                <span>å¼€ç›˜: <b style="color:#333">${open}</b></span>
                                                <span>æ”¶ç›˜: <b style="color:#333">${close}</b></span>
                                                <span>æœ€é«˜: <b style="color:#333">${high}</b></span>
                                                <span>æœ€ä½: <b style="color:#333">${low}</b></span>
                                                <span style="grid-column: span 2;">
                                                    æ¶¨è·Œ: <span style="color: ${color}; font-weight: bold;">${sign}${change.toFixed(2)}%</span>
                                                </span>
                                            </div>
                                        `;
                                    }
                                    // === æˆäº¤é‡ (SeriesName: 'æˆäº¤é‡') ===
                                    else if (item.seriesName === 'æˆäº¤é‡') {
                                        // item.value: [index, vol, sign]
                                        const vol = item.value[1];
                                        result += `
                                            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                                <span>
                                                    <span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${item.color};"></span>
                                                    ${item.seriesName}
                                                </span>
                                                <b>${vol} æ‰‹</b>
                                            </div>
                                        `;
                                    }
                                    // === å‡çº¿ç­‰å…¶ä»–çº¿æ¡ ===
                                    else {
                                        if (item.value !== undefined) {
                                            result += `
                                                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                                    <span>
                                                        <span style="display:inline-block;margin-right:5px;border-radius:50%;width:10px;height:10px;background-color:${item.color};"></span>
                                                        ${item.seriesName}
                                                    </span>
                                                    <span>${parseFloat(item.value).toFixed(2)}</span>
                                                </div>
                                            `;
                                        }
                                    }
                                });
                                return result;
                            }
                        },
                        axisPointer: { link: { xAxisIndex: 'all' } },
                        legend: { data: ['æ—¥K', 'MA5', 'MA10', 'MA20', 'æˆäº¤é‡', 'é¢„æœŸå½¢æ€'], top: 10 },
                        grid: [{ left: '5%', right: '5%', height: '60%', top: '10%' }, { left: '5%', right: '5%', top: '75%', height: '15%' }],
                        xAxis: [
                            { type: 'category', data: dates, scale: true, boundaryGap: false, axisLine: { onZero: false }, splitLine: { show: false }, min: 'dataMin', max: 'dataMax', gridIndex: 0 },
                            { type: 'category', gridIndex: 1, data: dates, scale: true, boundaryGap: false, axisLine: { onZero: false }, axisTick: { show: false }, axisLabel: { show: false }, min: 'dataMin', max: 'dataMax' }
                        ],
                        yAxis: [
                            { scale: true, splitLine: { show: true, lineStyle: { color: '#eee' } }, gridIndex: 0 },
                            { scale: true, gridIndex: 1, splitNumber: 2, axisLabel: { show: false }, axisLine: { show: false }, splitLine: { show: false } }
                        ],
                        dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], bottom: 0, start: 50, end: 100 }],
                        series: [
                            { name: 'æ—¥K', type: 'candlestick', data: values, xAxisIndex: 0, yAxisIndex: 0, itemStyle: { color: '#F56C6C', color0: '#00C853', borderColor: '#F56C6C', borderColor0: '#00C853' } },
                            { name: 'MA5', type: 'line', data: mas.MA5, smooth: true, xAxisIndex: 0, yAxisIndex: 0, showSymbol: false, lineStyle: { width: 1, color: '#f6bd16' } },
                            { name: 'MA10', type: 'line', data: mas.MA10, smooth: true, xAxisIndex: 0, yAxisIndex: 0, showSymbol: false, lineStyle: { width: 1, color: '#5b8ff9' } },
                            { name: 'MA20', type: 'line', data: mas.MA20, smooth: true, xAxisIndex: 0, yAxisIndex: 0, showSymbol: false, lineStyle: { width: 1, color: '#9d58f9' } },
                            { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: volumes, itemStyle: { color: (params) => params.value[2] === 1 ? '#F56C6C' : '#00C853' } },
                            { id: 'user-drawing-line', name: 'é¢„æœŸå½¢æ€', type: 'line', xAxisIndex: 0, yAxisIndex: 0, smooth: 0.3, symbol: 'none', lineStyle: { color: '#E6A23C', width: 4, type: 'solid' }, data: [], z: 9999 }
                        ]
                    };
                    myChart.setOption(option, true);
                };

                // 4. åŠŸèƒ½é€»è¾‘
                const toggleDrawing = () => {
                    isDrawing.value = !isDrawing.value;
                    statusText.value = isDrawing.value ? 'è¯·æŒ‰ä½é¼ æ ‡å·¦é”®ç»˜å›¾' : 'ä»…æµè§ˆ';
                    isMouseDown = false;
                    if (isDrawing.value) {
                        myChart.setOption({ dataZoom: [{ type: 'inside', disabled: true }, { type: 'slider', show: true }] });
                        drawingSeriesData = [];
                        updateDrawingLine([]);
                    } else {
                        myChart.setOption({ dataZoom: [{ type: 'inside', disabled: false }, { type: 'slider', show: true }] });
                    }
                };

                const submitPattern = async () => {
                    if (drawingSeriesData.length < 5) { ElementPlus.ElMessage.warning('è¯·å…ˆç»˜åˆ¶å½¢æ€'); return; }
                    const loadingInst = ElementPlus.ElLoading.service({ text: 'æ­£åœ¨å¤šå› å­ç­›é€‰ä¸åŒ¹é…...', background: 'rgba(255,255,255,0.8)' });

                    const finalFilters = {
                        ...filters.value,
                        strategies: selectedStrategies.value,
                        logic: strategyLogic.value
                    };

                    try {
                        const res = await axios.post('/api/match/', {
                            prices: drawingSeriesData.map(i => i[1]),
                            mode: tradeMode.value,
                            filters: finalFilters
                        });
                        if (res.data.code === 200) {
                            matchResult.value = res.data.data;
                            ElementPlus.ElMessage.success(`åŒ¹é…å®Œæˆ`);
                            setTimeout(() => document.querySelector('.result-section')?.scrollIntoView({ behavior: 'smooth' }), 300);
                        } else { ElementPlus.ElMessage.warning(res.data.msg); }
                    } catch (e) { ElementPlus.ElMessage.error('ç³»ç»Ÿé”™è¯¯'); }
                    finally { loadingInst.close(); }
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`/api/kline/?code=${stockCode.value}`);
                        if (res.data.code === 200) {
                            const d = res.data.data;
                            renderChart(d.dates, d.values, d.mas, d.volumes);
                        } else { ElementPlus.ElMessage.error(res.data.msg); }
                    } catch (e) { ElementPlus.ElMessage.error('è¯·æ±‚å¤±è´¥'); }
                    finally { loading.value = false; }
                };

                const openTableDialog = () => tableDialogVisible.value = true;
                const addTableRow = () => inputTableData.value.push({ date: '', close: '' });
                const deleteRow = (index) => inputTableData.value.splice(index, 1);
                const generateFromTable = () => {
                    const newData = inputTableData.value.map((row, index) => [index, parseFloat(row.close || 0)]);
                    if (newData.length < 3) return;
                    drawingSeriesData = newData;
                    updateDrawingLine(drawingSeriesData);
                    tableDialogVisible.value = false;
                    submitPattern();
                };

                const clearCanvas = () => { drawingSeriesData = []; updateDrawingLine([]); matchResult.value = []; };
                const handleTrade = (row) => {
                    ElementPlus.ElMessageBox.confirm(
                        `ç¡®å®šè¦ä»¥ Â¥${row.price} çš„ä»·æ ¼ä¹°å…¥ ${row.code} (100è‚¡) å—ï¼Ÿ\nè§¦å‘ç­–ç•¥ï¼š${row.trigger}`,
                        'æ¨¡æ‹Ÿäº¤æ˜“ç¡®è®¤',
                        {
                            confirmButtonText: 'ç¡®è®¤ä¹°å…¥',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning',
                        }
                    ).then(async () => {
                        try {
                            // è°ƒç”¨åç«¯ä¸‹å•æ¥å£
                            const res = await axios.post('/api/order/', {
                                code: row.code,
                                date: row.date,
                                type: 'BUY',       // é»˜è®¤ä¸ºä¹°å…¥
                                price: row.price,
                                volume: 100,       // é»˜è®¤ä¹°å…¥ 1 æ‰‹
                                trigger: row.trigger
                            });

                            if (res.data.code === 200) {
                                ElementPlus.ElMessage.success('äº¤æ˜“æˆåŠŸï¼å·²å­˜å…¥å†å²è®°å½•');
                            } else {
                                ElementPlus.ElMessage.error('äº¤æ˜“å¤±è´¥: ' + res.data.msg);
                            }
                        } catch (e) {
                            ElementPlus.ElMessage.error('ç½‘ç»œè¯·æ±‚é”™è¯¯');
                            console.error(e);
                        }
                    }).catch(() => {
                        ElementPlus.ElMessage.info('å·²å–æ¶ˆäº¤æ˜“');
                    });
                };
                const goUrl = (url) => window.location.href = url;

                onMounted(() => { initChart(); fetchData(); });

                return {
                    stockCode, loading, isDrawing, statusText, matchResult, tradeMode, filters,
                    tableDialogVisible, inputTableData, strategyDialogVisible, selectedStrategies, strategyLogic,
                    fetchData, toggleDrawing, clearCanvas, submitPattern, handleTrade, goUrl,
                    openTableDialog, addTableRow, deleteRow, generateFromTable, getStrategyLabel
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
        app.mount('#app');
    </script>
</body>
</html>