{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½è‚¡ç¥¨åˆ†æç³»ç»Ÿ | Ultimate</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background-color: #f0f2f5; }
        .el-aside { background-color: #001529; color: white; height: 100vh; transition: width 0.3s; }
        .logo-area { height: 60px; line-height: 60px; text-align: center; font-size: 20px; font-weight: bold; background: #002140; color: white; }
        .el-header { background-color: #fff; box-shadow: 0 1px 4px rgba(0,21,41,.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .main-card { margin-bottom: 20px; border-radius: 4px; }
        .chart-container { height: 600px; width: 100%; }
        .compare-chart-container { height: 400px; width: 100%; } /* å¯¹æ¯”å›¾é«˜åº¦ */
        .drawing-cursor { cursor: crosshair !important; }
        .result-section { margin-top: 20px; border-top: 5px solid #409EFF; }
        .strategy-tag { margin-right: 10px; margin-bottom: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="app">
        <el-container>
            <el-aside width="220px">
                <div class="logo-area">ğŸ¤– æ™ºèƒ½å†³ç­–ç³»ç»Ÿ</div>
                <el-menu active-text-color="#409EFF" background-color="#001529" text-color="#fff" default-active="2-1">
                    <el-menu-item index="1"><i class="el-icon-s-home"></i><span>ç³»ç»Ÿé¦–é¡µ</span></el-menu-item>
                    <el-sub-menu index="2">
                        <template #title><span>æ¨¡å¼åŒ¹é…åˆ†æ</span></template>
                        <el-menu-item index="2-1">ç‰¹å®šèµ°åŠ¿ç­›é€‰</el-menu-item>
                        <el-menu-item index="2-2" @click="goUrl('/api/history/')">å†å²å›æµ‹è®°å½•</el-menu-item>
                    </el-sub-menu>
                    <el-menu-item index="3" @click="goUrl('/api/prediction/')"><span>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ</span></el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header>
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item>é¦–é¡µ</el-breadcrumb-item>
                        <el-breadcrumb-item>æ¨¡å¼åŒ¹é…åˆ†æ</el-breadcrumb-item>
                        <el-breadcrumb-item>å¤šå› å­ç­–ç•¥ç»„åˆ</el-breadcrumb-item>
                    </el-breadcrumb>
                    <div><el-avatar size="small" style="background: #409EFF">User</el-avatar></div>
                </el-header>

                <el-main>
                    <el-card class="main-card" shadow="hover">
                        <el-row :gutter="20" align="middle" style="margin-bottom: 15px;">
                            <el-col :span="5">
                                <el-input v-model="stockCode" placeholder="ä»£ç  (å¦‚ 000001)" prefix-icon="Search"></el-input>
                            </el-col>
                            <el-col :span="19">
                                <el-button type="primary" @click="fetchData" :loading="loading" plain>æŸ¥è¯¢Kçº¿</el-button>
                                <el-divider direction="vertical"></el-divider>
                                <el-button :type="isDrawing ? 'danger' : 'warning'" icon="Edit" @click="toggleDrawing">
                                    [[ isDrawing ? 'åœæ­¢ç»˜åˆ¶' : 'æ‰‹ç»˜å½¢æ€' ]]
                                </el-button>
                                <el-button type="info" icon="Delete" @click="clearCanvas" circle plain style="margin-left: 10px"></el-button>
                            </el-col>
                        </el-row>

                        <el-row :gutter="10" align="middle" style="background: #f9fafc; padding: 15px; border-radius: 4px;">
                            <el-col :span="2" style="text-align: right; color: #666; font-size: 14px; font-weight: bold;">
                                ğŸ¯ åŸºç¡€ç­›é€‰:
                            </el-col>

                            <el-col :span="3">
                                <el-input v-model="filters.codeQuery" placeholder="ä»£ç è¿‡æ»¤" size="small" clearable prefix-icon="Search"></el-input>
                            </el-col>

                            <el-col :span="3">
                                <el-select v-model="filters.sector" placeholder="æ‰€å±è¡Œä¸š" clearable size="small">
                                    <el-option label="é‡‘èè¡Œä¸š" value="Finance"></el-option>
                                    <el-option label="ç§‘æŠ€åŠå¯¼ä½“" value="Tech"></el-option>
                                    <el-option label="æ–°èƒ½æº" value="Energy"></el-option>
                                </el-select>
                            </el-col>

                            <el-col :span="3">
                                <el-select v-model="filters.marketCap" placeholder="å¸‚å€¼è§„æ¨¡" clearable size="small">
                                    <el-option label="å°ç›˜è‚¡ (<100äº¿)" value="SMALL"></el-option>
                                    <el-option label="ä¸­ç›˜è‚¡ (100-500äº¿)" value="MID"></el-option>
                                    <el-option label="å¤§ç›˜è‚¡ (>500äº¿)" value="LARGE"></el-option>
                                </el-select>
                            </el-col>

                            <el-col :span="4">
                                <div style="display: flex; align-items: center;">
                                    <el-input v-model="filters.minPrice" placeholder="æœ€ä½ä»·" size="small" style="width: 48%"></el-input>
                                    <span style="margin: 0 3px; color:#ccc">-</span>
                                    <el-input v-model="filters.maxPrice" placeholder="æœ€é«˜ä»·" size="small" style="width: 48%"></el-input>
                                </div>
                            </el-col>

                            <el-col :span="5" style="padding: 0 10px;">
                                <div style="display: flex; align-items: center;">
                                    <span style="font-size: 12px; color: #909399; margin-right: 5px; white-space: nowrap;">é˜ˆå€¼: [[ filters.minScore ]]</span>
                                    <el-slider v-model="filters.minScore" :min="0" :max="90" size="small" style="flex: 1;"></el-slider>
                                </div>
                            </el-col>

                            <el-col :span="4" style="text-align: right;">
                                <el-button type="warning" icon="Setting" circle plain size="small" @click="strategyDialogVisible = true" title="é…ç½®ç­–ç•¥"></el-button>
                                <el-button type="success" icon="Cpu" size="small" @click="submitPattern">ç­›é€‰</el-button>
                            </el-col>
                        </el-row>
                    </el-card>

                    <el-card class="main-card" shadow="always" body-style="padding: 0px;">
                        <div id="main-chart" class="chart-container" :class="{ 'drawing-cursor': isDrawing }"></div>
                    </el-card>

                    <el-card v-if="matchResult.length > 0" class="main-card result-section">
                        <template #header>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; font-size: 16px;">ğŸ¯ åŒ¹é…ç»“æœ Top 10</span>
                                <el-tag type="success">è®¡ç®—å®Œæˆ</el-tag>
                            </div>
                        </template>

                        <el-table :data="matchResult" stripe style="width: 100%" border>
                           <el-table-column label="è‚¡ç¥¨ä¿¡æ¯" width="140">
                                <template #default="scope">
                                    <div style="font-weight: bold; font-size: 14px;">[[ scope.row.name ]]</div>
                                    <el-tag size="small" effect="plain" type="info">[[ scope.row.code ]]</el-tag>
                                </template>
                            </el-table-column>

                            <el-table-column label="å¾—åˆ†è¯¦æƒ…" width="180">
                                <template #default="scope">
                                    <el-tooltip content="å½¢æ€åˆ† + ç­–ç•¥åˆ†" placement="top">
                                        <div style="font-size: 12px;">
                                            <span style="color: #E6A23C">å½¢æ€: [[ scope.row.score_breakdown.dtw ]]</span> |
                                            <span style="color: #67C23A">ç­–ç•¥: [[ scope.row.score_breakdown.strategy ]]</span>
                                        </div>
                                    </el-tooltip>
                                    <el-progress :percentage="scope.row.score > 100 ? 100 : scope.row.score" :color="customColors" :stroke-width="6"></el-progress>
                                </template>
                            </el-table-column>

                            <el-table-column prop="trigger" label="è§¦å‘ç­–ç•¥" width="160">
                                <template #default="scope">
                                    <el-tag :type="scope.row.trigger !== 'ä¸æ»¡è¶³ç­–ç•¥' ? 'danger' : 'info'" effect="plain" size="small">
                                        [[ scope.row.trigger ]]
                                    </el-tag>
                                </template>
                            </el-table-column>

                            <el-table-column prop="match_range" label="åŒ¹é…æ—¶é—´æ®µ" width="200" show-overflow-tooltip>
                                <template #default="scope">
                                    <i class="el-icon-time"></i> [[ scope.row.match_range ]]
                                </template>
                            </el-table-column>

                            <el-table-column prop="price" label="å½“å‰ä»·" width="100">
                                <template #default="scope">Â¥ [[ scope.row.price ]]</template>
                            </el-table-column>

                            <el-table-column label="æ“ä½œ">
                                <template #default="scope">
                                    <el-button size="small" type="warning" plain icon="DataLine" @click="showCompareDialog(scope.row)">å¯¹æ¯”</el-button>
                                    <el-button size="small" type="primary" @click="handleTrade(scope.row)">æ¨¡æ‹Ÿäº¤æ˜“</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>

                    <el-card v-if="hasSearched && matchResult.length === 0" class="main-card" style="text-align: center; padding: 40px 0;">
                        <el-empty description="æš‚æ— åŒ¹é…ç»“æœ">
                            <template #description>
                                <p>å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æœªæ‰¾åˆ°ç›¸ä¼¼è‚¡ç¥¨</p>
                                <p style="font-size: 12px; color: #999;">å»ºè®®ï¼šé™ä½åŒ¹é…é˜ˆå€¼ / æ¸…é™¤ä»£ç ç­›é€‰ / ç®€åŒ–æ‰‹ç»˜å½¢æ€</p>
                            </template>
                        </el-empty>
                    </el-card>
                </el-main>
            </el-container>

            <el-dialog v-model="strategyDialogVisible" title="æ„å»ºå¤šå› å­ç­–ç•¥ç»„åˆ" width="40%">
                <el-checkbox-group v-model="selectedStrategies">
                    <div style="margin-bottom: 10px; font-weight: bold;">è¶‹åŠ¿ç±»ï¼š</div>
                    <el-checkbox label="MACD_GOLD">MACD é‡‘å‰</el-checkbox>
                    <el-checkbox label="MA_LONG">å‡çº¿å¤šå¤´æ’åˆ—</el-checkbox>
                    <div style="margin: 15px 0 10px; font-weight: bold;">éœ‡è¡ç±»ï¼š</div>
                    <el-checkbox label="RSI_LOW">RSI è¶…å– (<30)</el-checkbox>
                </el-checkbox-group>
                <el-divider></el-divider>
                <div style="display: flex; align-items: center;">
                    <span style="margin-right: 15px; font-weight: bold;">ç»„åˆé€»è¾‘ï¼š</span>
                    <el-radio-group v-model="strategyLogic">
                        <el-radio label="AND">ä¸” (AND)</el-radio>
                        <el-radio label="OR">æˆ– (OR)</el-radio>
                    </el-radio-group>
                </div>
            </el-dialog>

            <el-dialog v-model="compareDialogVisible" title="èµ°åŠ¿è¯¦ç»†å¯¹æ¯” (å½’ä¸€åŒ–)" width="60%" @opened="renderCompareChart">
                <div style="margin-bottom: 10px; font-size: 13px; color: #666; display: flex; justify-content: space-between;">
                    <span>è‚¡ç¥¨ä»£ç : <b>[[ currentCompareRow.code ]]</b></span>
                    <span>åŒ¹é…åº¦å¾—åˆ†: <b style="color: #F56C6C">[[ currentCompareRow.score ]]</b></span>
                    <span>åŒ¹é…æ—¶æ®µ: [[ currentCompareRow.match_range ]]</span>
                </div>
                <div id="compare-chart" class="compare-chart-container"></div>
            </el-dialog>

        </el-container>
    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const stockCode = ref('000001');
                const loading = ref(false);
                const isDrawing = ref(false);
                const matchResult = ref([]);
                const hasSearched = ref(false);
                const tradeMode = ref('BUY');
                const filters = ref({
                    codeQuery: '', sector: '', minPrice: '', maxPrice: '',
                    minScore: 60 // é»˜è®¤é˜ˆå€¼
                });

                const strategyDialogVisible = ref(false);
                const selectedStrategies = ref([]);
                const strategyLogic = ref('OR');

                // å¯¹æ¯”å¼¹çª—ç›¸å…³
                const compareDialogVisible = ref(false);
                const currentCompareRow = ref({});
                let compareChart = null;

                let myChart = null;
                let drawingSeriesData = [];
                let isMouseDown = false;

                const customColors = [
                    { color: '#f56c6c', percentage: 20 },
                    { color: '#e6a23c', percentage: 60 },
                    { color: '#67c23a', percentage: 100 }
                ];

                // å½’ä¸€åŒ–å‡½æ•°
                const normalizeData = (data) => {
                    if (!data || data.length === 0) return [];
                    const mean = data.reduce((a, b) => a + b, 0) / data.length;
                    const std = Math.sqrt(data.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / data.length);
                    if (std === 0) return data.map(() => 0);
                    return data.map(x => (x - mean) / std);
                };

                // æ˜¾ç¤ºå¯¹æ¯”å¼¹çª—
                const showCompareDialog = (row) => {
                    currentCompareRow.value = row;
                    compareDialogVisible.value = true;
                };

                const renderCompareChart = () => {
                    const dom = document.getElementById('compare-chart');
                    if (compareChart) compareChart.dispose();
                    compareChart = echarts.init(dom);

                    let userPattern = drawingSeriesData.map(d => d[1]);
                    let stockPattern = currentCompareRow.value.match_data || [];
                    if (userPattern.length === 0) userPattern = new Array(stockPattern.length).fill(stockPattern[0]);

                    const normUser = normalizeData(userPattern);
                    const normStock = normalizeData(stockPattern);
                    const xData = Array.from({length: Math.max(normUser.length, normStock.length)}, (_, i) => i + 1);

                    const option = {
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['æˆ‘çš„é¢„æœŸ(å½’ä¸€åŒ–)', 'å®é™…èµ°åŠ¿(å½’ä¸€åŒ–)'], bottom: 0 },
                        grid: { top: 30, left: 40, right: 40, bottom: 40 },
                        xAxis: { type: 'category', data: xData, boundaryGap: false },
                        yAxis: { type: 'value', splitLine: { show: false } },
                        series: [
                            {
                                name: 'æˆ‘çš„é¢„æœŸ(å½’ä¸€åŒ–)', type: 'line', data: normUser,
                                smooth: true, lineStyle: { type: 'dashed', width: 2, color: '#E6A23C' }, showSymbol: false
                            },
                            {
                                name: 'å®é™…èµ°åŠ¿(å½’ä¸€åŒ–)', type: 'line', data: normStock,
                                smooth: true, lineStyle: { width: 3, color: '#409EFF' },
                                areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(64,158,255,0.3)'}, {offset: 1, color: 'rgba(64,158,255,0.05)'}]) }
                            }
                        ]
                    };
                    compareChart.setOption(option);
                };

                const initChart = () => {
                    const chartDom = document.getElementById('main-chart');
                    if (!chartDom) return;
                    myChart = echarts.init(chartDom);
                    const zr = myChart.getZr();
                    zr.on('mousedown', () => { if(!isDrawing.value) return; isMouseDown=true; drawingSeriesData=[]; });
                    zr.on('mousemove', params => {
                        if (!isDrawing.value || !isMouseDown) return;
                        const pt = myChart.convertFromPixel({ seriesIndex: 0 }, [params.offsetX, params.offsetY]);
                        if (pt) { drawingSeriesData.push(pt); updateDrawingLine(drawingSeriesData); }
                    });
                    zr.on('mouseup', () => { if(isDrawing.value) isMouseDown=false; });
                    zr.on('globalout', () => isMouseDown = false);
                    window.onresize = () => myChart.resize();
                };

                const updateDrawingLine = (data) => {
                    myChart.setOption({ series: [{ id: 'user-drawing-line', data: data }] }, { lazyUpdate: false });
                };

                // ğŸ”¥ æ¸²æŸ“ä¸»å›¾ (åŒ…å«ä½ è¦æ±‚çš„ä¸­æ–‡ Tooltip å’Œæ¶¨è·Œå¹…)
                const renderChart = (dates, values, mas, volumes) => {
                    mas = mas || { MA5:[], MA10:[], MA20:[] };
                    volumes = volumes || [];
                    const option = {
                        backgroundColor: '#fff', animation: false,
                        // âœ… ä¸­æ–‡æ±‰åŒ– + æ¶¨è·Œå¹…æ˜¾ç¤º
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'cross' },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#ccc', borderWidth: 1, textStyle: { color: '#333' },
                            formatter: function (params) {
                                let result = '';
                                if (!params || params.length === 0) return '';
                                result += `<div style="font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #eee;">${params[0].axisValue}</div>`;
                                params.forEach(function (item) {
                                    if (item.seriesType === 'candlestick') {
                                        const open = item.value[1];
                                        const close = item.value[2];
                                        const low = item.value[3];
                                        const high = item.value[4];
                                        let change = 0;
                                        if (open !== 0) change = (close - open) / open * 100;
                                        const color = change >= 0 ? '#F56C6C' : '#00C853';
                                        const sign = change >= 0 ? '+' : '';
                                        result += `
                                            <div style="margin-bottom: 5px;">
                                                <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:${item.color};margin-right:5px;"></span>
                                                <span style="font-weight:bold;">${item.seriesName}</span>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px; font-family: monospace; color: #666; margin-bottom: 8px;">
                                                <span>å¼€ç›˜: <b style="color:#333">${open}</b></span>
                                                <span>æ”¶ç›˜: <b style="color:#333">${close}</b></span>
                                                <span>æœ€é«˜: <b style="color:#333">${high}</b></span>
                                                <span>æœ€ä½: <b style="color:#333">${low}</b></span>
                                                <span style="grid-column: span 2;">
                                                    æ¶¨è·Œ: <span style="color: ${color}; font-weight: bold;">${sign}${change.toFixed(2)}%</span>
                                                </span>
                                            </div>
                                        `;
                                    } else if (item.seriesName === 'æˆäº¤é‡') {
                                        result += `<div style="display:flex;justify-content:space-between;font-size:12px;"><span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:${item.color};margin-right:5px;"></span>${item.seriesName}</span><b>${item.value[1]} æ‰‹</b></div>`;
                                    } else if (item.value !== undefined) {
                                        result += `<div style="display:flex;justify-content:space-between;font-size:12px;"><span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:${item.color};margin-right:5px;"></span>${item.seriesName}</span><span>${parseFloat(item.value).toFixed(2)}</span></div>`;
                                    }
                                });
                                return result;
                            }
                        },
                        legend: { data: ['æ—¥K', 'MA5', 'MA10', 'MA20', 'æˆäº¤é‡', 'é¢„æœŸå½¢æ€'], top: 10 },
                        grid: [{ left: '5%', right: '5%', height: '60%', top: '10%' }, { left: '5%', right: '5%', top: '75%', height: '15%' }],
                        xAxis: [{ type: 'category', data: dates, scale: true, boundaryGap: false }, { type: 'category', gridIndex: 1, data: dates }],
                        yAxis: [{ scale: true, splitLine: { show: true } }, { scale: true, gridIndex: 1, splitLine: { show: false } }],
                        dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], bottom: 0, start: 50, end: 100 }],
                        series: [
                            { name: 'æ—¥K', type: 'candlestick', data: values, itemStyle: { color: '#F56C6C', color0: '#00C853', borderColor: '#F56C6C', borderColor0: '#00C853' } },
                            { name: 'MA5', type: 'line', data: mas.MA5, smooth: true, showSymbol: false, lineStyle: { width: 1 } },
                            { name: 'MA10', type: 'line', data: mas.MA10, smooth: true, showSymbol: false, lineStyle: { width: 1 } },
                            { name: 'MA20', type: 'line', data: mas.MA20, smooth: true, showSymbol: false, lineStyle: { width: 1 } },
                            { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: volumes },
                            { id: 'user-drawing-line', name: 'é¢„æœŸå½¢æ€', type: 'line', smooth: 0.3, symbol: 'none', lineStyle: { color: '#E6A23C', width: 4 }, data: [] }
                        ]
                    };
                    myChart.setOption(option, true);
                };

                const submitPattern = async () => {
                    const hasCode = filters.value.codeQuery && filters.value.codeQuery.length > 0;
                    const hasStrategy = selectedStrategies.value.length > 0;
                    const hasPattern = drawingSeriesData.length >= 3;
                    const hasSector = filters.value.sector;

                    if (!hasCode && !hasStrategy && !hasPattern && !hasSector) {
                        ElementPlus.ElMessage.warning('è¯·è‡³å°‘æä¾›ä¸€ä¸ªç­›é€‰æ¡ä»¶ (æ‰‹ç»˜/ä»£ç /ç­–ç•¥/è¡Œä¸š)'); return;
                    }

                    const loadingInst = ElementPlus.ElLoading.service({ text: 'æ™ºèƒ½åŒ¹é…è®¡ç®—ä¸­...', background: 'rgba(255,255,255,0.8)' });
                    const finalFilters = { ...filters.value, strategies: selectedStrategies.value, logic: strategyLogic.value };

                    try {
                        const res = await axios.post('/api/match/', {
                            prices: drawingSeriesData.map(i => i[1]),
                            mode: tradeMode.value,
                            filters: finalFilters
                        });
                        hasSearched.value = true;
                        if (res.data.code === 200) {
                            matchResult.value = res.data.data;
                            if (matchResult.value.length === 0) ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨ (å°è¯•é™ä½åŒ¹é…é˜ˆå€¼)');
                            else {
                                ElementPlus.ElMessage.success(`æ‰¾åˆ° ${matchResult.value.length} ä¸ªç»“æœ`);
                                setTimeout(() => document.querySelector('.result-section')?.scrollIntoView({ behavior: 'smooth' }), 300);
                            }
                        } else ElementPlus.ElMessage.warning(res.data.msg);
                    } catch (e) { ElementPlus.ElMessage.error('ç³»ç»Ÿé”™è¯¯'); console.error(e); }
                    finally { loadingInst.close(); }
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`/api/kline/?code=${stockCode.value}`);
                        if (res.data.code === 200) renderChart(res.data.data.dates, res.data.data.values, res.data.data.mas, res.data.data.volumes);
                        else ElementPlus.ElMessage.error(res.data.msg);
                    } catch (e) { ElementPlus.ElMessage.error('è¯·æ±‚å¤±è´¥'); } finally { loading.value = false; }
                };

                const handleTrade = (row) => {
                    ElementPlus.ElMessageBox.confirm(`ä»¥ Â¥${row.price} ä¹°å…¥ ${row.code} ?`, 'äº¤æ˜“ç¡®è®¤', { type: 'warning' })
                    .then(async () => {
                        const res = await axios.post('/api/order/', { code: row.code, date: row.date, type: 'BUY', price: row.price, volume: 100, trigger: row.trigger });
                        if(res.data.code===200) ElementPlus.ElMessage.success('äº¤æ˜“æˆåŠŸ');
                    });
                };

                const goUrl = (url) => window.location.href = url;
                const toggleDrawing = () => { isDrawing.value = !isDrawing.value; if(!isDrawing.value) drawingSeriesData=[]; updateDrawingLine([]); };
                const clearCanvas = () => { drawingSeriesData = []; updateDrawingLine([]); matchResult.value = []; };

                onMounted(() => { initChart(); fetchData(); });

                return {
                    stockCode, loading, isDrawing, matchResult, hasSearched, filters, customColors,
                    strategyDialogVisible, selectedStrategies, strategyLogic,
                    compareDialogVisible, currentCompareRow,
                    fetchData, toggleDrawing, clearCanvas, submitPattern, handleTrade, goUrl, showCompareDialog, renderCompareChart
                };
            }
        });
        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
        app.mount('#app');
    </script>
</body>
</html>