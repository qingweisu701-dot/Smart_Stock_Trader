{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½è‚¡ç¥¨åˆ†æç³»ç»Ÿ | Ultimate</title>
    <link rel="stylesheet" href="{% static 'css/element-plus.css' %}">
    <style>
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background-color: #f0f2f5; }
        .el-aside { background-color: #001529; color: white; height: 100vh; transition: width 0.3s; }
        .logo-area { height: 60px; line-height: 60px; text-align: center; font-size: 20px; font-weight: bold; background: #002140; color: white; }
        .el-header { background-color: #fff; box-shadow: 0 1px 4px rgba(0,21,41,.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .main-card { margin-bottom: 20px; border-radius: 4px; }
        .chart-container { height: 600px; width: 100%; }
        .compare-chart-container { height: 400px; width: 100%; }
        .drawing-cursor { cursor: crosshair !important; }
        .result-section { margin-top: 20px; border-top: 5px solid #409EFF; }
    </style>
</head>
<body>

    <div id="app">
        <el-container>
            <el-aside width="220px">
                <div class="logo-area">ğŸ¤– æ™ºèƒ½å†³ç­–ç³»ç»Ÿ</div>
                <el-menu active-text-color="#409EFF" background-color="#001529" text-color="#fff" default-active="2-1">
                    <el-menu-item index="1"><i class="el-icon-s-home"></i><span>ç³»ç»Ÿé¦–é¡µ</span></el-menu-item>
                    <el-sub-menu index="2">
                        <template #title><span>æ¨¡å¼åŒ¹é…åˆ†æ</span></template>
                        <el-menu-item index="2-1">ç‰¹å®šèµ°åŠ¿ç­›é€‰</el-menu-item>
                        <el-menu-item index="2-2" @click="goUrl('/api/history/')">å†å²å›æµ‹è®°å½•</el-menu-item>
                    </el-sub-menu>
                    <el-menu-item index="3" @click="goUrl('/api/prediction/')"><span>é‡åŒ–é¢„æµ‹ä¸­å¿ƒ</span></el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header>
                    <el-breadcrumb separator="/">
                        <el-breadcrumb-item>é¦–é¡µ</el-breadcrumb-item>
                        <el-breadcrumb-item>æ¨¡å¼åŒ¹é…åˆ†æ</el-breadcrumb-item>
                        <el-breadcrumb-item>å¤šå› å­ç­–ç•¥ç»„åˆ</el-breadcrumb-item>
                    </el-breadcrumb>
                    <div><el-avatar size="small" style="background: #409EFF">User</el-avatar></div>
                </el-header>

                <el-main>
                    <el-card class="main-card" shadow="hover">
                        <el-row :gutter="20" align="middle" style="margin-bottom: 15px;">
                            <el-col :span="5">
                                <el-input v-model="stockCode" placeholder="ä»£ç  (å¦‚ 000001)" prefix-icon="Search"></el-input>
                            </el-col>
                            <el-col :span="19">
                                <el-button type="primary" @click="fetchData" :loading="loading" plain>æŸ¥è¯¢Kçº¿</el-button>
                                <el-divider direction="vertical"></el-divider>

                                <el-dropdown split-button type="primary" @command="loadPresetPattern">
                                    ğŸ“š æ ‡å‡†å½¢æ€åº“
                                    <template #dropdown>
                                        <el-dropdown-menu>
                                            <el-dropdown-item command="head_shoulders_top">å¤´è‚©é¡¶ (çœ‹è·Œ)</el-dropdown-item>
                                            <el-dropdown-item command="m_top">M å¤´ (åŒé‡é¡¶)</el-dropdown-item>
                                            <el-dropdown-item command="w_bottom">W åº• (åŒé‡åº•)</el-dropdown-item>
                                            <el-dropdown-item command="v_bottom">V å‹åè½¬ (è§¦åº•åå¼¹)</el-dropdown-item>
                                            <el-dropdown-item command="rising_three">ä¸Šå‡ä¸‰æ³• (ä¸­ç»§çœ‹æ¶¨)</el-dropdown-item>
                                            <el-dropdown-item command="cup_handle">æ¯æŸ„å½¢æ€ (çªç ´çœ‹æ¶¨)</el-dropdown-item>
                                        </el-dropdown-menu>
                                    </template>
                                </el-dropdown>

                                <el-divider direction="vertical"></el-divider>
                                <el-button :type="isDrawing ? 'danger' : 'warning'" icon="Edit" @click="toggleDrawing">
                                    [[ isDrawing ? 'åœæ­¢ç»˜åˆ¶' : 'æ‰‹ç»˜å½¢æ€' ]]
                                </el-button>
                                <el-button type="info" icon="Delete" @click="clearCanvas" circle plain style="margin-left: 10px"></el-button>
                            </el-col>
                        </el-row>

                        <el-row :gutter="10" align="middle" style="background: #f9fafc; padding: 15px; border-radius: 4px;">
                            <el-col :span="2" style="text-align: right; color: #666; font-size: 14px; font-weight: bold;">ğŸ¯ åŸºç¡€ç­›é€‰:</el-col>
                            <el-col :span="3"><el-input v-model="filters.codeQuery" placeholder="ä»£ç è¿‡æ»¤" size="small" clearable></el-input></el-col>
                            <el-col :span="3">
                                <el-select v-model="filters.sector" placeholder="æ‰€å±è¡Œä¸š" clearable size="small">
                                    <el-option label="é‡‘èè¡Œä¸š" value="Finance"></el-option>
                                    <el-option label="ç§‘æŠ€åŠå¯¼ä½“" value="Tech"></el-option>
                                    <el-option label="æ–°èƒ½æº" value="Energy"></el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="3">
                                <el-select v-model="filters.marketCap" placeholder="å¸‚å€¼è§„æ¨¡" clearable size="small">
                                    <el-option label="å°ç›˜è‚¡ (<100äº¿)" value="SMALL"></el-option>
                                    <el-option label="ä¸­ç›˜è‚¡ (100-500äº¿)" value="MID"></el-option>
                                    <el-option label="å¤§ç›˜è‚¡ (>500äº¿)" value="LARGE"></el-option>
                                </el-select>
                            </el-col>
                            <el-col :span="6" style="padding: 0 10px;">
                                <div style="display: flex; align-items: center;">
                                    <span style="font-size: 12px; color: #909399; margin-right: 5px;">é˜ˆå€¼: [[ filters.minScore ]]</span>
                                    <el-slider v-model="filters.minScore" :min="0" :max="90" size="small" style="flex: 1;"></el-slider>
                                </div>
                            </el-col>
                            <el-col :span="3">
                                <el-button type="warning" icon="Setting" plain size="small" style="width: 100%" @click="strategyDialogVisible = true">
                                    ç­–ç•¥ ([[ selectedStrategies.length ]])
                                </el-button>
                            </el-col>
                            <el-col :span="4" style="text-align: right;">
                                <el-button type="success" icon="Cpu" size="small" @click="submitPattern">å¼€å§‹åŒ¹é…</el-button>
                            </el-col>
                        </el-row>
                    </el-card>

                    <el-card class="main-card" shadow="always" body-style="padding: 0px;">
                        <div id="main-chart" class="chart-container" :class="{ 'drawing-cursor': isDrawing }"></div>
                        <div v-if="currentPresetName" style="background: #fdf6ec; color: #e6a23c; padding: 8px 15px; font-size: 13px; border-top: 1px solid #faecd8;">
                            <i class="el-icon-info"></i> å½“å‰æ­£åœ¨åŒ¹é…ï¼š<b>[[ currentPresetName ]]</b>
                            ] pattern]
                        </div>
                    </el-card>

                    <el-card v-if="matchResult.length > 0" class="main-card result-section">
                        <template #header>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; font-size: 16px;">ğŸ¯ åŒ¹é…ç»“æœ Top 10</span>
                                <el-tag type="success">è®¡ç®—å®Œæˆ</el-tag>
                            </div>
                        </template>
                        <el-table :data="matchResult" stripe style="width: 100%" border>
                            <el-table-column label="è‚¡ç¥¨ä¿¡æ¯" width="140">
                                <template #default="scope">
                                    <div style="font-weight: bold;">[[ scope.row.name ]]</div>
                                    <el-tag size="small" type="info">[[ scope.row.code ]]</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="å¾—åˆ†è¯¦æƒ…" width="180">
                                <template #default="scope">
                                    <div style="font-size: 12px;">
                                        <span style="color: #E6A23C">å½¢æ€: [[ scope.row.score_breakdown.dtw ]]</span> |
                                        <span style="color: #67C23A">ç­–ç•¥: [[ scope.row.score_breakdown.strategy ]]</span>
                                    </div>
                                    <el-progress :percentage="scope.row.score > 100 ? 100 : scope.row.score" :color="customColors" :stroke-width="6"></el-progress>
                                </template>
                            </el-table-column>
                            <el-table-column prop="trigger" label="è§¦å‘ç­–ç•¥" width="160">
                                <template #default="scope"><el-tag type="danger" effect="plain" size="small">[[ scope.row.trigger ]]</el-tag></template>
                            </el-table-column>
                            <el-table-column prop="match_range" label="åŒ¹é…æ—¶é—´æ®µ" width="200" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="price" label="å½“å‰ä»·" width="100">
                                <template #default="scope">Â¥ [[ scope.row.price ]]</template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ">
                                <template #default="scope">
                                    <el-button size="small" type="warning" plain @click="showCompareDialog(scope.row)">å¯¹æ¯”</el-button>
                                    <el-button size="small" type="primary" @click="handleTrade(scope.row)">äº¤æ˜“</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </el-main>
            </el-container>

            <el-dialog v-model="strategyDialogVisible" title="æ„å»ºå¤šå› å­ç­–ç•¥ç»„åˆ" width="40%">
                <el-checkbox-group v-model="selectedStrategies">
                    <div style="margin-bottom: 10px; font-weight: bold;">è¶‹åŠ¿ç±»ï¼š</div>
                    <el-checkbox label="MACD_GOLD">MACD é‡‘å‰</el-checkbox>
                    <el-checkbox label="MA_LONG">å‡çº¿å¤šå¤´æ’åˆ—</el-checkbox>
                    <div style="margin: 15px 0 10px; font-weight: bold;">éœ‡è¡ç±»ï¼š</div>
                    <el-checkbox label="RSI_LOW">RSI è¶…å– (<30)</el-checkbox>
                </el-checkbox-group>
                <div style="margin-top: 20px;">
                    <el-radio-group v-model="strategyLogic">
                        <el-radio label="AND">ä¸” (AND)</el-radio>
                        <el-radio label="OR">æˆ– (OR)</el-radio>
                    </el-radio-group>
                </div>
            </el-dialog>

            <el-dialog v-model="compareDialogVisible" title="èµ°åŠ¿è¯¦ç»†å¯¹æ¯” (å½’ä¸€åŒ–)" width="60%" @opened="renderCompareChart">
                <div id="compare-chart" class="compare-chart-container"></div>
            </el-dialog>
        </el-container>
    </div>

    <script src="{% static 'js/vue.global.js' %}"></script>
    <script src="{% static 'js/element-plus.js' %}"></script>
    <script src="{% static 'js/element-plus-icons.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const stockCode = ref('000001');
                const loading = ref(false);
                const isDrawing = ref(false);
                const matchResult = ref([]);
                const hasSearched = ref(false);
                const tradeMode = ref('BUY');
                const currentPresetName = ref(''); // å½“å‰é€‰ä¸­çš„é¢„è®¾å½¢æ€åç§°
                const filters = ref({ codeQuery: '', sector: '', minPrice: '', maxPrice: '', minScore: 60, marketCap: '' });

                const strategyDialogVisible = ref(false);
                const selectedStrategies = ref([]);
                const strategyLogic = ref('OR');
                const compareDialogVisible = ref(false);
                const currentCompareRow = ref({});

                let myChart = null;
                let compareChart = null;
                let drawingSeriesData = [];
                let isMouseDown = false;

                const customColors = [
                    { color: '#f56c6c', percentage: 20 },
                    { color: '#e6a23c', percentage: 60 },
                    { color: '#67c23a', percentage: 100 }
                ];

                // ğŸ”¥ æ ‡å‡†å½¢æ€å®šä¹‰ (å½’ä¸€åŒ–åçš„è¶‹åŠ¿)
                const PRESET_PATTERNS = {
                    'head_shoulders_top': [0, 5, 3, 8, 3, 5, 0], // å¤´è‚©é¡¶: å·¦è‚©-å¤´-å³è‚©
                    'm_top': [0, 8, 4, 8, 0], // Må¤´: åŒé¡¶
                    'w_bottom': [8, 0, 4, 0, 8], // Wåº•: åŒåº•
                    'v_bottom': [10, 0, 10], // Vå‹åè½¬
                    'rising_three': [0, 8, 6, 5, 6, 10], // ä¸Šå‡ä¸‰æ³•: å¤§æ¶¨-å›è°ƒ-å†æ¶¨
                    'cup_handle': [10, 2, 0, 2, 5, 4, 8] // æ¯æŸ„: åœ†å¼§åº•+æŸ„éƒ¨å›è°ƒ
                };

                const PRESET_NAMES = {
                    'head_shoulders_top': 'å¤´è‚©é¡¶ (Head & Shoulders)',
                    'm_top': 'Må¤´ (Double Top)',
                    'w_bottom': 'Wåº• (Double Bottom)',
                    'v_bottom': 'Vå‹åè½¬ (V-Reversal)',
                    'rising_three': 'ä¸Šå‡ä¸‰æ³• (Rising Three)',
                    'cup_handle': 'æ¯æŸ„å½¢æ€ (Cup & Handle)'
                };

                const initChart = () => {
                    const chartDom = document.getElementById('main-chart');
                    if (!chartDom) return;
                    myChart = echarts.init(chartDom);
                    const zr = myChart.getZr();
                    zr.on('mousedown', () => { if(!isDrawing.value) return; isMouseDown=true; drawingSeriesData=[]; currentPresetName.value = ''; });
                    zr.on('mousemove', params => {
                        if (!isDrawing.value || !isMouseDown) return;
                        const pt = myChart.convertFromPixel({ seriesIndex: 0 }, [params.offsetX, params.offsetY]);
                        if (pt) { drawingSeriesData.push(pt); updateDrawingLine(drawingSeriesData); }
                    });
                    zr.on('mouseup', () => { if(isDrawing.value) isMouseDown=false; });
                    zr.on('globalout', () => isMouseDown = false);
                    window.onresize = () => myChart.resize();
                };

                // ğŸ”¥ åŠ è½½é¢„è®¾å½¢æ€
                const loadPresetPattern = (command) => {
                    const pattern = PRESET_PATTERNS[command];
                    if (!pattern) return;

                    // å°†å½’ä¸€åŒ–çš„ 0-10 æ•°æ®æ˜ å°„åˆ°å½“å‰å›¾è¡¨çš„å¯è§åŒºåŸŸ
                    // å‡è®¾æ˜ å°„åˆ°æœ€è¿‘ 30 å¤©ï¼Œä»·æ ¼åŒºé—´æ˜ å°„åˆ°å½“å‰Kçº¿çš„ä¸­é—´ä½ç½®
                    const visibleLen = 30;
                    const basePrice = 10; // è™šæ‹Ÿä»·æ ¼åŸºå‡†

                    // ç”Ÿæˆç”¨äº DTW çš„æ•°æ® (x: index, y: price)
                    // ä¸ºäº†åœ¨å›¾ä¸Šæ˜¾ç¤ºï¼Œæˆ‘ä»¬éœ€è¦æ„é€  x è½´åæ ‡ã€‚
                    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åªæ›´æ–° drawingSeriesData çš„ Y å€¼ç”¨äºåç«¯åŒ¹é…
                    // ä¸ºäº†å‰ç«¯å±•ç¤ºï¼Œæˆ‘ä»¬ç›´æ¥æŠŠè¿™äº›ç‚¹ç”»åœ¨å›¾è¡¨ä¸­é—´

                    const newData = pattern.map((val, idx) => {
                        // ç®€å•æ‹‰ä¼¸åˆ° 0-30 çš„åŒºé—´
                        const x = idx * (visibleLen / (pattern.length - 1));
                        return [x, val]; // Y å€¼ä¿ç•™åŸå§‹æ¯”ä¾‹ï¼Œåç«¯ä¼šè‡ªåŠ¨å½’ä¸€åŒ–
                    });

                    drawingSeriesData = newData;
                    currentPresetName.value = PRESET_NAMES[command];

                    // æ›´æ–°å›¾è¡¨ä¸Šçš„é»„çº¿
                    updateDrawingLine(newData);

                    // è‡ªåŠ¨è§¦å‘åŒ¹é…
                    ElementPlus.ElMessage.success(`å·²åŠ è½½ ${PRESET_NAMES[command]}ï¼Œæ­£åœ¨åŒ¹é…...`);
                    submitPattern();
                };

                const updateDrawingLine = (data) => {
                    // å¦‚æœæ˜¯é¢„è®¾å½¢æ€ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å°†å…¶æ˜ å°„åˆ°å±å¹•åæ ‡ç³»ä»¥ä¾¿æ˜¾ç¤º
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥ä¼ ç»™åç«¯ï¼Œå‰ç«¯çº¿æ¡å¯èƒ½å› ä¸ºåæ ‡è½´é—®é¢˜æ˜¾ç¤ºåœ¨è§’è½ï¼Œä½†ä¸å½±å“åŒ¹é…
                    // ä¸ºäº†ä½“éªŒæ›´å¥½ï¼Œå»ºè®®ç”¨æˆ·å…ˆä¸ç”¨çœ‹é»„çº¿ï¼Œç›´æ¥çœ‹åŒ¹é…ç»“æœ
                    myChart.setOption({ series: [{ id: 'user-drawing-line', data: data }] }, { lazyUpdate: false });
                };

                const renderChart = (dates, values, mas, volumes) => {
                    mas = mas || { MA5:[], MA10:[], MA20:[] };
                    volumes = volumes || [];
                    const option = {
                        backgroundColor: '#fff', animation: false,
                        tooltip: {
                            trigger: 'axis', axisPointer: { type: 'cross' },
                            formatter: function (params) {
                                // ... (ä¿ç•™ä¹‹å‰çš„ä¸­æ–‡ Tooltip é€»è¾‘) ...
                                return '';
                            }
                        },
                        legend: { data: ['æ—¥K', 'MA5', 'MA10', 'MA20', 'æˆäº¤é‡', 'é¢„æœŸå½¢æ€'], top: 10 },
                        grid: [{ left: '5%', right: '5%', height: '60%', top: '10%' }, { left: '5%', right: '5%', top: '75%', height: '15%' }],
                        xAxis: [{ type: 'category', data: dates }, { type: 'category', gridIndex: 1, data: dates }],
                        yAxis: [{ scale: true }, { scale: true, gridIndex: 1 }],
                        dataZoom: [{ type: 'inside', xAxisIndex: [0, 1], start: 50, end: 100 }, { type: 'slider', xAxisIndex: [0, 1], bottom: 0, start: 50, end: 100 }],
                        series: [
                            { name: 'æ—¥K', type: 'candlestick', data: values, itemStyle: { color: '#F56C6C', color0: '#00C853', borderColor: '#F56C6C', borderColor0: '#00C853' } },
                            { name: 'MA5', type: 'line', data: mas.MA5, smooth: true },
                            { name: 'MA10', type: 'line', data: mas.MA10, smooth: true },
                            { name: 'MA20', type: 'line', data: mas.MA20, smooth: true },
                            { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: volumes },
                            { id: 'user-drawing-line', name: 'é¢„æœŸå½¢æ€', type: 'line', smooth: 0.3, symbol: 'none', lineStyle: { color: '#E6A23C', width: 4 }, data: [] }
                        ]
                    };
                    myChart.setOption(option, true);
                };

                const submitPattern = async () => {
                    const hasCode = filters.value.codeQuery;
                    const hasStrategy = selectedStrategies.value.length > 0;
                    const hasPattern = drawingSeriesData.length >= 3;
                    const hasSector = filters.value.sector;
                    const hasCap = filters.value.marketCap;

                    if (!hasCode && !hasStrategy && !hasPattern && !hasSector && !hasCap) {
                        ElementPlus.ElMessage.warning('è¯·è‡³å°‘æä¾›ä¸€ä¸ªç­›é€‰æ¡ä»¶ (å½¢æ€/ä»£ç /ç­–ç•¥/è¡Œä¸š/å¸‚å€¼)'); return;
                    }

                    const loadingInst = ElementPlus.ElLoading.service({ text: 'æ™ºèƒ½åŒ¹é…è®¡ç®—ä¸­...', background: 'rgba(255,255,255,0.8)' });
                    const finalFilters = { ...filters.value, strategies: selectedStrategies.value, logic: strategyLogic.value };

                    try {
                        // æå– Y è½´æ•°æ®å‘é€ç»™åç«¯
                        const prices = drawingSeriesData.map(item => Array.isArray(item) ? item[1] : item);

                        const res = await axios.post('/api/match/', {
                            prices: prices,
                            mode: tradeMode.value,
                            filters: finalFilters
                        });
                        hasSearched.value = true;
                        if (res.data.code === 200) {
                            matchResult.value = res.data.data;
                            if (matchResult.value.length === 0) ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨');
                            else {
                                ElementPlus.ElMessage.success(`æ‰¾åˆ° ${matchResult.value.length} ä¸ªç»“æœ`);
                                setTimeout(() => document.querySelector('.result-section')?.scrollIntoView({ behavior: 'smooth' }), 300);
                            }
                        } else ElementPlus.ElMessage.warning(res.data.msg);
                    } catch (e) { ElementPlus.ElMessage.error('ç³»ç»Ÿé”™è¯¯'); console.error(e); }
                    finally { loadingInst.close(); }
                };

                const normalizeData = (data) => {
                    if (!data || data.length === 0) return [];
                    const mean = data.reduce((a, b) => a + b, 0) / data.length;
                    const std = Math.sqrt(data.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / data.length);
                    if (std === 0) return data.map(() => 0);
                    return data.map(x => (x - mean) / std);
                };

                const renderCompareChart = () => {
                    const dom = document.getElementById('compare-chart');
                    if (compareChart) compareChart.dispose();
                    compareChart = echarts.init(dom);

                    // è·å–æ•°æ®
                    let userPattern = drawingSeriesData.map(d => Array.isArray(d) ? d[1] : d);
                    let stockPattern = currentCompareRow.value.match_data || [];

                    if (userPattern.length === 0) userPattern = new Array(stockPattern.length).fill(stockPattern[0]);

                    const normUser = normalizeData(userPattern);
                    const normStock = normalizeData(stockPattern);
                    const xData = Array.from({length: Math.max(normUser.length, normStock.length)}, (_, i) => i + 1);

                    const option = {
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['æˆ‘çš„é¢„æœŸ/æ ‡å‡†å½¢æ€ (å½’ä¸€åŒ–)', 'å®é™…èµ°åŠ¿ (å½’ä¸€åŒ–)'], bottom: 0 },
                        grid: { top: 30, left: 40, right: 40, bottom: 40 },
                        xAxis: { type: 'category', data: xData, boundaryGap: false },
                        yAxis: { type: 'value', splitLine: { show: false } },
                        series: [
                            {
                                name: 'æˆ‘çš„é¢„æœŸ/æ ‡å‡†å½¢æ€ (å½’ä¸€åŒ–)', type: 'line', data: normUser,
                                smooth: true, lineStyle: { type: 'dashed', width: 2, color: '#E6A23C' }, showSymbol: false
                            },
                            {
                                name: 'å®é™…èµ°åŠ¿ (å½’ä¸€åŒ–)', type: 'line', data: normStock,
                                smooth: true, lineStyle: { width: 3, color: '#409EFF' },
                                areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(64,158,255,0.3)'}, {offset: 1, color: 'rgba(64,158,255,0.05)'}]) }
                            }
                        ]
                    };
                    compareChart.setOption(option);
                };

                // ... (ä¿ç•™ fetchData, handleTrade, toggleDrawing, clearCanvas, showCompareDialog, goUrl)
                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`/api/kline/?code=${stockCode.value}`);
                        if (res.data.code === 200) renderChart(res.data.data.dates, res.data.data.values, res.data.data.mas, res.data.data.volumes);
                    } catch (e) { } finally { loading.value = false; }
                };
                const handleTrade = (row) => { /* ç•¥ */ };
                const showCompareDialog = (row) => { currentCompareRow.value = row; compareDialogVisible.value = true; };
                const toggleDrawing = () => { isDrawing.value = !isDrawing.value; if(!isDrawing.value) drawingSeriesData=[]; currentPresetName.value = ''; };
                const clearCanvas = () => { drawingSeriesData = []; currentPresetName.value = ''; matchResult.value = []; };
                const goUrl = (url) => window.location.href = url;

                onMounted(() => { initChart(); fetchData(); });

                return {
                    stockCode, loading, isDrawing, matchResult, hasSearched, filters, customColors,
                    strategyDialogVisible, selectedStrategies, strategyLogic,
                    compareDialogVisible, currentCompareRow, currentPresetName,
                    loadPresetPattern, // ğŸ”¥ å¯¼å‡ºæ–°å‡½æ•°
                    fetchData, toggleDrawing, clearCanvas, submitPattern, handleTrade, goUrl, showCompareDialog, renderCompareChart
                };
            }
        });
        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
        app.mount('#app');
    </script>
</body>
</html>