{% extends 'base.html' %}
{% block title %}å¸‚åœºæ‰«æä¸åˆ†æ{% endblock %}

{% block content %}
<el-container style="height: 85vh; border: 1px solid #eee">
    <el-aside width="320px" style="background:#fff; padding:15px; border-right:1px solid #eee">
        <h3>ğŸ› ï¸ æ™ºèƒ½ç­›é€‰</h3>
        <el-form label-position="top">

            <el-form-item label="1. æ¨¡å¼åŒ¹é… (æ ¸å¿ƒ)">
                <el-select v-model="filters.patternId" placeholder="è¯·é€‰æ‹©å½¢æ€æ¨¡å‹" style="width:100%" clearable>
                    <el-option-group label="ğŸ“ˆ ç»å…¸ä¸Šæ¶¨å½¢æ€">
                        <el-option v-for="p in buyPatterns" :key="p.id" :label="'ğŸ”´ '+p.name" :value="'PRESET:'+p.id"></el-option>
                    </el-option-group>
                    <el-option-group label="ğŸ“‰ ç»å…¸ä¸‹è·Œå½¢æ€">
                        <el-option v-for="p in sellPatterns" :key="p.id" :label="'ğŸŸ¢ '+p.name" :value="'PRESET:'+p.id"></el-option>
                    </el-option-group>
                    <el-option-group label="ğŸ‘¤ ç”¨æˆ·è‡ªå®šä¹‰">
                        <el-option v-for="p in patterns.users" :key="p.id" :label="p.name" :value="'USER:'+p.id"></el-option>
                    </el-option-group>
                </el-select>
            </el-form-item>

            <el-form-item label="2. ä»·æ ¼åŒºé—´ (å…ƒ)">
                <el-row :gutter="10">
                    <el-col :span="11"><el-input v-model="filters.minPrice" placeholder="Min"></el-input></el-col>
                    <el-col :span="2" style="text-align:center">-</el-col>
                    <el-col :span="11"><el-input v-model="filters.maxPrice" placeholder="Max"></el-input></el-col>
                </el-row>
            </el-form-item>

            <el-form-item label="3. å¸‚å€¼è§„æ¨¡">
                <el-radio-group v-model="filters.marketCap">
                    <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                    <el-radio-button label="LARGE">å¤§ç›˜</el-radio-button>
                    <el-radio-button label="SMALL">ä¸­å°</el-radio-button>
                </el-radio-group>
            </el-form-item>

            <el-form-item label="4. è¡Œä¸šæ¿å—">
                <el-input v-model="filters.sector" placeholder="ä¾‹å¦‚: é“¶è¡Œ, åŒ»è¯"></el-input>
            </el-form-item>

            <el-button type="primary" size="large" style="width:100%" @click="runScan" :loading="loading">
                ğŸš€ å¼€å§‹å…¨å¸‚åœºæ‰«æ
            </el-button>
        </el-form>

        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px">
            <h4>â­ è§‚å¯Ÿä»“åˆ†ç»„</h4>
            <el-tag v-for="item in favList" :key="item.ts_code" style="margin:2px">[[item.ts_code]]</el-tag>
        </div>
    </el-aside>

    <el-main>
        <div v-if="results.length > 0">
            <div style="margin-bottom:10px; font-size:14px; color:#666">
                å…±æ‰«æåˆ° <b>[[ results.length ]]</b> åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨
            </div>
            <el-table :data="results" stripe border @row-click="showDetail" style="cursor:pointer">
                <el-table-column prop="code" label="ä»£ç " width="90"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="100">
                    <template #default="scope">
                        <b>[[ scope.row.name ]]</b>
                        <el-tag size="small" v-if="scope.row.is_dragon" type="warning" effect="dark">é¾™è™æ¦œ</el-tag>
                    </template>
                </el-table-column>

                <el-table-column label="å½¢æ€åŒ¹é…" width="140">
                    <template #default="scope">
                        <el-tag v-if="scope.row.match_type==='BUY'" type="danger" effect="dark">ğŸ”´ å»ºè®®ä¹°å…¥</el-tag>
                        <el-tag v-else type="success" effect="dark">ğŸŸ¢ å»ºè®®å–å‡º</el-tag>
                    </template>
                </el-table-column>

                <el-table-column label="AI ç½®ä¿¡åº¦" width="220">
                    <template #default="scope">
                        <div style="display:flex; align-items:center">
                            <el-progress :percentage="scope.row.confidence" :stroke-width="10" :show-text="false"
                                :color="scope.row.confidence>80?'#F56C6C':'#E6A23C'" style="width:100px; margin-right:10px"></el-progress>
                            <span style="font-size:12px; font-weight:bold">[[ scope.row.confidence ]]%</span>
                        </div>
                        <div style="font-size:12px; margin-top:2px; color:#666">
                            <span v-for="s in scope.row.signals">[[s]] </span>
                        </div>
                    </template>
                </el-table-column>

                <el-table-column prop="price" label="ç°ä»·" width="100"></el-table-column>

                <el-table-column label="æ“ä½œ">
                    <template #default="scope">
                        <el-button size="small" type="primary" @click.stop="openTrade(scope.row)">äº¤æ˜“</el-button>
                        <el-button size="small" @click.stop="addFav(scope.row)">æ”¶è—</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <el-empty v-else description="è¯·åœ¨å·¦ä¾§è®¾ç½®æ¡ä»¶å¹¶ç‚¹å‡»æ‰«æ"></el-empty>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="80%" title="èµ°åŠ¿è¯¦æƒ… & ä¿¡å·æ ‡æ³¨" @opened="renderDetailChart">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="tradeVisible" title="æ¨¡æ‹Ÿäº¤æ˜“ä¸‹å•" width="30%">
    <el-form>
        <el-form-item label="è‚¡ç¥¨">[[ tradeForm.name ]] ([[ tradeForm.code ]])</el-form-item>
        <el-form-item label="æ–¹å‘">
            <el-radio-group v-model="tradeForm.type">
                <el-radio-button label="BUY">ä¹°å…¥</el-radio-button>
                <el-radio-button label="SELL">å–å‡º</el-radio-button>
            </el-radio-group>
        </el-form-item>
        <el-form-item label="ä»·æ ¼"><el-input v-model="tradeForm.price"></el-input></el-form-item>
        <el-form-item label="æ•°é‡"><el-input v-model="tradeForm.volume"></el-input></el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="submitTrade">æäº¤è®¢å•</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<script>
function pageSetup() {
    const activeMenu = ref('2');
    const loading = ref(false);
    const filters = ref({ patternId: '', minPrice: '', maxPrice: '', marketCap: '', sector: '' });
    const patterns = ref({ presets: [], users: [] });

    // æ‹†åˆ†ä¹°å–å½¢æ€ï¼Œæ–¹ä¾¿æ¨¡æ¿æ¸²æŸ“
    const buyPatterns = computed(() => patterns.value.presets.filter(p => p.type === 'BUY'));
    const sellPatterns = computed(() => patterns.value.presets.filter(p => p.type === 'SELL'));

    const results = ref([]);
    const favList = ref([]);

    // è¯¦æƒ…é¡µ
    const detailVisible = ref(false);
    const currentCode = ref('');
    let detailChart = null;

    // äº¤æ˜“
    const tradeVisible = ref(false);
    const tradeForm = ref({code:'', name:'', type:'BUY', price:0, volume:100});

    const init = async () => {
        try {
            const res = await axios.get('/api/pattern/list/');
            patterns.value = res.data.data;
            const f = await axios.get('/api/favorite/list/');
            favList.value = f.data.data;
        } catch(e) { console.error(e); }
    };

    const runScan = async () => {
        loading.value = true;
        try {
            // è·å–å½¢æ€æ•°æ®
            let pData = null;
            if (filters.value.patternId) {
                const [source, id] = filters.value.patternId.split(':');
                if (source === 'PRESET') {
                    const p = patterns.value.presets.find(x => x.id === id);
                    pData = p ? p.data : null;
                } else {
                    const p = patterns.value.users.find(x => 'USER:'+x.id === filters.value.patternId);
                    pData = p ? p.data : null;
                }
            }

            const res = await axios.post('/api/analysis/run/', {
                pattern_data: pData,
                filters: filters.value
            });
            results.value = res.data.data;
            if (results.value.length === 0) ElementPlus.ElMessage.info('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨');
        } catch(e) {
            console.error(e);
            ElementPlus.ElMessage.error('åˆ†æè¯·æ±‚å¤±è´¥: ' + (e.response ? e.response.status : e.message));
        } finally { loading.value = false; }
    };

    const showDetail = (row) => {
        currentCode.value = row.code;
        detailVisible.value = true;
    };

    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currentCode.value}`);
        const d = res.data.data;

        if (detailChart) detailChart.dispose();
        detailChart = echarts.init(document.getElementById('detail-chart'));

        // æ„é€ ä¹°å–ç‚¹æ ‡æ³¨
        const markPoints = d.signals.map(s => ({
            name: s.msg,
            coord: [s.idx, d.values[s.idx][1]],
            value: s.msg,
            itemStyle: {color: s.type==='BUY'?'#F56C6C':'#00C853'}
        }));

        detailChart.setOption({
            tooltip: {trigger: 'axis', axisPointer: {type: 'cross'}},
            grid: {left: '5%', right: '5%'},
            xAxis: {data: d.dates},
            yAxis: {scale:true},
            dataZoom: [{ type: 'inside' }, { type: 'slider', bottom: 0 }],
            series: [{
                type: 'candlestick',
                data: d.values,
                itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' },
                markPoint: { data: markPoints }
            }, {
                name: 'MA5', type: 'line', data: d.mas.MA5, smooth:true, lineStyle:{opacity:0.5}
            }, {
                name: 'MA20', type: 'line', data: d.mas.MA20, smooth:true, lineStyle:{opacity:0.5}
            }]
        });
    };

    const openTrade = (row) => {
        tradeForm.value = {code:row.code, name:row.name, type:'BUY', price:row.price, volume:100};
        tradeVisible.value = true;
    };

    const submitTrade = async () => {
        await axios.post('/api/trade/order/', tradeForm.value);
        tradeVisible.value=false;
        ElementPlus.ElMessage.success('ä¸‹å•æˆåŠŸ');
    };

    const addFav = async (row) => {
        await axios.post('/api/favorite/add/', {code: row.code, group: 'WATCH'});
        init();
        ElementPlus.ElMessage.success('å·²åŠ å…¥æ”¶è—');
    };

    onMounted(init);

    return { activeMenu, loading, filters, patterns, buyPatterns, sellPatterns, results, favList, runScan, detailVisible, renderDetailChart, showDetail, tradeVisible, tradeForm, openTrade, submitTrade, addFav };
}
</script>
{% endblock %}