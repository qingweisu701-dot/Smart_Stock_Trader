{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container>
    <el-aside width="320px" style="background:#fff; padding:15px; border-right:1px solid #ddd">
        <h3>ğŸ› ï¸ å¤šå› å­ç­›é€‰</h3>
        <el-form label-position="top">

            <el-form-item label="1. æ¨¡å¼åŒ¹é… (æ ¸å¿ƒ)">
                <el-select v-model="filters.patternId" placeholder="è¯·é€‰æ‹©å½¢æ€æ¨¡å‹" style="width:100%" clearable>
                    <el-option-group label="ğŸ“ˆ ç»å…¸ä¸Šæ¶¨å½¢æ€">
                        <el-option v-for="p in patterns.presets" v-if="p.type==='BUY'" :key="p.id" :label="'ğŸ”´ '+p.name" :value="'PRESET:'+p.id"></el-option>
                    </el-option-group>
                    <el-option-group label="ğŸ“‰ ç»å…¸ä¸‹è·Œå½¢æ€">
                        <el-option v-for="p in patterns.presets" v-if="p.type==='SELL'" :key="p.id" :label="'ğŸŸ¢ '+p.name" :value="'PRESET:'+p.id"></el-option>
                    </el-option-group>
                    <el-option-group label="ğŸ‘¤ ç”¨æˆ·è‡ªå®šä¹‰">
                        <el-option v-for="p in patterns.users" :key="p.id" :label="p.name" :value="'USER:'+p.id"></el-option>
                    </el-option-group>
                </el-select>
            </el-form-item>

            <el-form-item label="2. ä»·æ ¼åŒºé—´ (å…ƒ)">
                <el-row :gutter="10">
                    <el-col :span="11"><el-input v-model="filters.minPrice" placeholder="Min"></el-input></el-col>
                    <el-col :span="2" style="text-align:center">-</el-col>
                    <el-col :span="11"><el-input v-model="filters.maxPrice" placeholder="Max"></el-input></el-col>
                </el-row>
            </el-form-item>

            <el-form-item label="3. å¸‚å€¼è§„æ¨¡">
                <el-radio-group v-model="filters.marketCap">
                    <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                    <el-radio-button label="LARGE">å¤§ç›˜</el-radio-button>
                    <el-radio-button label="SMALL">ä¸­å°</el-radio-button>
                </el-radio-group>
            </el-form-item>

            <el-form-item label="4. è¡Œä¸šæ¿å—">
                <el-input v-model="filters.sector" placeholder="ä¾‹å¦‚: é“¶è¡Œ, åŒ»è¯"></el-input>
            </el-form-item>

            <el-divider></el-divider>
            <el-button type="primary" size="large" style="width:100%" @click="runAnalysis" :loading="loading">
                ğŸ” å¼€å§‹æ‰«æ
            </el-button>
        </el-form>
    </el-aside>

    <el-main>
        <div v-if="results.length > 0">
            <div style="margin-bottom:10px; font-size:14px; color:#666">
                å…±æ‰«æåˆ° <b>[[ results.length ]]</b> åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨
            </div>
            <el-table :data="results" stripe border @row-click="showDetail">
                <el-table-column prop="code" label="ä»£ç " width="100"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="120">
                    <template #default="scope">
                        <b>[[ scope.row.name ]]</b>
                        <el-tag size="small" v-if="scope.row.is_dragon" type="warning" effect="dark">é¾™è™æ¦œ</el-tag>
                    </template>
                </el-table-column>

                <el-table-column label="ä¿¡å·è¯„ä¼°" width="150">
                    <template #default="scope">
                        <el-tag v-if="scope.row.match_type==='BUY'" type="danger" effect="dark">ğŸ”´ å»ºè®®ä¹°å…¥</el-tag>
                        <el-tag v-else type="success" effect="dark">ğŸŸ¢ å»ºè®®å–å‡º</el-tag>
                        <div style="margin-top:5px; font-size:12px; color:#999">[[ scope.row.pattern_name ]]</div>
                    </template>
                </el-table-column>

                <el-table-column label="AI ç½®ä¿¡åº¦" width="250">
                    <template #default="scope">
                        <el-progress :percentage="scope.row.confidence" :stroke-width="15" text-inside />
                        <div style="font-size:12px; margin-top:5px">
                            <span v-if="scope.row.confidence > 80" style="color:red">ğŸ”¥ ä¿¡å·æå¼º</span>
                            <span v-else-if="scope.row.confidence > 60" style="color:#E6A23C">âš¡ ä¿¡å·ä¸€èˆ¬</span>
                            <span v-else style="color:#909399">ğŸ’¨ éœ€è§‚æœ›</span>
                        </div>
                    </template>
                </el-table-column>

                <el-table-column prop="price" label="ç°ä»·" width="100"></el-table-column>

                <el-table-column label="æ“ä½œ">
                    <template #default="scope">
                        <el-button size="small" @click.stop="openTrade(scope.row)">äº¤æ˜“</el-button>
                        <el-button size="small" type="warning" plain @click.stop="toggleFav(scope.row)">æ”¶è—</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>
        <el-empty v-else description="è¯·åœ¨å·¦ä¾§è®¾ç½®æ¡ä»¶å¹¶ç‚¹å‡»æ‰«æ"></el-empty>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="80%" title="èµ°åŠ¿è¯¦æƒ…">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" title="ä¸‹å•" width="30%">
    <el-form>
        <el-form-item label="è‚¡ç¥¨">[[ trade.name ]] ([[ trade.code ]])</el-form-item>
        <el-form-item label="æ–¹å‘">
            <el-radio-group v-model="trade.type">
                <el-radio-button label="BUY">ä¹°å…¥</el-radio-button>
                <el-radio-button label="SELL">å–å‡º</el-radio-button>
            </el-radio-group>
        </el-form-item>
        <el-form-item label="æ•°é‡">
            <el-input-number v-model="trade.volume" :step="100"></el-input-number>
        </el-form-item>
        <el-form-item label="ä»·æ ¼">
            <el-input-number v-model="trade.price" :precision="2" :step="0.01"></el-input-number>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="submitOrder">æäº¤</el-button></template>
</el-dialog>

<script>
function pageSetup() {
    const activeMenu = ref('2');
    const loading = ref(false);
    const filters = ref({ patternId: '', minPrice: '', maxPrice: '', marketCap: '', sector: '' });
    const patterns = ref({ presets: [], users: [] });
    const results = ref([]);

    // äº¤æ˜“ä¸è¯¦æƒ…
    const trade = ref({ visible: false, code: '', name: '', price: 0, volume: 100, type: 'BUY' });
    const detailVisible = ref(false);
    let detailChart = null;

    onMounted(async () => {
        const res = await axios.get('/api/pattern/list/');
        patterns.value = res.data.data;
    });

    const runAnalysis = async () => {
        loading.value = true;
        try {
            // è·å–å½¢æ€æ•°æ®
            let pData = null;
            let pType = 'BUY';
            if (filters.value.patternId) {
                const [source, id] = filters.value.patternId.split(':');
                if (source === 'PRESET') {
                    const p = patterns.value.presets.find(x => x.id === id);
                    pData = p.data;
                    pType = p.type;
                } else {
                    const p = patterns.value.users.find(x => 'USER:'+x.id === filters.value.patternId);
                    pData = p.data; // æ³¨æ„ï¼šå¦‚æœæ˜¯KLINEç±»å‹ï¼Œè¿™é‡Œæ˜¯å¯¹è±¡æ•°ç»„ï¼Œåç«¯éœ€è¦å¤„ç†
                    // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œå‡è®¾æ‰€æœ‰è‡ªå®šä¹‰å½¢æ€æš‚å®šä¸ºBUYï¼Œå®é™…åº”è¯¥å­˜åº“
                }
            }

            const res = await axios.post('/api/analysis/run/', {
                pattern_data: pData,
                pattern_type: pType, // å‘Šè¯‰åç«¯æ˜¯ä¹°è¿˜æ˜¯å–
                filters: filters.value
            });
            results.value = res.data.data;
            if (results.value.length === 0) ElementPlus.ElMessage.info('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨');
        } catch(e) { console.error(e); ElementPlus.ElMessage.error('åˆ†æå‡ºé”™'); }
        finally { loading.value = false; }
    };

    const showDetail = async (row) => {
        detailVisible.value = true;
        // è¯·æ±‚è¯¦æƒ…æ•°æ®
        const res = await axios.get(`/api/stock/detail/?code=${row.code}`);
        const d = res.data.data;

        setTimeout(() => {
            if (detailChart) detailChart.dispose();
            detailChart = echarts.init(document.getElementById('detail-chart'));

            // ç»˜åˆ¶ K çº¿ + å‡çº¿
            // è¿™é‡Œä¸ºäº†ç¾è§‚ï¼Œä½¿ç”¨äº†ç±»ä¼¼ä¸œæ–¹è´¢å¯Œçš„é…è‰²
            detailChart.setOption({
                tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                xAxis: { data: d.dates },
                yAxis: { scale: true },
                dataZoom: [{ type: 'inside' }, { type: 'slider', bottom: 0 }],
                series: [
                    {
                        type: 'candlestick',
                        data: d.values, // [open, close, low, high]
                        itemStyle: { color: '#ef232a', color0: '#14b143', borderColor: '#ef232a', borderColor0: '#14b143' }
                    },
                    { name: 'MA5', type: 'line', data: d.mas.MA5, smooth: true, lineStyle: { opacity: 0.5 } },
                    { name: 'MA20', type: 'line', data: d.mas.MA20, smooth: true, lineStyle: { opacity: 0.5 } }
                ]
            });
        }, 100);
    };

    const openTrade = (row) => {
        trade.value = { visible: true, code: row.code, name: row.name, price: row.price, volume: 100, type: 'BUY' };
    };

    const submitOrder = async () => {
        await axios.post('/api/trade/order/', trade.value);
        trade.value.visible = false;
        ElementPlus.ElMessage.success('å§”æ‰˜æäº¤æˆåŠŸ');
    };

    const toggleFav = async (row) => {
        await axios.post('/api/favorite/add/', { code: row.code });
        ElementPlus.ElMessage.success('å·²åŠ å…¥æ”¶è—');
    };

    return { activeMenu, loading, filters, patterns, results, runAnalysis, showDetail, trade, openTrade, submitOrder, toggleFav, detailVisible };
}
</script>
{% endblock %}