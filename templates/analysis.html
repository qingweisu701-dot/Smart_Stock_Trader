{% extends 'base.html' %}
{% block title %}å¸‚åœºæ‰«æä¸åˆ†æ{% endblock %}

{% block content %}
<el-row :gutter="20">
    <el-col :span="6">
        <el-card>
            <template #header><b>ğŸ” ç­–ç•¥ç­›é€‰å™¨</b></template>
            <el-form label-position="top">
                <el-form-item label="1. å½¢æ€åŒ¹é… (å¯é€‰)">
                    <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€(å¦‚äº”æµª/Wåº•)" clearable style="width:100%">
                        <el-option-group label="ç³»ç»Ÿé¢„è®¾">
                            <el-option v-for="p in patterns.presets" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"></el-option>
                        </el-option-group>
                        <el-option-group label="æˆ‘çš„æ‰‹ç»˜">
                            <el-option v-for="p in patterns.users" :key="p.id" :label="p.name" :value="'USER:'+p.id"></el-option>
                        </el-option-group>
                    </el-select>
                </el-form-item>

                <el-form-item label="2. åŸºç¡€ç­›é€‰">
                    <el-input v-model="filters.sector" placeholder="è¡Œä¸š (å¦‚: é“¶è¡Œ)" style="margin-bottom:10px"></el-input>
                    <el-select v-model="filters.marketCap" placeholder="å¸‚å€¼è§„æ¨¡" style="width:100%">
                        <el-option label="å…¨éƒ¨" value=""></el-option>
                        <el-option label="å¤§ç›˜è‚¡ (>500äº¿)" value="LARGE"></el-option>
                        <el-option label="ä¸­å°ç›˜ (<500äº¿)" value="MID"></el-option>
                        <el-option label="å°ç›˜è‚¡ (<100äº¿)" value="SMALL"></el-option>
                    </el-select>
                </el-form-item>

                <el-form-item label="3. åŒ¹é…é˜ˆå€¼ ([[ filters.minScore ]])">
                    <el-slider v-model="filters.minScore" :min="0" :max="90"></el-slider>
                </el-form-item>

                <el-button type="primary" style="width:100%" @click="runAnalysis" :loading="loading">ğŸš€ å¼€å§‹å…¨å¸‚åœºæ‰«æ</el-button>
            </el-form>
        </el-card>
    </el-col>

    <el-col :span="18">
        <el-card>
            <el-table :data="results" stripe border style="width: 100%">
                <el-table-column prop="code" label="ä»£ç " width="100"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="120"></el-table-column>
                <el-table-column label="Kçº¿ä¿¡å·/å½¢æ€" width="180">
                    <template #default="scope">
                        <el-tag v-for="s in scope.row.signals" :key="s" size="small" type="warning" style="margin-right:5px">[[s]]</el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="AI ç½®ä¿¡åº¦è¯„ä¼°" width="200">
                    <template #default="scope">
                        <div style="font-size:12px; color:#666">ç»¼åˆè¯„åˆ†: [[scope.row.score]]</div>
                        <el-progress :percentage="scope.row.win_rate" :format="p => 'èƒœç‡ ' + p + '%'" :status="scope.row.win_rate>80?'success':''"></el-progress>
                    </template>
                </el-table-column>
                <el-table-column prop="price" label="ç°ä»·" width="100"></el-table-column>
                <el-table-column label="æ“ä½œ">
                    <template #default="scope">
                        <el-button size="small" type="primary" @click="openTrade(scope.row)">äº¤æ˜“</el-button>
                        <el-button size="small" @click="toggleFav(scope.row)">[[ isFav(scope.row.code) ? 'å·²æ”¶è—' : 'æ”¶è—' ]]</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="trade.visible" title="æ¨¡æ‹Ÿäº¤æ˜“ä¸‹å•" width="30%">
    <el-form label-width="80px">
        <el-form-item label="æ ‡çš„"><b>[[ trade.name ]] ([[ trade.code ]])</b></el-form-item>
        <el-form-item label="æ–¹å‘">
            <el-radio-group v-model="trade.type">
                <el-radio-button label="BUY"><span style="color:red">ä¹°å…¥</span></el-radio-button>
                <el-radio-button label="SELL"><span style="color:green">å–å‡º</span></el-radio-button>
            </el-radio-group>
        </el-form-item>
        <el-form-item label="ä»·æ ¼">
            <el-input-number v-model="trade.price" :precision="2" :step="0.01"></el-input-number>
        </el-form-item>
        <el-form-item label="æ•°é‡(è‚¡)">
            <el-input-number v-model="trade.volume" :step="100" :min="100"></el-input-number>
        </el-form-item>
    </el-form>
    <template #footer>
        <el-button @click="trade.visible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="submitOrder">ç¡®è®¤æäº¤</el-button>
    </template>
</el-dialog>

<script>
function pageSetup() {
    const activeMenu = ref('2'); // å¯¹åº”èœå•é«˜äº®
    const loading = ref(false);
    const filters = ref({ patternId: '', sector: '', marketCap: '', minScore: 60 });
    const patterns = ref({ presets: [], users: [] });
    const results = ref([]);
    const favorites = ref([]);

    const trade = ref({ visible: false, code: '', name: '', type: 'BUY', price: 0, volume: 100 });

    // åˆå§‹åŒ–
    const init = async () => {
        // è·å–å½¢æ€åˆ—è¡¨
        const res1 = await axios.get('/api/pattern/list/');
        patterns.value = res1.data.data;
        // è·å–æ”¶è—
        const res2 = await axios.get('/api/favorite/list/');
        favorites.value = res2.data.data;
    };

    const runAnalysis = async () => {
        loading.value = true;
        try {
            // æ‰¾åˆ°é€‰ä¸­çš„ pattern æ•°æ®
            let pData = null;
            if (filters.value.patternId) {
                const [type, id] = filters.value.patternId.split(':');
                if (type === 'PRESET') {
                    pData = patterns.value.presets.find(p => p.id === id).data;
                } else {
                    pData = patterns.value.users.find(p => 'custom_'+p.id === id).data; // ä¿®æ­£IDåŒ¹é…é€»è¾‘
                    // ç®€åŒ–å¤„ç†ï¼šåç«¯å…¶å®åªè¦ pattern_data æ•°ç»„
                }
            }

            const res = await axios.post('/api/analysis/run/', {
                pattern_data: pData,
                filters: filters.value
            });
            results.value = res.data.data;
            if(results.value.length === 0) ElementPlus.ElMessage.warning('æœªæ‰¾åˆ°ç»“æœ');
        } finally { loading.value = false; }
    };

    const isFav = (code) => favorites.value.includes(code);
    const toggleFav = async (row) => {
        const action = isFav(row.code) ? 'remove' : 'add';
        await axios.post('/api/favorite/toggle/', { code: row.code, action });
        // åˆ·æ–°åˆ—è¡¨
        const res = await axios.get('/api/favorite/list/');
        favorites.value = res.data.data;
    };

    const openTrade = (row) => {
        trade.value = { visible: true, code: row.code, name: row.name, type: 'BUY', price: row.price, volume: 100 };
    };

    const submitOrder = async () => {
        const res = await axios.post('/api/trade/order/', trade.value);
        if (res.data.code === 200) {
            ElementPlus.ElMessage.success('äº¤æ˜“æˆåŠŸ');
            trade.value.visible = false;
        } else {
            ElementPlus.ElMessage.error(res.data.msg);
        }
    };

    onMounted(init);

    return { activeMenu, loading, filters, patterns, results, trade, runAnalysis, isFav, toggleFav, openTrade, submitOrder };
}
</script>
{% endblock %}