{% extends 'base.html' %}
{% block title %}å¸‚åœºæ™ºèƒ½æ‰«æ{% endblock %}
{% block content %}
<el-container style="height: 85vh; border: 1px solid #eee">
    <el-aside width="320px" style="background:#fff; padding:15px; border-right:1px solid #ddd; overflow-y:auto">
        <h3>ğŸ” æ™ºèƒ½ç­›é€‰</h3>
        <el-form label-position="top">
            <el-form-item label="1. é€‰å½¢æ€">
                <el-select v-model="filters.patternId" placeholder="é€‰æ‹©å½¢æ€" style="width:100%" clearable>
                    <el-option-group label="ğŸ“ˆ ç»å…¸ä¸Šæ¶¨"><el-option v-for="p in presets.buy" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"></el-option></el-option-group>
                    <el-option-group label="ğŸ“‰ ç»å…¸ä¸‹è·Œ"><el-option v-for="p in presets.sell" :key="p.id" :label="p.name" :value="'PRESET:'+p.id"></el-option></el-option-group>
                    <el-option-group label="ğŸ‘¤ æˆ‘çš„"><el-option v-for="p in presets.user" :key="p.id" :label="p.name" :value="'USER:'+p.id"></el-option></el-option-group>
                </el-select>
            </el-form-item>

            <el-form-item label="2. é€‰æŒ‡æ ‡ (æ”¯æŒå¤šé€‰)">
                <el-checkbox-group v-model="filters.strategies">
                    <el-checkbox label="MA_GOLD">å‡çº¿é‡‘å‰</el-checkbox>
                    <el-checkbox label="MACD_GOLD">MACDé‡‘å‰</el-checkbox>
                </el-checkbox-group>
            </el-form-item>

            <el-form-item label="3. ä»·æ ¼åŒºé—´ (OHLC)">
                <el-row :gutter="5"><el-col :span="12"><el-input v-model="filters.minClose" placeholder="Min æ”¶ç›˜"></el-input></el-col><el-col :span="12"><el-input v-model="filters.maxClose" placeholder="Max æ”¶ç›˜"></el-input></el-col></el-row>
            </el-form-item>

            <el-form-item label="4. å¸‚å€¼ (äº¿)">
                <el-radio-group v-model="filters.marketCap" size="small">
                    <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                    <el-radio-button label="LARGE">å¤§(>500)</el-radio-button>
                    <el-radio-button label="SMALL">å°(<100)</el-radio-button>
                </el-radio-group>
            </el-form-item>

            <el-button type="primary" style="width:100%" @click="runScan" :loading="loading">ğŸš€ å¼€å§‹æ‰«æ</el-button>
        </el-form>

        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px">
            <h4>â­ æˆ‘çš„è§‚å¯Ÿä»“ (ç‚¹å‡»æŸ¥çœ‹)</h4>
            <div v-for="item in favList" :key="item.code" class="fav-item" @click="showDetail({code: item.code})">
                [[item.name]] <span style="color:#999">[[item.code]]</span>
            </div>
        </div>
    </el-aside>

    <el-main>
        <el-table :data="results" stripe border @row-click="showDetail" style="cursor:pointer">
            <el-table-column prop="code" label="ä»£ç " width="90"></el-table-column>
            <el-table-column prop="name" label="åç§°" width="100"></el-table-column>
            <el-table-column label="ä¿¡å·ç±»å‹" width="120">
                <template #default="scope">
                    <el-tag :type="scope.row.match_type==='BUY'?'danger':'success'" effect="dark">[[ scope.row.match_type ]]</el-tag>
                </template>
            </el-table-column>
            <el-table-column label="AI ç½®ä¿¡åº¦" width="220">
                <template #default="scope">
                    <el-progress :percentage="scope.row.confidence" :stroke-width="12" :color="scope.row.confidence>80?'#F56C6C':'#E6A23C'"></el-progress>
                </template>
            </el-table-column>
            <el-table-column prop="price" label="ç°ä»·" width="100"></el-table-column>
            <el-table-column label="æ“ä½œ">
                <template #default="scope">
                    <el-button size="small" type="primary" @click.stop="openTrade(scope.row)">äº¤æ˜“</el-button>
                    <el-button size="small" @click.stop="toggleFav(scope.row)">æ”¶è—</el-button>
                </template>
            </el-table-column>
        </el-table>
    </el-main>
</el-container>

<el-dialog v-model="detailVisible" width="80%" title="èµ°åŠ¿è¯¦æƒ…" @opened="renderDetailChart">
    <div id="detail-chart" style="height:500px"></div>
</el-dialog>

<el-dialog v-model="trade.visible" title="ä¸‹å•" width="30%">
    <el-form>
        <el-form-item label="æ–¹å‘"><el-radio-group v-model="trade.type"><el-radio-button label="BUY">ä¹°</el-radio-button><el-radio-button label="SELL">å–</el-radio-button></el-radio-group></el-form-item>
        <el-form-item label="æ•°é‡"><el-input-number v-model="trade.volume" :step="100"></el-input-number></el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="submitTrade">æäº¤</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .fav-item { padding: 8px; border-bottom: 1px dashed #eee; cursor: pointer; transition: 0.2s; }
    .fav-item:hover { background: #ecf5ff; }
</style>
<script>
function pageSetup() {
    const activeMenu = ref('2');
    const loading = ref(false);
    const filters = ref({ patternId: '', strategies: [], minClose:'', maxClose:'', marketCap: '', sector: '' });
    const presets = ref({ buy: [], sell: [], user: [] });
    const results = ref([]);
    const favList = ref([]);

    const detailVisible = ref(false);
    const currentCode = ref('');
    let detailChart = null;
    const trade = ref({ visible: false, code: '', price: 0, volume: 100, type: 'BUY' });

    const init = async () => {
        const res = await axios.get('/api/pattern/list/');
        const all = res.data.data.presets;
        presets.value.buy = all.filter(p => p.type === 'BUY');
        presets.value.sell = all.filter(p => p.type === 'SELL');
        presets.value.user = res.data.data.users;
        loadFavs();
    };

    const loadFavs = async () => {
        const f = await axios.get('/api/favorite/list/');
        favList.value = f.data.data;
    }

    const runScan = async () => {
        loading.value = true;
        try {
            let pData = null;
            if (filters.value.patternId) {
                const [source, id] = filters.value.patternId.split(':');
                if (source === 'PRESET') {
                    pData = [...presets.value.buy, ...presets.value.sell].find(x => x.id === id).data;
                } else {
                    pData = presets.value.user.find(x => x.id == id).data;
                }
            }
            const res = await axios.post('/api/analysis/run/', { pattern_data: pData, filters: filters.value });
            results.value = res.data.data;
            if(results.value.length === 0) ElementPlus.ElMessage.info('æ— åŒ¹é…ç»“æœ');
        } finally { loading.value = false; }
    };

    const showDetail = (row) => {
        currentCode.value = row.code;
        detailVisible.value = true;
    };

    const renderDetailChart = async () => {
        const res = await axios.get(`/api/stock/detail/?code=${currentCode.value}`);
        const d = res.data.data;
        if(detailChart) detailChart.dispose();
        detailChart = echarts.init(document.getElementById('detail-chart'));

        // æ ‡æ³¨ç‚¹
        const markPoints = d.signals.map(s => ({
            name: s.msg, coord: [s.idx, d.values[s.idx][1]], value: s.msg,
            itemStyle: {color: s.type==='BUY'?'#F56C6C':'#00C853'}
        }));

        detailChart.setOption({
            tooltip: {trigger:'axis', axisPointer:{type:'cross'}}, xAxis: {data:d.dates}, yAxis: {scale:true},
            dataZoom: [{type:'inside'}, {type:'slider', bottom:0}],
            series: [
                { type:'candlestick', data:d.values, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}, markPoint:{data:markPoints} },
                { name:'MA5', type:'line', data:d.mas.MA5, smooth:true, lineStyle:{opacity:0.5} }
            ]
        });
    };

    const openTrade = (row) => { trade.value = { visible:true, code:row.code, price:row.price, volume:100, type:'BUY' }; };
    const submitTrade = async () => { await axios.post('/api/trade/order/', trade.value); trade.value.visible=false; ElementPlus.ElMessage.success('ä¸‹å•æˆåŠŸ'); };
    const toggleFav = async (row) => { await axios.post('/api/favorite/add/', {code:row.code}); loadFavs(); ElementPlus.ElMessage.success('æ”¶è—æˆåŠŸ'); };

    onMounted(init);
    return { activeMenu, loading, filters, presets, results, favList, runScan, showDetail, detailVisible, renderDetailChart, trade, openTrade, submitTrade, toggleFav };
}
</script>
{% endblock %}