{% extends 'base.html' %}
{% block title %}è´¦æˆ·æ”¶ç›Šåˆ†æ{% endblock %}

{% block content %}
<el-row :gutter="20">
    <el-col :span="24">
        <el-card>
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span>ğŸ’° è´¦æˆ·æ”¶ç›Šä¸å›æµ‹åˆ†æ</span>
                    <el-button type="primary" size="small" @click="initCharts">åˆ·æ–°æ•°æ®</el-button>
                </div>
            </template>

            <el-row :gutter="20" style="margin-bottom: 20px;">
                <el-col :span="6">
                    <div style="text-align:center; padding:10px; background:#f0f9eb; border-radius:4px">
                        <div style="color:#67C23A; font-size:24px; font-weight:bold">+12.5%</div>
                        <div style="color:#666">ç´¯è®¡æ”¶ç›Šç‡</div>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div style="text-align:center; padding:10px; background:#fdf6ec; border-radius:4px">
                        <div style="color:#E6A23C; font-size:24px; font-weight:bold">68.2%</div>
                        <div style="color:#666">ç­–ç•¥èƒœç‡</div>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div style="text-align:center; padding:10px; background:#fef0f0; border-radius:4px">
                        <div style="color:#F56C6C; font-size:24px; font-weight:bold">-5.2%</div>
                        <div style="color:#666">æœ€å¤§å›æ’¤</div>
                    </div>
                </el-col>
                <el-col :span="6">
                    <div style="text-align:center; padding:10px; background:#ecf5ff; border-radius:4px">
                        <div style="color:#409EFF; font-size:24px; font-weight:bold">12</div>
                        <div style="color:#666">æ€»äº¤æ˜“æ¬¡æ•°</div>
                    </div>
                </el-col>
            </el-row>

            <div id="pnl-chart" style="height: 400px;"></div>
        </el-card>
    </el-col>
</el-row>

<el-row :gutter="20" style="margin-top:20px">
    <el-col :span="24">
        <el-card>
            <template #header>
                <span>ğŸ“Š ä¸ªè‚¡æ”¶ç›Šæ˜ç»†</span>
            </template>
            <el-table :data="stockPnL" stripe border style="width: 100%" height="400">
                <el-table-column prop="code" label="ä»£ç " width="120"></el-table-column>
                <el-table-column prop="name" label="åç§°" width="150"></el-table-column>
                <el-table-column prop="count" label="äº¤æ˜“æ¬¡æ•°" width="120" sortable></el-table-column>
                <el-table-column prop="win_rate" label="èƒœç‡" width="120" sortable>
                    <template #default="scope">[[scope.row.win_rate]]%</template>
                </el-table-column>
                <el-table-column prop="total_pnl" label="ç´¯è®¡ç›ˆäº" sortable>
                    <template #default="scope">
                        <span :style="{color: scope.row.total_pnl >= 0 ? '#F56C6C' : '#67C23A', fontWeight: 'bold'}">
                            [[scope.row.total_pnl]]
                        </span>
                    </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="120">
                    <template #default="scope">
                        <el-button size="small" type="primary" plain @click="openDetail(scope.row)">äº¤æ˜“æ˜ç»†</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="detailVisible" title="äº¤æ˜“è®°å½•æ˜ç»†" width="60%">
    <el-table :data="detailList" border height="400">
        <el-table-column prop="trade_date" label="æ—¥æœŸ" width="120"></el-table-column>
        <el-table-column prop="trade_type" label="æ–¹å‘" width="80">
            <template #default="s">
                <el-tag :type="s.row.trade_type==='BUY'?'danger':'success'">[[s.row.trade_type]]</el-tag>
            </template>
        </el-table-column>
        <el-table-column prop="price" label="ä»·æ ¼"></el-table-column>
        <el-table-column prop="volume" label="æ•°é‡"></el-table-column>
        <el-table-column prop="pnl" label="å•ç¬”ç›ˆäº">
            <template #default="s">
                <span :class="s.row.pnl>0?'red':'green'" v-if="s.row.pnl!=null">[[s.row.pnl]]</span>
                <span v-else>--</span>
            </template>
        </el-table-column>
    </el-table>
</el-dialog>
{% endblock %}

{% block scripts %}
<script>
    function pageSetup() {
        const { onMounted, ref } = Vue;
        const stockPnL = ref([]);
        const detailVisible = ref(false);
        const detailList = ref([]);

        const initCharts = async () => {
            // Init chart (simulation)
            const chart = echarts.init(document.getElementById('pnl-chart'));
            const dates = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            chart.setOption({
                title: { text: 'èµ„é‡‘æƒç›Šæ›²çº¿' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['ç­–ç•¥æ”¶ç›Š', 'åŸºå‡†æ”¶ç›Š'] },
                xAxis: { data: dates },
                yAxis: { type: 'value' },
                series: [{ name: 'ç­–ç•¥æ”¶ç›Š', type: 'line', smooth: true, data: [0, 5, 3, 8, 15, 12], itemStyle: { color: '#F56C6C' }, areaStyle: { opacity: 0.1 } }, { name: 'åŸºå‡†æ”¶ç›Š', type: 'line', smooth: true, data: [0, 2, 1, 4, 3, 5], itemStyle: { color: '#909399' } }]
            });

            // Fetch Breakdown
            try {
                const res = await axios.get('/api/analysis/profit/breakdown/');
                if (res.data.code === 200) {
                    stockPnL.value = res.data.data;
                }
            } catch (e) { console.error(e); }
        };

        const openDetail = async (row) => {
            detailVisible.value = true;
            const res = await axios.get(`/api/analysis/profit/detail/?code=${row.code}`);
            detailList.value = res.data.data;
        };

        onMounted(initCharts);
        return { initCharts, stockPnL, openDetail, detailVisible, detailList };
    }
</script>
{% endblock %}