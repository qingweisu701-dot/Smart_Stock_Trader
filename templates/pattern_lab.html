{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}

{% block content %}
<el-row :gutter="20" style="height:calc(100vh - 100px)">
    <el-col :span="16">
        <el-card style="height:100%; display:flex; flex-direction:column">
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <el-radio-group v-model="mode" size="small" @change="onModeChange">
                        <el-radio-button label="mouse">ğŸ–Œï¸ æ‰‹ç»˜è¶‹åŠ¿</el-radio-button>
                        <el-radio-button label="kline">ğŸ§± Kçº¿ç²¾è°ƒ</el-radio-button>
                    </el-radio-group>
                    <div style="display:flex; gap:10px">
                        <el-button v-if="mode==='mouse'" size="small" type="danger" plain @click="clearDraw">æ¸…ç©ºç”»å¸ƒ</el-button>
                        <el-button type="primary" size="small" @click="prepareSave">
                            <el-icon><check /></el-icon> ä¿å­˜å½¢æ€
                        </el-button>
                    </div>
                </div>
            </template>

            <div v-show="mode==='mouse'" style="flex:1; display:flex; flex-direction:column">
                <div class="tip-box">
                    ğŸ’¡ <b>è¶‹åŠ¿ç»˜åˆ¶ï¼š</b> æŒ‰ä½é¼ æ ‡å·¦é”®ç»˜åˆ¶ã€‚æ¾å¼€ä¸æ¸…é™¤ï¼Œæ”¯æŒåˆ†æ®µç»˜åˆ¶ã€‚
                </div>
                <div id="draw-canvas" style="flex:1; border:1px dashed #ccc; min-height:400px; cursor:crosshair"></div>
            </div>

            <div v-show="mode==='kline'" style="height:100%; display:flex; flex-direction:column; overflow-y:auto">
                <div class="tip-box">
                    ğŸ’¡ <b>Kçº¿å¾®è°ƒï¼š</b> ç‚¹å‡»å›¾è¡¨ä¸­çš„ K çº¿æŸ±ä½“ï¼Œåœ¨ä¸‹æ–¹æ»‘å—è°ƒæ•´ã€å¼€/é«˜/ä½/æ”¶ã€‘ã€‚æ»šè½®å¯ç¼©æ”¾ã€‚
                </div>
                <div id="kline-editor" style="height:350px; width:100%"></div>

                <div v-if="selectedIdx !== null" class="editor-bar">
                    <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px">
                        <span style="color:#409EFF">
                            <el-icon><edit /></el-icon> æ­£åœ¨ç¼–è¾‘ç¬¬ [[selectedIdx+1]] æ ¹
                        </span>
                        <el-tag size="small" :type="curr.close>=curr.open?'danger':'success'" style="margin-left:10px">
                            [[ curr.close>=curr.open ? 'é˜³çº¿' : 'é˜´çº¿' ]]
                        </el-tag>
                    </div>
                    <el-row :gutter="20">
                        <el-col :span="6"><span class="label">æœ€é«˜ä»·</span><el-slider v-model="curr.high" :max="100" @input="updateChart"/></el-col>
                        <el-col :span="6"><span class="label">æœ€ä½ä»·</span><el-slider v-model="curr.low" :max="100" @input="updateChart"/></el-col>
                        <el-col :span="6"><span class="label">å¼€ç›˜ä»·</span><el-slider v-model="curr.open" :max="100" @input="updateChart"/></el-col>
                        <el-col :span="6"><span class="label">æ”¶ç›˜ä»·</span><el-slider v-model="curr.close" :max="100" @input="updateChart"/></el-col>
                    </el-row>
                </div>
                <div v-else style="text-align:center; color:#999; padding:20px; border:1px dashed #eee; margin-top:10px; border-radius:4px">
                    ğŸ‘ˆ è¯·ç‚¹å‡»ä¸Šæ–¹å›¾è¡¨ä¸­çš„ä»»æ„ä¸€æ ¹ K çº¿è¿›è¡Œè°ƒæ•´
                </div>

                <div style="text-align:center; margin-top:10px">
                    <el-button-group>
                        <el-button size="small" type="success" @click="addCandle"><el-icon><plus /></el-icon> è¿½åŠ ä¸€æ ¹</el-button>
                        <el-button size="small" type="danger" @click="removeCandle" :disabled="selectedIdx===null"><el-icon><minus /></el-icon> åˆ é™¤é€‰ä¸­</el-button>
                    </el-button-group>
                </div>
            </div>
        </el-card>
    </el-col>

    <el-col :span="8">
        <el-card header="ğŸ“š å½¢æ€æ¨¡æ¿åº“" style="height:100%; overflow-y:auto">
            <el-collapse v-model="activeCollapse">
                <el-collapse-item title="ğŸ“ˆ çœ‹æ¶¨å½¢æ€ (Bullish)" name="1">
                    <div v-for="p in buyPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="danger">ä¹°</el-tag> <b>[[p.name]]</b></span>
                        <el-icon class="fav-icon" :class="{active: p.is_fav}" @click.stop="toggleFav(p, 'PRESET')">
                            <star-filled />
                        </el-icon>
                    </div>
                </el-collapse-item>

                <el-collapse-item title="ğŸ“‰ çœ‹è·Œå½¢æ€ (Bearish)" name="2">
                    <div v-for="p in sellPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="success">å–</el-tag> <b>[[p.name]]</b></span>
                        <el-icon class="fav-icon" :class="{active: p.is_fav}" @click.stop="toggleFav(p, 'PRESET')">
                            <star-filled />
                        </el-icon>
                    </div>
                </el-collapse-item>

                <el-collapse-item title="ğŸ‘¤ æˆ‘çš„æ¨¡æ¿" name="3">
                    <div v-if="userPatterns.length===0" style="color:#999; text-align:center; padding:10px">æš‚æ— æ¨¡æ¿</div>
                    <div v-for="p in userPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="info">è‡ª</el-tag> [[p.name]]</span>
                        <div>
                            <el-icon class="fav-icon" :class="{active: p.is_fav}" @click.stop="toggleFav(p, 'USER')">
                                <star-filled />
                            </el-icon>
                            <el-icon class="del-btn" @click.stop="delPattern(p.id)">
                                <delete />
                            </el-icon>
                        </div>
                    </div>
                </el-collapse-item>

                <el-collapse-item title="â­ æ”¶è—æ¨¡æ¿" name="4">
                    <div v-if="favPatterns.length===0" style="color:#999; text-align:center; padding:10px">æš‚æ— æ”¶è—</div>
                    <div v-for="p in favPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="warning">â­</el-tag> [[p.name]]</span>
                    </div>
                </el-collapse-item>
            </el-collapse>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="ä¿å­˜è‡ªå®šä¹‰å½¢æ€" width="30%">
    <div v-if="aiTrend" :class="aiTrend==='BUY'?'ai-box-buy':'ai-box-sell'" style="margin-bottom:15px">
        <el-icon style="vertical-align:middle; margin-right:5px"><cpu /></el-icon>
        AIè¯†åˆ«è¶‹åŠ¿ï¼š<b>[[aiTrend==='BUY'?'çœ‹æ¶¨':'çœ‹è·Œ']]</b>
    </div>
    <el-form label-position="top">
        <el-form-item label="å½¢æ€åç§°">
            <el-input v-model="saveDialog.name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ä½ä½èºæ—‹æ¡¨"></el-input>
        </el-form-item>

        <el-form-item label="ä¿¡å·ç±»å‹ (è‡ªåŠ¨å½’ç±»)">
            <el-radio-group v-model="saveDialog.desc">
                <el-radio label="BUY" border>ğŸ“ˆ çœ‹æ¶¨å½¢æ€</el-radio>
                <el-radio label="SELL" border>ğŸ“‰ çœ‹è·Œå½¢æ€</el-radio>
            </el-radio-group>
        </el-form-item>

        <el-form-item>
            <el-checkbox v-model="saveDialog.isFav" label="åŒæ—¶åŠ å…¥â€œæ”¶è—æ¨¡æ¿â€" border></el-checkbox>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="doSave">ç¡®è®¤ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .tip-box { background:#e6f7ff; color:#1890ff; padding:8px 12px; font-size:12px; border-radius:4px; margin-bottom:10px; border:1px solid #91d5ff; }
    .editor-bar { background:#fff; padding:15px; border:1px solid #dcdfe6; border-radius:6px; margin-top:5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .p-item { padding:10px; border-bottom:1px solid #f0f0f0; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
    .p-item:hover{background:#f9f9f9}
    .label { font-size:12px; color:#909399; }
    .fav-icon { color: #ddd; font-size: 16px; margin-left: 8px; transition: color 0.3s; }
    .fav-icon:hover { color: #f7ba2a; }
    .fav-icon.active { color: #E6A23C; }
    .del-btn { color: #F56C6C; margin-left: 8px; font-size: 16px; }
    .ai-box-buy{color:#67c23a; background:#f0f9eb; padding:10px; border-radius:4px}
    .ai-box-sell{color:#f56c6c; background:#fef0f0; padding:10px; border-radius:4px}
</style>
<script>
function pageSetup() {
    // æ˜¾å¼è§£æ„ APIï¼Œé˜²æ­¢æœªå®šä¹‰
    const { ref, onMounted, computed } = Vue;

    const mode = ref('mouse');
    const activeCollapse = ref([]); // é»˜è®¤é—­åˆ
    const list = ref({presets:[], users:[]});

    // è®¡ç®—å±æ€§ (ä¿®å¤ v-if å’Œ v-for å†²çª)
    const buyPatterns = computed(() => list.value.presets.filter(p => p.type === 'BUY'));
    const sellPatterns = computed(() => list.value.presets.filter(p => p.type === 'SELL'));
    const userPatterns = computed(() => list.value.users);
    const favPatterns = computed(() => [...list.value.presets, ...list.value.users].filter(p => p.is_fav));

    const saveDialog = ref({visible:false, name:'', desc:'BUY', isFav: false});
    const aiTrend = ref('');

    const klineData = ref([{open:30,close:50,low:20,high:60}, {open:55,close:40,low:30,high:65}]);
    const selectedIdx = ref(null);
    const curr = ref({open:0,close:0,low:0,high:0});

    let drawPoints=[], isDrawing=false;
    let chart1=null, chart2=null;

    const init = () => {
        chart1 = echarts.init(document.getElementById('draw-canvas'));
        chart2 = echarts.init(document.getElementById('kline-editor'));

        // é¼ æ ‡ç»˜å›¾
        chart1.getZr().on('mousedown', ()=>{isDrawing=true;});
        chart1.getZr().on('mousemove', e=>{
            if(!isDrawing) return;
            const pt = chart1.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]);
            if(pt) { drawPoints.push(pt[1]); renderDraw(); }
        });
        chart1.getZr().on('mouseup', ()=>{isDrawing=false});

        // Kçº¿ç‚¹å‡»
        chart2.on('click', 'series.candlestick', p=>{
            selectedIdx.value = p.dataIndex;
            curr.value = {...klineData.value[p.dataIndex]};
        });

        renderDraw(); renderKline(); loadList();
    };

    const renderDraw = () => {
        chart1.setOption({
            grid:{top:10,bottom:10,left:10,right:10},
            xAxis:{show:false, data:drawPoints.map((_,i)=>i)}, yAxis:{min:0,max:100,show:false},
            series:[{type:'line', data:drawPoints, showSymbol:false, smooth:0.3, lineStyle:{width:3, color:'#409EFF'}, areaStyle:{opacity:0.1}}]
        });
        chart1.resize();
    };

    const renderKline = () => {
        const d = klineData.value.map(k=>[k.open, k.close, k.low, k.high]);
        chart2.setOption({
            tooltip:{trigger:'axis'}, grid:{top:20,bottom:30,left:30,right:10},
            xAxis:{data:klineData.value.map((_,i)=>i+1)},
            yAxis:{scale:true, min:0, max:100},
            // ğŸ”¥ è‡ªé€‚åº”å…³é”®ï¼šå¼ºåˆ¶é“ºæ»¡
            dataZoom:[{type:'inside', start:0, end:100}],
            series:[{
                type:'candlestick', data:d,
                itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'},
                select:{itemStyle:{borderColor:'#E6A23C', borderWidth:3}}, selectedMode:'single'
            }]
        });
        if(selectedIdx.value!==null) chart2.dispatchAction({type:'select', seriesIndex:0, dataIndex:selectedIdx.value});
        chart2.resize();
    };

    const updateChart = () => {
        if(selectedIdx.value!==null) { klineData.value[selectedIdx.value] = {...curr.value}; renderKline(); }
    };
    const clearDraw = () => { drawPoints=[]; renderDraw(); };
    const addCandle = () => { klineData.value.push({open:50,close:50,high:60,low:40}); renderKline(); };
    const removeCandle = () => {
        if(selectedIdx.value!==null) { klineData.value.splice(selectedIdx.value, 1); selectedIdx.value=null; renderKline(); }
    };

    const loadList = async () => {
        try {
            const res = await axios.get('/api/pattern/list/');
            list.value = res.data.data;
        } catch(e) { console.error(e); }
    };

    const loadP = (p) => {
        if (p.source_type === 'KLINE') {
            mode.value = 'kline';
            klineData.value = p.data;
            setTimeout(renderKline, 100);
            ElementPlus.ElMessage.success(`å·²åŠ è½½Kçº¿: ${p.name}`);
        } else {
            mode.value = 'mouse';
            drawPoints = p.data;
            setTimeout(renderDraw, 100);
            ElementPlus.ElMessage.success(`å·²åŠ è½½è¶‹åŠ¿: ${p.name}`);
        }
    };

    const toggleFav = async (p, type) => {
        await axios.post('/api/pattern/fav/toggle/', {id: p.id, source_type: type});
        loadList();
        ElementPlus.ElMessage.success('æ“ä½œæˆåŠŸ');
    };

    const prepareSave = async () => {
        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = type==='DRAW'?drawPoints:klineData.value;
        try {
            const res = await axios.post('/api/pattern/analyze/', {type, data});
            aiTrend.value = res.data.data.trend;
            saveDialog.value.desc = aiTrend.value==='SELL'?'SELL':'BUY';
            saveDialog.value.visible = true;
        } catch(e) {}
    };

    const doSave = async () => {
        if(!saveDialog.value.name) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥åç§°');

        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = mode.value==='mouse'?drawPoints:klineData.value;

        await axios.post('/api/pattern/save/', {
            name: saveDialog.value.name, desc: saveDialog.value.desc,
            type: type, data: data
        });

        // å¦‚æœå‹¾é€‰æ”¶è—
        if (saveDialog.value.isFav) {
             ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ˜Ÿå·æ”¶è—');
        } else {
            ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸ');
        }

        saveDialog.value.visible = false;
        loadList();
    };

    const delPattern = async (id) => { await axios.post('/api/pattern/delete/', {id}); loadList(); };
    const onModeChange = () => { setTimeout(() => { if(mode.value==='mouse') chart1.resize(); else chart2.resize(); }, 100); }

    onMounted(()=>setTimeout(init, 200));
    return { mode, activeCollapse, list, buyPatterns, sellPatterns, userPatterns, favPatterns, klineData, selectedIdx, curr, saveDialog, aiTrend, updateChart, clearDraw, addCandle, removeCandle, loadP, prepareSave, doSave, delPattern, toggleFav, onModeChange };
}
</script>
{% endblock %}