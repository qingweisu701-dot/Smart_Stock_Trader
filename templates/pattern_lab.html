{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}

{% block content %}
<el-row :gutter="20" style="height:calc(100vh - 100px)">
    <el-col :span="16">
        <el-card style="height:100%; display:flex; flex-direction:column">
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <el-radio-group v-model="mode" size="small" @change="onModeChange">
                        <el-radio-button label="mouse">ğŸ–Œï¸ æ‰‹ç»˜è¶‹åŠ¿</el-radio-button>
                        <el-radio-button label="kline">ğŸ§± Kçº¿ç²¾è°ƒ</el-radio-button>
                        <el-radio-button label="import">ğŸ“Š æ•°æ®å¯¼å…¥</el-radio-button>
                    </el-radio-group>
                    <div style="display:flex; gap:10px">
                        <el-button v-if="mode==='mouse'" size="small" type="danger" plain @click="clearDraw">æ¸…ç©º</el-button>
                        <el-button type="primary" size="small" @click="prepareSave">
                            <el-icon><check /></el-icon> ä¿å­˜å½¢æ€
                        </el-button>
                    </div>
                </div>
            </template>

            <div v-show="mode==='mouse'" style="flex:1; display:flex; flex-direction:column">
                <div class="tip-box">ğŸ’¡ æŒ‰ä½å·¦é”®ç»˜åˆ¶ã€‚æ¾å¼€ä¸æ¸…é™¤ï¼Œæ”¯æŒåˆ†æ®µç»˜åˆ¶ã€‚</div>
                <div id="draw-canvas" style="flex:1; border:1px dashed #ccc; min-height:400px; cursor:crosshair"></div>
            </div>

            <div v-show="mode==='kline' || mode==='import'" style="height:100%; display:flex; flex-direction:column; overflow-y:auto">

                <div v-if="mode==='import'" style="padding:15px; background:#f0f9eb; border-bottom:1px solid #e1f3d8">
                    <el-input
                        type="textarea" :rows="3"
                        placeholder="è¯·ç²˜è´´æ•°æ® (æ ¼å¼: å¼€ç›˜,æ”¶ç›˜,æœ€ä½,æœ€é«˜ - æ”¯æŒExcelå¤åˆ¶)"
                        v-model="importText">
                    </el-input>
                    <div style="text-align:right; margin-top:5px">
                        <el-button size="small" @click="loadDemoData">å¡«å…¥ç¤ºä¾‹</el-button>
                        <el-button size="small" type="primary" @click="parseImportData">è§£æç”Ÿæˆ</el-button>
                    </div>
                </div>

                <div v-else class="tip-box">ğŸ’¡ ç‚¹å‡»ä¸‹æ–¹ K çº¿æŸ±ä½“ï¼Œä½¿ç”¨æ»‘å—è°ƒæ•´ OHLC æ•°å€¼ã€‚</div>

                <div id="kline-editor" style="height:350px; width:100%"></div>

                <div v-if="selectedIdx !== null" style="background:#f9f9f9; padding:15px; margin-top:10px; border-radius:4px; border:1px solid #eee">
                    <div style="font-weight:bold; margin-bottom:10px; color:#409EFF">
                        è°ƒæ•´ç¬¬ [[selectedIdx+1]] æ ¹ Kçº¿
                        <el-tag size="small" :type="curr.close>=curr.open?'danger':'success'" style="margin-left:5px">
                            [[ curr.close>=curr.open ? 'é˜³çº¿' : 'é˜´çº¿' ]]
                        </el-tag>
                    </div>
                    <el-row :gutter="20">
                        <el-col :span="6"><span class="label">æœ€é«˜ä»· High</span><el-slider v-model="curr.high" :max="100" @input="updateChart"/></el-col>
                        <el-col :span="6"><span class="label">æœ€ä½ä»· Low</span><el-slider v-model="curr.low" :max="100" @input="updateChart"/></el-col>
                        <el-col :span="6"><span class="label">å¼€ç›˜ä»· Open</span><el-slider v-model="curr.open" :max="100" @input="updateChart"/></el-col>
                        <el-col :span="6"><span class="label">æ”¶ç›˜ä»· Close</span><el-slider v-model="curr.close" :max="100" @input="updateChart"/></el-col>
                    </el-row>
                </div>

                <div style="text-align:center; margin-top:10px">
                    <el-button-group>
                        <el-button size="small" type="success" @click="addCandle"><el-icon><plus /></el-icon> åŠ ä¸€æ ¹</el-button>
                        <el-button size="small" type="danger" @click="removeCandle" :disabled="selectedIdx===null"><el-icon><minus /></el-icon> åˆ é€‰ä¸­</el-button>
                    </el-button-group>
                </div>
            </div>
        </el-card>
    </el-col>

    <el-col :span="8">
        <el-card header="ğŸ“š å½¢æ€æ¨¡æ¿åº“" style="height:100%; overflow-y:auto">
            <el-collapse v-model="activeCollapse">
                <el-collapse-item title="ğŸ“ˆ çœ‹æ¶¨å½¢æ€ (Bullish)" name="1">
                    <div v-for="p in buyPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="danger">ä¹°</el-tag> <b>[[p.name]]</b></span>
                        <el-icon class="fav-icon" :class="{active: p.is_fav}" @click.stop="toggleFav(p, 'PRESET')"><star-filled /></el-icon>
                    </div>
                </el-collapse-item>
                <el-collapse-item title="ğŸ“‰ çœ‹è·Œå½¢æ€ (Bearish)" name="2">
                    <div v-for="p in sellPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="success">å–</el-tag> <b>[[p.name]]</b></span>
                        <el-icon class="fav-icon" :class="{active: p.is_fav}" @click.stop="toggleFav(p, 'PRESET')"><star-filled /></el-icon>
                    </div>
                </el-collapse-item>
                <el-collapse-item title="ğŸ‘¤ æˆ‘çš„æ¨¡æ¿" name="3">
                    <div v-for="p in userPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="info">è‡ª</el-tag> [[p.name]]</span>
                        <div>
                            <el-icon class="fav-icon" :class="{active: p.is_fav}" @click.stop="toggleFav(p, 'USER')"><star-filled /></el-icon>
                            <el-icon class="del-btn" @click.stop="delPattern(p.id)"><delete /></el-icon>
                        </div>
                    </div>
                </el-collapse-item>
                <el-collapse-item title="â­ æ”¶è—æ¨¡æ¿" name="4">
                    <div v-for="p in favPatterns" :key="p.id" class="p-item" @click="loadP(p)">
                        <span><el-tag size="small" type="warning">â­</el-tag> [[p.name]]</span>
                    </div>
                </el-collapse-item>
            </el-collapse>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="æ™ºèƒ½ä¿å­˜" width="40%">
    <div v-if="aiTrend" :class="aiTrend==='BUY'?'ai-box-buy':'ai-box-sell'" style="margin-bottom:15px">
        <el-icon style="vertical-align:middle; margin-right:5px"><cpu /></el-icon>
        AIè¯†åˆ«è¶‹åŠ¿ï¼š<b>[[aiTrend==='BUY'?'çœ‹æ¶¨':'çœ‹è·Œ']]</b>
    </div>

    <div class="verify-box">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <span style="font-weight:bold; color:#606266">ğŸ“Š å†å²å›æµ‹éªŒè¯</span>
            <el-button size="small" type="warning" plain @click="runVerify" :loading="verifying">
                [[ verifyResult ? 'é‡æ–°éªŒè¯' : 'è¿è¡Œå†å²å›æµ‹' ]]
            </el-button>
        </div>
        <div v-if="verifyResult" style="margin-top:10px; display:flex; justify-content:space-around; font-size:13px">
            <div style="text-align:center"><div style="color:#999">å†å²å‡ºç°</div><b>[[verifyResult.count]]æ¬¡</b></div>
            <div style="text-align:center"><div style="color:#999">èƒœç‡</div><b style="color:#F56C6C">[[verifyResult.win_rate]]%</b></div>
            <div style="text-align:center"><div style="color:#999">å¹³å‡æ”¶ç›Š</div><b style="color:#F56C6C">[[verifyResult.avg_return]]%</b></div>
        </div>
    </div>

    <el-form label-position="top" style="margin-top:15px">
        <el-form-item label="åç§°"><el-input v-model="saveDialog.name" placeholder="èµ·ä¸ªåå­—"/></el-form-item>
        <el-form-item label="ç±»å‹">
            <el-radio-group v-model="saveDialog.desc">
                <el-radio label="BUY" border>çœ‹æ¶¨</el-radio><el-radio label="SELL" border>çœ‹è·Œ</el-radio>
            </el-radio-group>
        </el-form-item>
        <el-form-item>
            <el-checkbox v-model="saveDialog.isFav" label="åŒæ—¶åŠ å…¥æ”¶è—" border></el-checkbox>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="doSave" style="width:100%">ç¡®è®¤ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .tip-box { background:#e6f7ff; color:#1890ff; padding:8px 12px; font-size:12px; border-radius:4px; margin-bottom:10px; border:1px solid #91d5ff; }
    .p-item { padding:10px; border-bottom:1px solid #f0f0f0; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
    .p-item:hover{background:#f9f9f9}
    .label { font-size:12px; color:#909399; }
    .fav-icon { color: #ddd; font-size: 16px; margin-left: 8px; transition: color 0.3s; }
    .fav-icon:hover { color: #f7ba2a; } .fav-icon.active { color: #E6A23C; }
    .del-btn { color: #F56C6C; margin-left: 8px; font-size: 16px; }
    .ai-box-buy{color:#67c23a; background:#f0f9eb; padding:10px; border-radius:4px}
    .ai-box-sell{color:#f56c6c; background:#fef0f0; padding:10px; border-radius:4px}
    .verify-box { background: #fff7e6; border: 1px solid #ffe4bb; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
</style>
<script>
function pageSetup() {
    const { ref, onMounted, computed } = Vue;
    const mode = ref('mouse');
    const activeCollapse = ref([]);
    const list = ref({presets:[], users:[]});
    const buyPatterns = computed(() => list.value.presets.filter(p => p.type === 'BUY'));
    const sellPatterns = computed(() => list.value.presets.filter(p => p.type === 'SELL'));
    const userPatterns = computed(() => list.value.users);
    const favPatterns = computed(() => [...list.value.presets, ...list.value.users].filter(p => p.is_fav));

    const saveDialog = ref({visible:false, name:'', desc:'BUY', isFav: false});
    const aiTrend = ref('');
    const importText = ref('');
    const verifying = ref(false);
    const verifyResult = ref(null);

    const klineData = ref([{open:30,close:50,low:20,high:60}, {open:55,close:40,low:30,high:65}]);
    const selectedIdx = ref(null);
    const curr = ref({open:0,close:0,low:0,high:0});
    let drawPoints=[], isDrawing=false;
    let chart1=null, chart2=null;

    const init = () => {
        chart1 = echarts.init(document.getElementById('draw-canvas'));
        chart2 = echarts.init(document.getElementById('kline-editor'));
        chart1.getZr().on('mousedown', ()=>{isDrawing=true;});
        chart1.getZr().on('mousemove', e=>{ if(!isDrawing) return; const pt = chart1.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]); if(pt) { drawPoints.push(pt[1]); renderDraw(); } });
        chart1.getZr().on('mouseup', ()=>{isDrawing=false});
        chart2.on('click', 'series.candlestick', p=>{ selectedIdx.value = p.dataIndex; curr.value = {...klineData.value[p.dataIndex]}; });
        renderDraw(); renderKline(); loadList();
    };

    const renderDraw = () => { chart1.setOption({ xAxis:{show:false, data:drawPoints.map((_,i)=>i)}, yAxis:{min:0,max:100,show:false}, series:[{type:'line', data:drawPoints, showSymbol:false, smooth:0.3, lineStyle:{width:3, color:'#409EFF'}, areaStyle:{opacity:0.1}}] }); chart1.resize(); };

    const renderKline = () => {
        const d = klineData.value.map(k=>[k.open, k.close, k.low, k.high]);
        chart2.setOption({
            tooltip:{trigger:'axis'}, grid:{top:20,bottom:30,left:30,right:10},
            xAxis:{data:klineData.value.map((_,i)=>i+1)}, yAxis:{scale:true, min:0, max:100},
            dataZoom:[{type:'inside', start:0, end:100}],
            series:[{ type:'candlestick', data:d, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}, select:{itemStyle:{borderColor:'#E6A23C', borderWidth:3}}, selectedMode:'single' }]
        });
        if(selectedIdx.value!==null) chart2.dispatchAction({type:'select', seriesIndex:0, dataIndex:selectedIdx.value});
        chart2.resize();
    };

    const updateChart = () => { if(selectedIdx.value!==null) { klineData.value[selectedIdx.value] = {...curr.value}; renderKline(); } };
    const clearDraw = () => { drawPoints=[]; renderDraw(); };
    const addCandle = () => { klineData.value.push({open:50,close:50,high:60,low:40}); renderKline(); };
    const removeCandle = () => { if(selectedIdx.value!==null) { klineData.value.splice(selectedIdx.value, 1); selectedIdx.value=null; renderKline(); } };

    const loadList = async () => { try { const res = await axios.get('/api/pattern/list/'); list.value = res.data.data; } catch(e){} };

    const loadP = (p) => {
        if (p.source_type === 'KLINE') { mode.value = 'kline'; klineData.value = p.data; setTimeout(renderKline, 100); ElementPlus.ElMessage.success(`åŠ è½½Kçº¿: ${p.name}`); }
        else { mode.value = 'mouse'; drawPoints = p.data; setTimeout(renderDraw, 100); ElementPlus.ElMessage.success(`åŠ è½½è¶‹åŠ¿: ${p.name}`); }
    };

    const toggleFav = async (p, type) => { await axios.post('/api/pattern/fav/toggle/', {id: p.id, source_type: type}); loadList(); ElementPlus.ElMessage.success('æ“ä½œæˆåŠŸ'); };

    const prepareSave = async () => {
        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = type==='DRAW'?drawPoints:klineData.value;
        if(type==='DRAW' && data.length<5) return ElementPlus.ElMessage.warning('ç»˜åˆ¶å¤ªçŸ­äº†');

        try {
            const res = await axios.post('/api/pattern/analyze/', {type, data});
            aiTrend.value = res.data.data.trend;
            saveDialog.value.desc = aiTrend.value==='SELL'?'SELL':'BUY';
            saveDialog.value.visible = true;
            verifyResult.value = null; // é‡ç½®éªŒè¯
        } catch(e) {}
    };

    // ğŸ”¥ æ‰¾å›ï¼šè¿è¡Œå†å²éªŒè¯
    const runVerify = async () => {
        verifying.value = true;
        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = type==='DRAW'?drawPoints:klineData.value;
        try {
            const res = await axios.post('/api/pattern/verify/', { type, data });
            verifyResult.value = res.data.data;
            ElementPlus.ElMessage.success('éªŒè¯å®Œæˆ');
        } finally { verifying.value = false; }
    };

    const doSave = async () => {
        if(!saveDialog.value.name) return ElementPlus.ElMessage.warning('è¯·è¾“å…¥åç§°');
        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = mode.value==='mouse'?drawPoints:klineData.value;
        await axios.post('/api/pattern/save/', { name: saveDialog.value.name, desc: saveDialog.value.desc, type: type, data: data });
        if (saveDialog.value.isFav) ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ˜Ÿå·æ”¶è—');
        else ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸ');
        saveDialog.value.visible = false; loadList();
    };

    const delPattern = async (id) => { await axios.post('/api/pattern/delete/', {id}); loadList(); };
    const onModeChange = () => { setTimeout(() => { if(mode.value==='mouse') chart1.resize(); else chart2.resize(); }, 100); }

    // ğŸ”¥ æ‰¾å›ï¼šæ•°æ®å¯¼å…¥é€»è¾‘
    const loadDemoData = () => { importText.value = `20, 25, 18, 28\n26, 24, 22, 30\n23, 28, 20, 29`; };
    const parseImportData = () => {
        if (!importText.value.trim()) return;
        const lines = importText.value.trim().split('\n');
        const parsed = [];
        for (let line of lines) {
            const parts = line.replace(/[\t\s]+/g, ',').split(',').filter(x=>x);
            if (parts.length >= 4) parsed.push({open:parseFloat(parts[0]), close:parseFloat(parts[1]), low:parseFloat(parts[2]), high:parseFloat(parts[3])});
        }
        if (parsed.length > 0) { klineData.value = parsed; mode.value = 'kline'; setTimeout(renderKline, 100); ElementPlus.ElMessage.success('å¯¼å…¥æˆåŠŸ'); }
    };

    onMounted(()=>setTimeout(init, 200));
    return { mode, activeCollapse, buyPatterns, sellPatterns, userPatterns, favPatterns, klineData, selectedIdx, curr, saveDialog, aiTrend, updateChart, clearDraw, addCandle, removeCandle, loadP, prepareSave, doSave, delPattern, toggleFav, onModeChange, importText, loadDemoData, parseImportData, runVerify, verifying, verifyResult };
}
</script>
{% endblock %}