{% extends 'base.html' %}
{% block title %}å›¾å½¢ç®¡ç†å®éªŒå®¤{% endblock %}
{% block content %}
<el-row :gutter="20" style="height:calc(100vh - 100px)">
    <el-col :span="16">
        <el-card style="height:100%; display:flex; flex-direction:column">
            <template #header>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <el-radio-group v-model="mode" size="small">
                        <el-radio-button label="mouse">ğŸ–Œï¸ æ‰‹ç»˜è¶‹åŠ¿</el-radio-button>
                        <el-radio-button label="kline">ğŸ§± Kçº¿ç²¾è°ƒ</el-radio-button>
                    </el-radio-group>
                    <el-button type="primary" size="small" icon="Check" @click="prepareSave">ä¿å­˜åˆ°åº“</el-button>
                </div>
            </template>

            <div id="draw-canvas" v-show="mode==='mouse'" style="flex:1; border:1px dashed #ccc; min-height:400px; cursor:crosshair"></div>
            <div id="kline-editor" v-show="mode==='kline'" style="flex:1; min-height:400px"></div>

            <div v-if="mode==='kline' && selectedIdx!==null" style="padding:10px; background:#f9f9f9; border-top:1px solid #eee">
                <div style="font-weight:bold; margin-bottom:5px; color:#409EFF">è°ƒæ•´ç¬¬ [[selectedIdx+1]] æ ¹:</div>
                <el-row :gutter="10">
                   <el-col :span="6">é«˜ <el-slider v-model="curr.high" :max="100" size="small" @input="updateChart"/></el-col>
                   <el-col :span="6">ä½ <el-slider v-model="curr.low" :max="100" size="small" @input="updateChart"/></el-col>
                   <el-col :span="6">å¼€ <el-slider v-model="curr.open" :max="100" size="small" @input="updateChart"/></el-col>
                   <el-col :span="6">æ”¶ <el-slider v-model="curr.close" :max="100" size="small" @input="updateChart"/></el-col>
                </el-row>
            </div>

            <div style="text-align:center; margin-top:10px">
                <el-button size="small" @click="clear" icon="Delete">æ¸…ç©º</el-button>
                <el-button size="small" type="success" v-if="mode==='kline'" @click="addCandle" icon="Plus">åŠ ä¸€æ ¹</el-button>
                <el-button size="small" type="danger" v-if="mode==='kline'" @click="removeCandle" icon="Minus" :disabled="selectedIdx===null">åˆ é€‰ä¸­</el-button>
            </div>
        </el-card>
    </el-col>

    <el-col :span="8">
        <el-card header="ğŸ“š æ¨¡æ¿æ¸…å•" style="height:100%; overflow-y:auto">
            <el-tabs>
                <el-tab-pane label="ç³»ç»Ÿé¢„è®¾">
                    <div v-for="p in list.presets" :key="p.id" class="p-item" @click="load(p)">
                        <el-tag size="small" :type="p.type==='BUY'?'danger':'success'">[[p.type]]</el-tag>
                        <b>[[p.name]]</b>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="æˆ‘çš„æ”¶è—">
                    <div v-if="list.users.length===0" style="color:#999; text-align:center; padding:20px">æš‚æ— </div>
                    <div v-for="p in list.users" :key="p.id" class="p-item" @click="load(p)">
                        <el-tag size="small" type="info">è‡ª</el-tag> [[p.name]]
                        <el-button type="text" size="small" icon="Delete" style="float:right; color:#F56C6C" @click.stop="delPattern(p.id)"></el-button>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </el-card>
    </el-col>
</el-row>

<el-dialog v-model="saveDialog.visible" title="ä¿å­˜å½¢æ€" width="30%">
    <div v-if="aiTrend" :class="aiTrend==='BUY'?'ai-box-buy':'ai-box-sell'">
        AIåˆ†æï¼š<b>[[aiTrend==='BUY'?'çœ‹æ¶¨':'çœ‹è·Œ']]</b>
    </div>
    <el-form label-position="top" style="margin-top:10px">
        <el-form-item label="åç§°"><el-input v-model="saveDialog.name"/></el-form-item>
        <el-form-item label="ç±»å‹">
            <el-radio-group v-model="saveDialog.desc">
                <el-radio label="BUY">ä¹°å…¥ä¿¡å·</el-radio><el-radio label="SELL">å–å‡ºä¿¡å·</el-radio>
            </el-radio-group>
        </el-form-item>
    </el-form>
    <template #footer><el-button type="primary" @click="doSave">ä¿å­˜</el-button></template>
</el-dialog>
{% endblock %}

{% block scripts %}
<style>
    .p-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer } .p-item:hover{background:#f5f7fa}
    .ai-box-buy{color:#67c23a; background:#f0f9eb; padding:8px; border-radius:4px}
    .ai-box-sell{color:#f56c6c; background:#fef0f0; padding:8px; border-radius:4px}
</style>
<script>
function pageSetup() {
    const mode = ref('mouse');
    const list = ref({presets:[], users:[]});
    const saveDialog = ref({visible:false, name:'', desc:'BUY'});
    const aiTrend = ref('');

    // æ•°æ®
    const klineData = ref([{open:30,close:50,low:20,high:60},{open:55,close:40,low:30,high:65}]);
    const selectedIdx = ref(null);
    const curr = ref({open:0,close:0,low:0,high:0});
    let drawPoints=[], isDrawing=false;
    let chart1=null, chart2=null;

    const init = () => {
        chart1 = echarts.init(document.getElementById('draw-canvas'));
        chart2 = echarts.init(document.getElementById('kline-editor'));

        // æ‰‹ç»˜
        chart1.getZr().on('mousedown', ()=>{isDrawing=true; drawPoints=[]});
        chart1.getZr().on('mousemove', e=>{
            if(!isDrawing) return;
            const pt = chart1.convertFromPixel({seriesIndex:0}, [e.offsetX, e.offsetY]);
            if(pt) { drawPoints.push(pt[1]); renderDraw(); }
        });
        chart1.getZr().on('mouseup', ()=>{isDrawing=false});

        // Kçº¿ç‚¹å‡»
        chart2.on('click', 'series.candlestick', p=>{
            selectedIdx.value = p.dataIndex;
            curr.value = {...klineData.value[p.dataIndex]};
        });

        renderDraw(); renderKline(); loadList();
    };

    const renderDraw = () => {
        chart1.setOption({
            grid:{top:10,bottom:10,left:10,right:10}, xAxis:{show:false, data:drawPoints.map((_,i)=>i)}, yAxis:{min:0,max:100,show:false},
            series:[{type:'line', data:drawPoints, showSymbol:false, smooth:0.3, lineStyle:{width:3, color:'#409EFF'}}]
        });
        chart1.resize();
    };

    const renderKline = () => {
        const d = klineData.value.map(k=>[k.open, k.close, k.low, k.high]);
        chart2.setOption({
            tooltip:{trigger:'axis'}, grid:{top:20,bottom:20,left:30,right:10},
            xAxis:{data:klineData.value.map((_,i)=>i+1)}, yAxis:{scale:true, min:0, max:100},
            dataZoom:[{type:'inside'}],
            series:[{type:'candlestick', data:d, itemStyle:{color:'#ef232a', color0:'#14b143', borderColor:'#ef232a', borderColor0:'#14b143'}}]
        });
        chart2.resize();
    };

    const updateChart = () => {
        if(selectedIdx.value!==null) { klineData.value[selectedIdx.value] = {...curr.value}; renderKline(); }
    };
    const addCandle = () => { klineData.value.push({open:50,close:50,high:60,low:40}); renderKline(); };
    const removeCandle = () => { klineData.value.splice(selectedIdx.value, 1); selectedIdx.value=null; renderKline(); };
    const clear = () => { drawPoints=[]; klineData.value=[{open:50,close:50,high:60,low:40}]; renderDraw(); renderKline(); };

    const loadList = async () => {
        const res = await axios.get('/api/pattern/list/');
        list.value = res.data.data;
    };

    const load = (p) => {
        if(mode.value === 'mouse') {
            if(Array.isArray(p.data) && typeof p.data[0] === 'number') { drawPoints=p.data; renderDraw(); }
            else ElementPlus.ElMessage.warning('è¿™æ˜¯Kçº¿æ•°æ®ï¼Œè¯·åˆ‡åˆ°Kçº¿æ¨¡å¼');
        } else {
            if(Array.isArray(p.data) && typeof p.data[0] === 'object') { klineData.value=p.data; renderKline(); }
            else ElementPlus.ElMessage.warning('è¿™æ˜¯æ‰‹ç»˜æ•°æ®ï¼Œè¯·åˆ‡åˆ°æ‰‹ç»˜æ¨¡å¼');
        }
    };

    const prepareSave = async () => {
        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = type==='DRAW'?drawPoints:klineData.value;
        const res = await axios.post('/api/pattern/analyze/', {type, data});
        aiTrend.value = res.data.data.trend;
        saveDialog.value.desc = aiTrend.value==='SELL'?'SELL':'BUY';
        saveDialog.value.visible = true;
    };

    const doSave = async () => {
        const type = mode.value==='mouse'?'DRAW':'KLINE';
        const data = type==='DRAW'?drawPoints:klineData.value;
        await axios.post('/api/pattern/save/', {name:saveDialog.value.name, desc:saveDialog.value.desc, type, data});
        saveDialog.value.visible = false; loadList();
    };

    const delPattern = async (id) => {
        await axios.post('/api/pattern/delete/', {id});
        loadList();
    };

    onMounted(()=>setTimeout(init, 200));
    return { mode, list, klineData, curr, selectedIdx, saveDialog, aiTrend, updateChart, clear, addCandle, removeCandle, load, prepareSave, doSave, delPattern };
}
</script>
{% endblock %}